<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bus Counter å·´å£«å®¢é‡çµ±è¨ˆ </title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS (XLSX) for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- React & ReactDOM -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* iOS Safari prevent bounce */
        body {
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="bg-slate-100 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Plus, Minus, RotateCcw, FileText, ChevronRight, Search, 
            Loader2, AlertCircle, Clock, Edit3, List, Users, Settings, 
            Copy, Check, BusFront, User, Hash, Info, MapPin, AlertTriangle, X, Pencil, Calculator, Timer,
            BarChart3, Trash2, TrendingUp, Calendar, CheckCircle2, StickyNote, Eye, EyeOff, GitMerge, FileSpreadsheet, Lightbulb
        } from 'lucide-react';

        function App() {
            // --- æ ¸å¿ƒç‹€æ…‹ (Core State) ---
            const [company, setCompany] = useState('KMB'); // 'KMB', 'CTB', or 'NLB'
            const [routeNumber, setRouteNumber] = useState('');
            const [currentStopIndex, setCurrentStopIndex] = useState(0); 
            
            // è¡Œç¨‹è³‡æ–™ (Trip Info)
            const [tripInfo, setTripInfo] = useState({
                plate: '', captainId: '', captainName: ''
            });
            
            // æ´»èºçš„è·¯ç·šè®Šé«” (Active Variant for Stats)
            const [activeVariant, setActiveVariant] = useState(null);
            // é˜²æ­¢é‡è¤‡è¨˜éŒ„åŒä¸€æ¬¡è¡Œç¨‹
            const [tripRecorded, setTripRecorded] = useState(false);
            
            // äººæ•¸çµ±è¨ˆ (Counters)
            const [initialPassengers, setInitialPassengers] = useState(0);
            const [totalPassengers, setTotalPassengers] = useState(0);
            const [stopOn, setStopOn] = useState(0);
            const [stopOff, setStopOff] = useState(0);
            const [arrivalTime, setArrivalTime] = useState('');
            
            // å‚™è¨»èˆ‡åˆ†æé¸é … (Notes & Analysis)
            const [currentNote, setCurrentNote] = useState('');
            const [showNoteInput, setShowNoteInput] = useState(false);
            const [includeNotesInReport, setIncludeNotesInReport] = useState(true);
            const [includeAnalysis, setIncludeAnalysis] = useState(true);

            // æ­·å²è¨˜éŒ„ (History)
            const [history, setHistory] = useState([]);
            
            // ä»‹é¢é–‹é—œ (UI Toggles)
            const [showReport, setShowReport] = useState(false);
            const [showTripSettings, setShowTripSettings] = useState(false);
            const [showStopSelector, setShowStopSelector] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [showNegativeCorrection, setShowNegativeCorrection] = useState(false); 
            const [negativeDeficit, setNegativeDeficit] = useState(0); 
            const [copied, setCopied] = useState(false);
            const [showStats, setShowStats] = useState(false); 
            
            // å ±å‘Šè¨­å®š
            const [durationFormat, setDurationFormat] = useState('min'); 

            // å½ˆå‡ºè¦–çª—ç‹€æ…‹ (Modal State)
            const [editingValue, setEditingValue] = useState(null); 
            const [manualInputMode, setManualInputMode] = useState('direct_base'); 
            const [manualInputValue, setManualInputValue] = useState('');

            // æ­·å²ç·¨è¼¯ç‹€æ…‹
            const [editingHistoryIndex, setEditingHistoryIndex] = useState(null);
            const [historyEditValues, setHistoryEditValues] = useState({ on: 0, off: 0, note: '' });

            // --- API æ•¸æ“šç‹€æ…‹ (API Data) ---
            const [isLoading, setIsLoading] = useState(false);
            const [variants, setVariants] = useState([]); 
            const [showVariantSelector, setShowVariantSelector] = useState(false);
            const [routeStops, setRouteStops] = useState([]); 
            const [apiError, setApiError] = useState(null);

            // --- çµ±è¨ˆæ•¸æ“šç‹€æ…‹ (Stats State) ---
            const [statsData, setStatsData] = useState({ trips: {}, total: 0, lastSaveTime: Date.now() });

            // ç”¨ä¾†é¿å…é¦–æ¬¡æ¸²æŸ“æ™‚è§¸ç™¼ useEffect å„²å­˜ç©ºæ•¸æ“š
            const isLoaded = useRef(false);

            // --- Helper Functions ---
            
            const formatTime24 = (date = new Date()) => {
                return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
            };

            const cleanStopName = (name) => {
                if (!name) return '';
                let cleaned = name.replace(/[\(ï¼ˆ]([^\u4e00-\u9fa5]+?)[\)ï¼‰]/g, '').trim();
                cleaned = cleaned.split(/,|ï¼Œ/)[0];
                return cleaned.trim();
            };

            const calculateDurationMinutes = (startStr, endStr) => {
                if (!startStr || !endStr || startStr === '-' || endStr === '-') return 0;
                const [h1, m1] = startStr.split(':').map(Number);
                const [h2, m2] = endStr.split(':').map(Number);
                
                let minutes = (h2 * 60 + m2) - (h1 * 60 + m1);
                if (minutes < 0) minutes += 24 * 60; // è·¨åˆå¤œ
                return minutes;
            };

            // --- åˆå§‹åŒ–èˆ‡è‡ªå‹•å„²å­˜ (Initialization & Auto-Save) ---

            useEffect(() => {
                const savedStats = localStorage.getItem('busCounterStats');
                if (savedStats) {
                    try {
                        let parsed = JSON.parse(savedStats);
                        parsed = checkAndResetStats(parsed);
                        setStatsData(parsed);
                    } catch (e) { console.error("Failed to load stats", e); }
                }

                const savedSession = localStorage.getItem('busCounterCurrentSession');
                if (savedSession) {
                    try {
                        const session = JSON.parse(savedSession);
                        setCompany(session.company || 'KMB');
                        setRouteNumber(session.routeNumber || '');
                        setCurrentStopIndex(session.currentStopIndex || 0);
                        setTripInfo(session.tripInfo || { plate: '', captainId: '', captainName: '' });
                        setActiveVariant(session.activeVariant || null);
                        setTripRecorded(session.tripRecorded || false);
                        setInitialPassengers(session.initialPassengers || 0);
                        setTotalPassengers(session.totalPassengers || 0);
                        setStopOn(session.stopOn || 0);
                        setStopOff(session.stopOff || 0);
                        setArrivalTime(session.arrivalTime || '');
                        setHistory(session.history || []);
                        setRouteStops(session.routeStops || []);
                        setCurrentNote(session.currentNote || '');
                        setIncludeNotesInReport(session.includeNotesInReport ?? true);
                        setIncludeAnalysis(session.includeAnalysis ?? true);
                    } catch (e) {
                        console.error("Failed to load session", e);
                    }
                }
                isLoaded.current = true;
            }, []);

            useEffect(() => {
                if (!isLoaded.current) return;
                const sessionData = {
                    company, routeNumber, currentStopIndex, tripInfo, activeVariant, tripRecorded,
                    initialPassengers, totalPassengers, stopOn, stopOff, arrivalTime, history, routeStops,
                    currentNote, includeNotesInReport, includeAnalysis
                };
                localStorage.setItem('busCounterCurrentSession', JSON.stringify(sessionData));
            }, [company, routeNumber, currentStopIndex, tripInfo, activeVariant, tripRecorded, initialPassengers, totalPassengers, stopOn, stopOff, arrivalTime, history, routeStops, currentNote, includeNotesInReport, includeAnalysis]);


            // --- çµ±è¨ˆèˆ‡æ¸…ç©ºé‚è¼¯ ---

            const checkAndResetStats = (data) => {
                if (!data.lastSaveTime) return data;
                const lastSaveDate = new Date(data.lastSaveTime);
                const now = new Date();
                let resetThreshold = new Date(now.getFullYear(), 0, 1, 2, 0, 0); 
                if (now < resetThreshold) {
                    resetThreshold = new Date(now.getFullYear() - 1, 0, 1, 2, 0, 0);
                }
                if (lastSaveDate < resetThreshold) {
                    const newData = { trips: {}, total: 0, lastSaveTime: Date.now() };
                    localStorage.setItem('busCounterStats', JSON.stringify(newData));
                    return newData;
                }
                return data;
            };

            const saveTripToStats = () => {
                if (tripRecorded || !activeVariant) return; 

                const newData = { ...statsData };
                const key = `${activeVariant.company}-${activeVariant.route}-${activeVariant.description}`;

                if (!newData.trips[key]) {
                    newData.trips[key] = {
                        company: activeVariant.company,
                        route: activeVariant.route,
                        desc: activeVariant.description,
                        count: 0
                    };
                }

                newData.trips[key].count += 1;
                newData.total += 1;
                newData.lastSaveTime = Date.now();

                setStatsData(newData);
                localStorage.setItem('busCounterStats', JSON.stringify(newData));
                setTripRecorded(true); 
            };

            const manualClearStats = () => {
                if (window.confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å¹´åº¦çµ±è¨ˆè³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) {
                    const empty = { trips: {}, total: 0, lastSaveTime: Date.now() };
                    setStatsData(empty);
                    localStorage.setItem('busCounterStats', JSON.stringify(empty));
                }
            };
            
            // --- æ ¸å¿ƒæ¼”ç®—æ³• ---

            const recalculateAll = (baseCount, currentHistory = history) => {
                let runningTotal = baseCount;
                const newHistory = currentHistory.map(record => {
                    if (record.isSeparator) return record;
                    runningTotal = runningTotal + record.on - record.off;
                    return { ...record, occupancy: runningTotal };
                });
                setHistory(newHistory);
                setInitialPassengers(baseCount);
                const currentLiveTotal = runningTotal + stopOn - stopOff;
                setTotalPassengers(currentLiveTotal);
            };

            const checkForNegativeDeficit = () => {
                const lowestHistoryOccupancy = history.reduce((min, r) => {
                    if (r.isSeparator) return min;
                    return Math.min(min, r.occupancy);
                }, Infinity); 
                const overallLowest = Math.min(lowestHistoryOccupancy, totalPassengers);
                return Math.max(0, -overallLowest);
            };
            
            const handleCorrection = () => {
                recalculateAll(initialPassengers + negativeDeficit);
                setNegativeDeficit(0);
                setShowNegativeCorrection(false);
                setShowReport(true);
            };

            const handleShowReport = () => {
                const deficit = checkForNegativeDeficit();
                if (deficit > 0) {
                    setNegativeDeficit(deficit);
                    setShowNegativeCorrection(true);
                } else {
                    setShowReport(true);
                }
            };

            // --- Analysis Calculation (Enhanced) ---
            const getAnalysisData = () => {
                let combinedData = history.filter(r => !r.isSeparator);
                
                // Check if current active stop is valid to add
                if (routeStops.length > 0 && currentStopIndex < routeStops.length) {
                     if (stopOn > 0 || stopOff > 0 || arrivalTime || currentNote) {
                         const currentRec = {
                             stopName: routeStops[currentStopIndex].name,
                             on: stopOn,
                             occupancy: totalPassengers,
                             note: currentNote,
                             isLive: true // Flag to identify live data
                         };
                         combinedData = [...combinedData, currentRec];
                     }
                }

                if (combinedData.length === 0) return null;

                let maxOnVal = 0;
                let maxOccVal = 0;

                combinedData.forEach(r => {
                    if (r.on > maxOnVal) maxOnVal = r.on;
                    if (r.occupancy > maxOccVal) maxOccVal = r.occupancy;
                });

                const maxOnStops = combinedData.filter(r => r.on === maxOnVal && maxOnVal > 0);
                
                // Enhanced Logic for Occupancy Segment
                // We need to store { from: stopName, to: nextStopName, val: occupancy }
                const maxOccSegments = [];
                
                combinedData.forEach((r, idx) => {
                    if (r.occupancy === maxOccVal && maxOccVal > 0) {
                        let toStopName = "(ç¸½ç«™å‰)"; // Default fallback
                        
                        // Try to find the next stop
                        if (idx + 1 < combinedData.length) {
                            // If next record exists in combinedData
                            toStopName = cleanStopName(combinedData[idx + 1].stopName);
                        } else if (r.isLive) {
                            // If it's the live record, try to look at future routeStops
                            if (currentStopIndex + 1 < routeStops.length) {
                                toStopName = routeStops[currentStopIndex + 1].name;
                            }
                        }
                        
                        maxOccSegments.push({
                            from: cleanStopName(r.stopName),
                            to: toStopName,
                            val: r.occupancy
                        });
                    }
                });

                return { maxOnVal, maxOccVal, maxOnStops, maxOccSegments };
            };

            // --- API åŠŸèƒ½ ---
            
            const getCompanyColor = (comp) => {
                if (comp === 'KMB') return 'bg-red-600 border-red-700 text-white';
                if (comp === 'CTB') return 'bg-yellow-400 border-yellow-500 text-black';
                if (comp === 'NLB') return 'bg-teal-600 border-teal-700 text-white'; 
                return 'bg-gray-400 border-gray-500 text-white';
            };

            const toggleCompany = () => {
                setCompany(prev => {
                    if (prev === 'KMB') return 'CTB';
                    if (prev === 'CTB') return 'NLB';
                    return 'KMB';
                });
            };

            const searchRoute = async () => {
                if (!routeNumber) return;
                setIsLoading(true);
                setApiError(null);
                setVariants([]);
                setShowVariantSelector(false);
                setActiveVariant(null); 

                try {
                    if (company === 'KMB') {
                        const API_BASE = 'https://data.etabus.gov.hk/v1/transport/kmb';
                        const response = await fetch(`${API_BASE}/route/`);
                        const data = await response.json();
                        
                        if (data.data) {
                            const filteredRoutes = data.data.filter(
                                r => r.route.toUpperCase() === routeNumber.toUpperCase()
                            );

                            if (filteredRoutes.length > 0) {
                                const routeVariants = filteredRoutes.map(r => ({
                                    company: 'KMB',
                                    route: r.route,
                                    bound: r.bound, 
                                    serviceType: r.service_type, 
                                    orig: r.orig_tc,
                                    dest: r.dest_tc,
                                    description: `å¾€ ${r.dest_tc}`,
                                    subDescription: `ç”± ${r.orig_tc} é–‹å‡º`,
                                    tag: r.service_type === '1' ? 'æ—¥å¸¸ç­æ¬¡' : `ç‰¹åˆ¥ç­æ¬¡ (${r.service_type})`
                                }));
                                routeVariants.sort((a, b) => a.serviceType - b.serviceType);
                                setVariants(routeVariants);
                                setShowVariantSelector(true);
                            } else {
                                setApiError(`æ‰¾ä¸åˆ°ä¹å·´è·¯ç·š ${routeNumber} çš„è³‡æ–™`);
                            }
                        } else {
                            setApiError("ä¹å·´ API é€£ç·šéŒ¯èª¤");
                        }
                    } else if (company === 'CTB') {
                        const response = await fetch(`https://rt.data.gov.hk/v2/transport/citybus/route/CTB/${routeNumber.toUpperCase()}`);
                        const data = await response.json();
                        if (data.data) {
                            const r = Array.isArray(data.data) ? data.data : [data.data];
                            let ctbVariants = [];
                            r.forEach(routeObj => {
                                ctbVariants.push({
                                    company: 'CTB', route: routeObj.route, dir: 'outbound', orig: routeObj.orig_tc, dest: routeObj.dest_tc,
                                    description: `å¾€ ${routeObj.dest_tc} (å»ç¨‹)`, subDescription: `ç”± ${routeObj.orig_tc} é–‹å‡º`, tag: 'å»ç¨‹'
                                });
                                ctbVariants.push({
                                    company: 'CTB', route: routeObj.route, dir: 'inbound', orig: routeObj.dest_tc, dest: routeObj.orig_tc,
                                    description: `å¾€ ${routeObj.orig_tc} (å›ç¨‹)`, subDescription: `ç”± ${routeObj.dest_tc} é–‹å‡º`, tag: 'å›ç¨‹'
                                });
                            });
                            setVariants(ctbVariants);
                            setShowVariantSelector(true);
                        } else {
                            setApiError(`æ‰¾ä¸åˆ°åŸå·´è·¯ç·š ${routeNumber} çš„è³‡æ–™`);
                        }
                    } else if (company === 'NLB') {
                        const response = await fetch(`https://rt.data.gov.hk/v2/transport/nlb/route.php?action=list`);
                        const data = await response.json();
                        
                        if (data && data.routes) {
                            const filteredRoutes = data.routes.filter(
                                r => r.routeNo.toUpperCase() === routeNumber.toUpperCase()
                            );

                            if (filteredRoutes.length > 0) {
                                const nlbVariants = filteredRoutes.map(r => ({
                                    company: 'NLB',
                                    route: r.routeNo,
                                    routeId: r.routeId, 
                                    description: r.routeName_c, 
                                    subDescription: r.routeName_e, 
                                    tag: 'å¶¼å·´'
                                }));
                                setVariants(nlbVariants);
                                setShowVariantSelector(true);
                            } else {
                                setApiError(`æ‰¾ä¸åˆ°å¶¼å·´è·¯ç·š ${routeNumber} çš„è³‡æ–™`);
                            }
                        } else {
                            setApiError("å¶¼å·´ API é€£ç·šéŒ¯èª¤");
                        }
                    }
                } catch (err) {
                    console.error(err);
                    setApiError("API é€£ç·šéŒ¯èª¤ (è«‹æª¢æŸ¥ç¶²çµ¡)");
                } finally {
                    setIsLoading(false);
                }
            };

            const selectVariant = async (variant) => {
                setIsLoading(true);
                setShowVariantSelector(false);
                setApiError(null);
                setRouteStops([]);
                setActiveVariant(variant); 
                try {
                    let fullStopsData = [];

                    if (variant.company === 'KMB') {
                        const direction = variant.bound === 'O' ? 'outbound' : 'inbound';
                        const stopListUrl = `https://data.etabus.gov.hk/v1/transport/kmb/route-stop/${variant.route}/${direction}/${variant.serviceType}`;
                        const stopListRes = await fetch(stopListUrl);
                        const stopListData = await stopListRes.json();
                        if (!stopListData.data || stopListData.data.length === 0) throw new Error("ç„¡ç«™é»è³‡æ–™");

                        const stopIds = stopListData.data.map(item => ({ id: item.stop, seq: item.seq }));
                        fullStopsData = await Promise.all(stopIds.map(async (s) => {
                            try {
                                const detailUrl = `https://data.etabus.gov.hk/v1/transport/kmb/stop/${s.id}`;
                                const detailRes = await fetch(detailUrl);
                                const detailData = await detailRes.json();
                                return { seq: s.seq, id: s.id, name: detailData.data.name_tc };
                            } catch { return { seq: s.seq, id: s.id, name: "æœªçŸ¥ç«™é»" }; }
                        }));
                        fullStopsData.sort((a, b) => parseInt(a.seq) - parseInt(a.seq));

                    } else if (variant.company === 'CTB') {
                        const stopListUrl = `https://rt.data.gov.hk/v2/transport/citybus/route-stop/CTB/${variant.route}/${variant.dir}`;
                        const stopListRes = await fetch(stopListUrl);
                        const stopListData = await stopListRes.json();
                        if (!stopListData.data || stopListData.data.length === 0) throw new Error("ç„¡ç«™é»è³‡æ–™");

                        const stopIds = stopListData.data.map(item => ({ id: item.stop, seq: item.seq }));
                        fullStopsData = await Promise.all(stopIds.map(async (s) => {
                            try {
                                const detailUrl = `https://rt.data.gov.hk/v2/transport/citybus/stop/${s.id}`;
                                const detailRes = await fetch(detailUrl);
                                const detailData = await detailRes.json();
                                return { seq: s.seq, id: s.id, name: detailData.data.name_tc };
                            } catch { return { seq: s.seq, id: s.id, name: "æœªçŸ¥ç«™é»" }; }
                        }));
                        fullStopsData.sort((a, b) => parseInt(a.seq) - parseInt(a.seq));

                    } else if (variant.company === 'NLB') {
                        const stopListUrl = `https://rt.data.gov.hk/v2/transport/nlb/stop.php?action=list&routeId=${variant.routeId}`;
                        const stopListRes = await fetch(stopListUrl);
                        const stopListData = await stopListRes.json();
                        
                        if (!stopListData.stops || stopListData.stops.length === 0) throw new Error("ç„¡ç«™é»è³‡æ–™");

                        fullStopsData = stopListData.stops.map((s, index) => ({
                            seq: index + 1,
                            id: s.stopId,
                            name: s.stopName_c
                        }));
                    }
                    
                    setRouteStops(fullStopsData);
                    
                    if (routeStops.length === 0 && history.length === 0) {
                        resetCounter();
                    } else {
                        setCurrentStopIndex(0);
                        setStopOn(0);
                        setStopOff(0);
                        setArrivalTime('');
                        setCurrentNote('');
                    }

                    setShowTripSettings(true); 

                } catch (err) { 
                    console.error(err);
                    setApiError(err.message || "åŠ è¼‰ç«™é»å¤±æ•—"); 
                } finally { 
                    setIsLoading(false); 
                }
            };

            // --- é‚è¼¯è™•ç† (Logic) ---

            const resetCounter = () => {
                setCurrentStopIndex(0); setInitialPassengers(0); setTotalPassengers(0);
                setStopOn(0); setStopOff(0); setArrivalTime('');
                setHistory([]); setNegativeDeficit(0); setShowNegativeCorrection(false);
                setTripRecorded(false); 
                setCurrentNote(''); 
            };

            const openResetConfirm = () => setShowResetConfirm(true);

            const performHardReset = () => {
                resetCounter(); 
                setRouteStops([]); 
                setRouteNumber(''); 
                setVariants([]);
                setTripInfo({ plate: '', captainId: '', captainName: '' });
                setActiveVariant(null);
                setApiError(null); 
                setShowReport(false); 
                setShowResetConfirm(false);
                localStorage.removeItem('busCounterCurrentSession');
            };

            const handleFinishAndReset = () => {
                saveTripToStats();
                performHardReset();
            };

            const setArrivalNow = () => setArrivalTime(formatTime24());

            const jumpToStop = (index) => {
                setCurrentStopIndex(index); setStopOn(0); setStopOff(0); setArrivalTime('');
                setShowStopSelector(false);
                setCurrentNote('');
            };

            const openManualInput = (type) => {
                setEditingValue(type);
                if (type === 'initial') {
                    setManualInputMode('direct_base'); 
                    setManualInputValue(initialPassengers.toString());
                } else if (type === 'on') {
                    setManualInputValue(stopOn.toString());
                } else if (type === 'off') {
                    setManualInputValue(stopOff.toString());
                }
            };

            const saveManualInput = () => {
                const val = parseInt(manualInputValue) || 0;
                
                if (editingValue === 'initial') {
                    if (manualInputMode === 'direct_base') {
                        recalculateAll(val);
                    } else {
                        const currentNetChange = totalPassengers - initialPassengers;
                        const newBase = val - currentNetChange;
                        recalculateAll(newBase);
                    }
                } else if (editingValue === 'on') {
                    const diff = val - stopOn;
                    setStopOn(val);
                    setTotalPassengers(prev => prev + diff);
                } else if (editingValue === 'off') {
                    const diff = val - stopOff;
                    setStopOff(val);
                    setTotalPassengers(prev => prev - diff); 
                }
                setEditingValue(null);
            };

            const openHistoryEdit = (index) => {
                const record = history[index];
                if (record.isSeparator) return; 
                setHistoryEditValues({ on: record.on, off: record.off, note: record.note || '' });
                setEditingHistoryIndex(index);
            };

            const saveHistoryEdit = () => {
                if (editingHistoryIndex === null) return;
                const updatedHistory = [...history];
                updatedHistory[editingHistoryIndex] = {
                    ...updatedHistory[editingHistoryIndex],
                    on: parseInt(historyEditValues.on) || 0,
                    off: parseInt(historyEditValues.off) || 0,
                    note: historyEditValues.note 
                };
                recalculateAll(initialPassengers, updatedHistory);
                setEditingHistoryIndex(null);
            };

            const handleNextStop = () => {
                if (routeStops.length > 0 && currentStopIndex === routeStops.length - 1) {
                    saveTripToStats();
                }

                if (routeStops.length > 0 && currentStopIndex >= routeStops.length) return;
                const currentStopName = routeStops.length > 0 ? routeStops[currentStopIndex]?.name : `ç¬¬ ${currentStopIndex + 1} ç«™`;
                const stopData = {
                    stopNumber: currentStopIndex + 1, stopName: currentStopName,
                    arrivalTime: arrivalTime || '-', on: stopOn, off: stopOff,
                    occupancy: totalPassengers, timestamp: formatTime24(),
                    note: currentNote 
                };
                setHistory([...history, stopData]);
                setCurrentStopIndex(prev => prev + 1);
                setStopOn(0); setStopOff(0); setArrivalTime('');
                setCurrentNote(''); 
            };

            const handleContinueTrip = () => {
                const currentStopName = routeStops.length > 0 ? routeStops[currentStopIndex]?.name : `ç¬¬ ${currentStopIndex + 1} ç«™`;
                const stopData = {
                    stopNumber: currentStopIndex + 1, stopName: currentStopName,
                    arrivalTime: arrivalTime || '-', on: stopOn, off: stopOff,
                    occupancy: totalPassengers, timestamp: formatTime24(),
                    note: currentNote || 'ç¹¼çºŒ/åˆä½µè¡Œç¨‹'
                };
                
                const separatorData = {
                    isSeparator: true,
                    stopName: '--- ç¹¼çºŒè¡Œç¨‹ ---',
                    arrivalTime: '-', on: 0, off: 0, occupancy: totalPassengers, note: ''
                };

                setHistory([...history, stopData, separatorData]);

                setCurrentStopIndex(0);
                setStopOn(0);
                setStopOff(0);
                setArrivalTime('');
                setCurrentNote('');
                
                setRouteStops([]); 
                setActiveVariant(null); 
                setShowVariantSelector(true);
            };

            const incrementOn = () => { setStopOn(s => s + 1); setTotalPassengers(t => t + 1); };
            const decrementOn = () => { if (stopOn > 0) { setStopOn(s => s - 1); setTotalPassengers(t => t - 1); }};
            const incrementOff = () => { setStopOff(s => s + 1); setTotalPassengers(t => t - 1); };
            const decrementOff = () => { if (stopOff > 0) { setStopOff(s => s - 1); setTotalPassengers(t => t - 1); }};

            // --- Report Logic ---

            const getTripDuration = () => {
                if (history.length === 0) return 0;
                const start = history[0].arrivalTime;
                let end = arrivalTime;
                
                for (let i = history.length - 1; i >= 0; i--) {
                    if (!history[i].isSeparator && history[i].arrivalTime !== '-') {
                        if (!end) end = history[i].arrivalTime;
                        break;
                    }
                }
                
                if (arrivalTime && currentStopIndex < routeStops.length) {
                    end = arrivalTime; 
                }
                return calculateDurationMinutes(start, end);
            };

            const formatDuration = (mins) => {
                if (durationFormat === 'min') return `${mins} åˆ†é˜`;
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                return h > 0 ? `${h}å°æ™‚${m}åˆ†é˜` : `${m}åˆ†é˜`;
            };

            // --- EXCEL EXPORT FUNCTION ---
            const exportToExcel = () => {
                const duration = getTripDuration();
                const durationStr = formatDuration(duration);
                const dateStr = new Date().toLocaleDateString();
                const filename = `BusReport_${routeNumber || 'Route'}_${dateStr.replace(/\//g, '-')}.xlsx`;
                const analysisData = getAnalysisData();

                // 1. Prepare Metadata Header
                const wsData = [
                    ["å·´å£«å®¢é‡çµ±è¨ˆå ±å‘Š"],
                    ["æ—¥æœŸ", dateStr],
                    ["è·¯ç·š", `${company} ${routeNumber || '-'}`],
                    ["è»Šç‰Œ", tripInfo.plate || '-'],
                    ["è»Šé•·", `${tripInfo.captainId || '-'} ${tripInfo.captainName || ''}`],
                    ["ç¸½è¡Œè»Šæ™‚é–“", durationStr],
                    ["åˆå§‹äººæ•¸", initialPassengers],
                    [], // Empty Row
                ];

                // Add Analysis if enabled
                if (includeAnalysis && analysisData && (analysisData.maxOnVal > 0 || analysisData.maxOccVal > 0)) {
                    wsData.push(["*** é‡é»å®¢é‡åˆ†æ ***"]);
                    if (analysisData.maxOnStops.length > 0) {
                        const stops = analysisData.maxOnStops.map(s => cleanStopName(s.stopName)).join(", ");
                        wsData.push(["æœ€å¤šäººä¸Šè»Š", `${stops} (${analysisData.maxOnVal}äºº)`]);
                    }
                    if (analysisData.maxOccSegments.length > 0) {
                        const segments = analysisData.maxOccSegments.map(s => `${s.from} - ${s.to} æ®µ`).join(", ");
                        wsData.push(["æœ€é«˜è¼‰å®¢è·¯æ®µ", `${segments} (${analysisData.maxOccVal}äºº)`]);
                    }
                    wsData.push([]); // Empty Row
                }

                // Table Header
                wsData.push(["æ™‚é–“", "ç«™å", "ä¸Š", "è½", "è»Šä¸Š", "å‚™è¨»"]);

                // 2. Add History Rows
                history.forEach(record => {
                    if (record.isSeparator) {
                        wsData.push(["--- ç¹¼çºŒè¡Œç¨‹ ---", "", "", "", "", ""]);
                    } else {
                        wsData.push([
                            record.arrivalTime === '-' ? '--:--' : record.arrivalTime,
                            cleanStopName(record.stopName),
                            record.on,
                            record.off,
                            record.occupancy,
                            record.note || ''
                        ]);
                    }
                });

                // 3. Add Current Stop (if active)
                if (routeStops.length > 0 && currentStopIndex < routeStops.length) {
                    if (stopOn > 0 || stopOff > 0 || arrivalTime || currentNote) {
                        const rawName = routeStops.length > 0 ? routeStops[currentStopIndex]?.name : `ç¬¬ ${currentStopIndex + 1} ç«™`;
                         wsData.push([
                            arrivalTime || '--:--',
                            cleanStopName(rawName),
                            stopOn,
                            stopOff,
                            totalPassengers,
                            currentNote || ''
                        ]);
                    }
                }

                // 4. Create Worksheet and Workbook
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // Adjust column widths
                ws['!cols'] = [
                    { wch: 10 }, // Time
                    { wch: 25 }, // Stop Name
                    { wch: 5 },  // On
                    { wch: 5 },  // Off
                    { wch: 8 },  // Occupancy
                    { wch: 20 }  // Note
                ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Report");

                // 5. Download File
                XLSX.writeFile(wb, filename);
            };

            const copyReport = () => {
                if (currentStopIndex >= routeStops.length - 1) {
                    saveTripToStats();
                }

                const duration = getTripDuration();
                const analysisData = getAnalysisData();
                
                let text = `å·´å£«å®¢é‡çµ±è¨ˆå ±å‘Š\n`;
                text += `================================\n`;
                text += `æ—¥æœŸ: ${new Date().toLocaleDateString()}\n`;
                text += `è·¯ç·š: ${company} ${routeNumber || '-'}\n`;
                text += `è»Šç‰Œ: ${tripInfo.plate || '-'}\n`;
                text += `è»Šé•·: ${tripInfo.captainId || '-'} ${tripInfo.captainName || ''}\n`;
                text += `ç¸½è¡Œè»Šæ™‚é–“: ${formatDuration(duration)}\n`;
                text += `åˆå§‹: ${initialPassengers} äºº\n\n`;

                if (includeAnalysis && analysisData && (analysisData.maxOnVal > 0 || analysisData.maxOccVal > 0)) {
                    text += `*** é‡é»å®¢é‡åˆ†æ ***\n`;
                    if (analysisData.maxOnStops.length > 0) {
                        const stops = analysisData.maxOnStops.map(s => cleanStopName(s.stopName)).join(", ");
                        text += `ğŸ”¥ æœ€å¤šäººä¸Šè»Š: ${stops} (+${analysisData.maxOnVal})\n`;
                    }
                    if (analysisData.maxOccSegments.length > 0) {
                        const segments = analysisData.maxOccSegments.map(s => `${s.from} - ${s.to} æ®µ`).join(", ");
                        text += `ğŸšŒ æœ€é«˜è¼‰å®¢è·¯æ®µ: ${segments} (${analysisData.maxOccVal})\n`;
                    }
                    text += `\n`;
                }
                
                if (includeNotesInReport) {
                    text += `æ™‚é–“   | ç«™å          | ä¸Š  | è½  | è»Šä¸Š | å‚™è¨»\n`;
                    text += `----------------------------------------------------\n`;
                } else {
                    text += `æ™‚é–“   | ç«™å          | ä¸Š  | è½  | è»Šä¸Š\n`;
                    text += `---------------------------------------------\n`;
                }
                
                history.forEach(record => {
                    if (record.isSeparator) {
                        text += `--- ç¹¼çºŒè¡Œç¨‹ / è½‰é  ---\n`;
                        return;
                    }
                    const timeStr = record.arrivalTime === '-' ? '--:--' : record.arrivalTime;
                    const stopName = cleanStopName(record.stopName);
                    const occupancyDisplay = record.occupancy < 0 ? `(${record.occupancy})` : record.occupancy;
                    
                    let line = `${timeStr.padEnd(6)} | ${stopName.padEnd(12)} | +${record.on.toString().padEnd(2)} | -${record.off.toString().padEnd(2)} | ${occupancyDisplay}`;
                    
                    if (includeNotesInReport) {
                        line += ` | ${record.note || ''}`;
                    }
                    text += line + `\n`;
                });
                
                if (routeStops.length === 0 || currentStopIndex < routeStops.length) {
                    if (stopOn > 0 || stopOff > 0 || arrivalTime || currentNote) {
                        const rawName = routeStops.length > 0 ? routeStops[currentStopIndex]?.name : `ç¬¬ ${currentStopIndex + 1} ç«™`;
                        const currName = cleanStopName(rawName);
                        const currTime = arrivalTime || '--:--';
                        const occupancyDisplay = totalPassengers < 0 ? `(${totalPassengers})` : totalPassengers;
                        
                        let line = `${currTime.padEnd(6)} | ${currName.padEnd(12)} | +${stopOn.toString().padEnd(2)} | -${stopOff.toString().padEnd(2)} | ${occupancyDisplay}`;
                        if (includeNotesInReport) {
                            line += ` | ${currentNote || ''}`;
                        }
                        text += line + `\n`;
                    }
                }
                
                const finalDisplay = totalPassengers < 0 ? `(${totalPassengers})` : totalPassengers;
                text += `\næœ€çµ‚è»Šä¸Šäººæ•¸: ${finalDisplay}`;
                text += `\nç”± BusCounter ç”Ÿæˆ`;

                navigator.clipboard.writeText(text).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); })
                    .catch(() => { /* Fallback */ });
            };

            const getCurrentStopDisplay = () => {
                if (routeStops.length > 0) {
                    if (currentStopIndex < routeStops.length) return routeStops[currentStopIndex].name;
                    return "è¡Œç¨‹çµæŸ (End)";
                }
                return `ç¬¬ ${currentStopIndex + 1} ç«™`;
            };

            const getNextStopDisplay = () => {
                if (routeStops.length > 0) {
                    if (currentStopIndex < routeStops.length - 1) return "ä¸‹ä¸€ç«™: " + routeStops[currentStopIndex + 1].name;
                    if (currentStopIndex === routeStops.length - 1) return "ç¸½ç«™ (è¨˜éŒ„ä¸¦çµæŸ)";
                    return "è¡Œç¨‹å·²çµæŸ";
                }
                return "å‰å¾€ä¸‹ä¸€ç«™";
            };

            const isLastStop = routeStops.length > 0 && currentStopIndex === routeStops.length - 1;

            // --- UI Render ---
            
            const renderHistoryEditModal = () => {
                if (editingHistoryIndex === null) return null;
                const record = history[editingHistoryIndex];
                if (record.isSeparator) return null;

                return (
                    <div className="absolute inset-0 z-[70] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                        <div className="bg-white rounded-xl p-5 w-full max-w-xs shadow-2xl">
                            <h3 className="text-lg font-bold mb-2 text-slate-700 flex items-center gap-2">
                                <Pencil className="w-5 h-5"/> ä¿®æ­£æ­·å²è¨˜éŒ„
                            </h3>
                            <p className="text-xs text-slate-500 mb-4 border-b pb-2">ç«™é»: {cleanStopName(record.stopName)}</p>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="text-xs font-bold text-green-600 uppercase block mb-1">ä¸Šè»Š (On)</label>
                                    <input type="number" value={historyEditValues.on} onChange={(e) => setHistoryEditValues({...historyEditValues, on: e.target.value})} className="w-full border-2 border-green-100 rounded-lg p-2 text-xl font-bold text-center focus:border-green-500 outline-none" />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-red-500 uppercase block mb-1">è½è»Š (Off)</label>
                                    <input type="number" value={historyEditValues.off} onChange={(e) => setHistoryEditValues({...historyEditValues, off: e.target.value})} className="w-full border-2 border-red-100 rounded-lg p-2 text-xl font-bold text-center focus:border-red-500 outline-none" />
                                </div>
                            </div>
                            <div className="mb-4">
                                <label className="text-xs font-bold text-slate-500 uppercase block mb-1">å‚™è¨» (Note)</label>
                                <input type="text" value={historyEditValues.note} onChange={(e) => setHistoryEditValues({...historyEditValues, note: e.target.value})} className="w-full border-2 border-slate-200 rounded-lg p-2 text-sm text-slate-800 outline-none focus:border-blue-400" placeholder="ä¾‹å¦‚ï¼šå®¢æ»¿, é£›ç«™..." />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={() => setEditingHistoryIndex(null)} className="py-2 bg-gray-100 rounded-lg font-bold text-gray-600">å–æ¶ˆ</button>
                                <button onClick={saveHistoryEdit} className="py-2 bg-blue-600 text-white rounded-lg font-bold shadow-sm">ç¢ºèªä¿®æ­£</button>
                            </div>
                        </div>
                    </div>
                );
            };

            // --- STATS PAGE ---
            if (showStats) {
                const tripKeys = Object.keys(statsData.trips).sort((a, b) => {
                    return statsData.trips[b].count - statsData.trips[a].count;
                });

                return (
                    <div className="flex flex-col h-screen bg-gray-50 font-sans text-gray-900 relative">
                        <header className="bg-white border-b p-4 flex items-center justify-between sticky top-0 z-10 shadow-sm">
                            <h2 className="text-xl font-bold flex items-center gap-2"><BarChart3 className="w-6 h-6 text-purple-600" /> å¹´åº¦è¡Œç¨‹çµ±è¨ˆ</h2>
                            <button onClick={() => setShowStats(false)} className="text-purple-600 font-medium">è¿”å›</button>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4">
                            <div className="bg-gradient-to-br from-purple-600 to-blue-600 rounded-xl p-6 text-white shadow-md mb-4 relative overflow-hidden">
                                <div className="relative z-10">
                                    <div className="text-sm font-medium opacity-80 mb-1 flex items-center gap-1"><Calendar className="w-4 h-4"/> å¹´åº¦ç¸½è¡Œç¨‹</div>
                                    <div className="text-5xl font-bold">{statsData.total} <span className="text-lg font-normal opacity-80">æ¬¡</span></div>
                                    <div className="text-[10px] mt-2 opacity-60">
                                        ä¸‹æ¬¡é‡ç½®: {new Date().getFullYear() + 1}å¹´1æœˆ1æ—¥ 02:00
                                    </div>
                                </div>
                                <TrendingUp className="absolute right-[-20px] bottom-[-20px] w-32 h-32 text-white opacity-10" />
                            </div>

                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                                    <h3 className="font-bold text-gray-700">è·¯ç·šæ’è¡Œæ¦œ</h3>
                                    <button onClick={manualClearStats} className="text-red-400 p-1 hover:text-red-600"><Trash2 className="w-4 h-4"/></button>
                                </div>
                                {tripKeys.length === 0 ? (
                                    <div className="p-8 text-center text-gray-400 text-sm">æš«ç„¡çµ±è¨ˆæ•¸æ“š<br/>å®Œæˆä¸€æ¬¡å®Œæ•´è¡Œç¨‹å¾Œå°‡è‡ªå‹•è¨˜éŒ„</div>
                                ) : (
                                    <ul className="divide-y divide-gray-100">
                                        {tripKeys.map(key => {
                                            const t = statsData.trips[key];
                                            return (
                                                <li key={key} className="p-4 flex items-center justify-between hover:bg-gray-50">
                                                    <div className="flex items-center gap-3">
                                                        <span className={`text-xs w-10 h-6 flex items-center justify-center rounded font-bold ${getCompanyColor(t.company).replace('border', '')}`}>{t.company === 'KMB' ? t.route : t.company === 'NLB' ? 'NLB' : 'CTB'}</span>
                                                        <div>
                                                            <div className="font-bold text-gray-800 flex items-center gap-2">
                                                                {t.route} <span className="text-xs font-normal text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded-full">{t.desc}</span>
                                                            </div>
                                                            <div className="text-xs text-gray-400 mt-0.5">{t.company === 'NLB' ? 'å¶¼å·´' : t.company}</div>
                                                        </div>
                                                    </div>
                                                    <div className="font-bold text-xl text-purple-600">{t.count}</div>
                                                </li>
                                            );
                                        })}
                                    </ul>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // --- REPORT PAGE ---
            if (showReport) {
                const duration = getTripDuration();
                const analysisData = getAnalysisData();

                return (
                    <div className="flex flex-col h-screen bg-gray-50 font-sans text-gray-900 relative">
                        {renderHistoryEditModal()}
                        <header className="bg-white border-b p-4 flex items-center justify-between sticky top-0 z-10 shadow-sm">
                            <h2 className="text-xl font-bold flex items-center gap-2"><FileText className="w-6 h-6 text-blue-600" /> çµ±è¨ˆå ±å‘Š</h2>
                            <div className="flex items-center gap-3">
                                {/* Analysis Toggle */}
                                <button onClick={() => setIncludeAnalysis(!includeAnalysis)} className={`flex items-center gap-1 text-xs font-bold px-2 py-1.5 rounded border transition-colors ${includeAnalysis ? 'bg-purple-50 text-purple-700 border-purple-200' : 'bg-gray-50 text-gray-400 border-gray-200'}`}>
                                    <Lightbulb className="w-3 h-3"/> {includeAnalysis ? 'åˆ†æ' : 'éš±è—'}
                                </button>
                                {/* Note Toggle */}
                                <button onClick={() => setIncludeNotesInReport(!includeNotesInReport)} className={`flex items-center gap-1 text-xs font-bold px-2 py-1.5 rounded border transition-colors ${includeNotesInReport ? 'bg-yellow-50 text-yellow-700 border-yellow-200' : 'bg-gray-50 text-gray-400 border-gray-200'}`}>
                                    {includeNotesInReport ? <Eye className="w-3 h-3"/> : <EyeOff className="w-3 h-3"/>}
                                    {includeNotesInReport ? 'å‚™è¨»' : 'éš±è—'}
                                </button>
                                <button onClick={() => setShowReport(false)} className="text-blue-600 font-medium">è¿”å›</button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4">
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-4">
                                <div className="p-4 bg-slate-50 border-b grid grid-cols-2 gap-y-3 text-sm">
                                    <div><span className="text-slate-400 block text-[10px] uppercase font-bold">Route è·¯ç·š</span><span className="font-bold text-lg">{company} {routeNumber}</span></div>
                                    <div className="text-right"><span className="text-slate-400 block text-[10px] uppercase font-bold">Date æ—¥æœŸ</span><span className="font-bold">{new Date().toLocaleDateString()}</span></div>
                                    <div><span className="text-slate-400 block text-[10px] uppercase font-bold">Bus No. è»Šç‰Œ</span><span className="font-bold">{tripInfo.plate || '-'}</span></div>
                                    <div className="text-right"><span className="text-slate-400 block text-[10px] uppercase font-bold">Captain è»Šé•·</span><span className="font-bold">{tripInfo.captainId || '-'} {tripInfo.captainName}</span></div>
                                    
                                    <div className="col-span-2 border-t border-slate-200 pt-2 mt-1">
                                        <div className="flex justify-between items-center mb-1">
                                            <span className="text-slate-400 text-[10px] uppercase font-bold flex items-center gap-1"><Timer className="w-3 h-3"/> è¡Œè»Šæ™‚é–“ (Duration)</span>
                                            <div className="flex bg-slate-200 rounded p-0.5">
                                                <button onClick={() => setDurationFormat('min')} className={`text-[10px] px-2 py-0.5 rounded font-bold transition-all ${durationFormat === 'min' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'}`}>åˆ†é˜</button>
                                                <button onClick={() => setDurationFormat('hm')} className={`text-[10px] px-2 py-0.5 rounded font-bold transition-all ${durationFormat === 'hm' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'}`}>æ™‚:åˆ†</button>
                                            </div>
                                        </div>
                                        <div className="font-bold text-xl text-slate-800">{formatDuration(duration)}</div>
                                    </div>

                                    <div className="col-span-2 border-t pt-2 flex justify-between items-center">
                                        <span className="text-slate-500 text-xs">åˆå§‹äººæ•¸ (Base):</span>
                                        <span className="font-bold text-lg">{initialPassengers}</span>
                                    </div>
                                </div>

                                {/* ANALYSIS BOX */}
                                {includeAnalysis && analysisData && (analysisData.maxOnVal > 0 || analysisData.maxOccVal > 0) && (
                                    <div className="bg-purple-50 border-b border-purple-100 p-3">
                                        <h3 className="text-purple-800 text-xs font-bold uppercase mb-2 flex items-center gap-1"><TrendingUp className="w-3 h-3"/> é‡é»å®¢é‡åˆ†æ</h3>
                                        <div className="space-y-2">
                                            {analysisData.maxOnStops.length > 0 && (
                                                <div className="flex justify-between items-start text-sm">
                                                    <span className="text-gray-500 text-xs font-bold">æœ€å¤šäººä¸Šè»Š (Max Boarding)</span>
                                                    <div className="text-right">
                                                        <div className="font-bold text-purple-700">{analysisData.maxOnStops.map(s => cleanStopName(s.stopName)).join(", ")}</div>
                                                        <div className="text-xs text-purple-500">+{analysisData.maxOnVal} äºº</div>
                                                    </div>
                                                </div>
                                            )}
                                            {analysisData.maxOccSegments.length > 0 && (
                                                <div className="flex justify-between items-start text-sm">
                                                    <span className="text-gray-500 text-xs font-bold">æœ€é«˜è¼‰å®¢è·¯æ®µ (Max Segment)</span>
                                                    <div className="text-right">
                                                        {analysisData.maxOccSegments.map((seg, idx) => (
                                                            <div key={idx} className="font-bold text-purple-700">
                                                                {seg.from} - {seg.to} æ®µ
                                                            </div>
                                                        ))}
                                                        <div className="text-xs text-purple-500">å…± {analysisData.maxOccVal} äºº</div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                                
                                <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-white border-b">
                                        <tr>
                                            <th className="p-2 text-left text-blue-600 text-xs w-12 font-bold whitespace-nowrap">æ™‚é–“</th>
                                            <th className="p-2 text-left text-gray-500 text-xs font-bold whitespace-nowrap">ç«™å</th>
                                            <th className="p-2 text-center text-green-600 text-xs w-8 font-bold whitespace-nowrap">ä¸Š</th>
                                            <th className="p-2 text-center text-red-600 text-xs w-8 font-bold whitespace-nowrap">è½</th>
                                            <th className="p-2 text-right text-gray-800 text-xs w-10 font-bold whitespace-nowrap">è»Šä¸Š</th>
                                            {includeNotesInReport && <th className="p-2 text-left text-yellow-600 text-xs font-bold whitespace-nowrap">å‚™è¨»</th>}
                                            <th className="p-2 w-8"></th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100 bg-white">
                                        {history.map((record, idx) => {
                                            if (record.isSeparator) {
                                                return (
                                                    <tr key={idx} className="bg-gray-100">
                                                        <td colSpan={includeNotesInReport ? 7 : 6} className="p-2 text-center text-xs font-bold text-slate-500 uppercase tracking-widest">--- ç¹¼çºŒè¡Œç¨‹ / è½‰é  ---</td>
                                                    </tr>
                                                );
                                            }
                                            // Highlight analysis rows if enabled
                                            const isMaxOn = includeAnalysis && analysisData && analysisData.maxOnStops.some(s => s.stopName === record.stopName) && analysisData.maxOnVal === record.on && record.on > 0;
                                            const isMaxOcc = includeAnalysis && analysisData && analysisData.maxOccSegments.some(s => s.from === cleanStopName(record.stopName)) && analysisData.maxOccVal === record.occupancy && record.occupancy > 0;
                                            
                                            let rowClass = "hover:bg-gray-50 group";
                                            if (isMaxOn || isMaxOcc) rowClass += " bg-purple-50/30";

                                            return (
                                            <tr key={idx} className={rowClass}>
                                                <td className="p-2 text-left font-mono text-blue-600 font-medium text-xs whitespace-nowrap">{record.arrivalTime !== '-' ? record.arrivalTime : '--:--'}</td>
                                                <td className="p-2">
                                                    <div className="font-medium text-gray-800 text-xs min-w-[80px]">{cleanStopName(record.stopName)}</div>
                                                    {(isMaxOn || isMaxOcc) && (
                                                        <div className="flex gap-1 mt-0.5">
                                                            {isMaxOn && <span className="text-[9px] bg-green-100 text-green-700 px-1 rounded">Maxä¸Š</span>}
                                                            {isMaxOcc && <span className="text-[9px] bg-purple-100 text-purple-700 px-1 rounded">Maxè¼‰</span>}
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="p-2 text-center font-bold text-green-600 text-xs">+{record.on}</td>
                                                <td className="p-2 text-center font-bold text-red-500 text-xs">-{record.off}</td>
                                                <td className="p-2 text-right font-bold text-gray-900 text-xs"><span className={record.occupancy < 0 ? 'text-red-500' : ''}>{record.occupancy < 0 ? `(${record.occupancy})` : record.occupancy}</span></td>
                                                {includeNotesInReport && <td className="p-2 text-xs text-gray-500 italic max-w-[100px] truncate">{record.note}</td>}
                                                <td className="p-2 text-right"><button onClick={() => openHistoryEdit(idx)} className="text-gray-300 hover:text-blue-600 p-1"><Edit3 className="w-4 h-4" /></button></td>
                                            </tr>
                                        )})}
                                        {history.length === 0 && <tr><td colSpan={includeNotesInReport ? 7 : 6} className="p-8 text-center text-gray-400 text-xs">æš«ç„¡è¨˜éŒ„</td></tr>}
                                    </tbody>
                                </table>
                                </div>
                            </div>
                        </div>

                        {/* åº•éƒ¨æŒ‰éˆ•å€åŸŸ */}
                        <div className="p-4 bg-white border-t pb-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] space-y-3">
                            <div className="grid grid-cols-2 gap-3">
                                <button 
                                    onClick={copyReport} 
                                    className={`w-full py-4 rounded-xl text-lg font-bold flex items-center justify-center gap-2 transition-all shadow-md active:scale-[0.98] ${copied ? 'bg-green-600 text-white' : 'bg-blue-600 text-white'}`}
                                >
                                    {copied ? <><Check className="w-5 h-5"/> å·²è¤‡è£½</> : <><Copy className="w-5 h-5"/> è¤‡è£½å ±å‘Š</>}
                                </button>
                                <button 
                                    onClick={exportToExcel} 
                                    className="w-full py-4 rounded-xl text-lg font-bold flex items-center justify-center gap-2 transition-all shadow-md active:scale-[0.98] bg-emerald-600 text-white hover:bg-emerald-700"
                                >
                                    <FileSpreadsheet className="w-5 h-5"/> åŒ¯å‡º Excel
                                </button>
                            </div>
                            
                            <button 
                                onClick={handleFinishAndReset} 
                                className="w-full py-4 rounded-xl text-lg font-bold flex items-center justify-center gap-2 bg-slate-800 text-white shadow-md active:scale-[0.98] border border-slate-700"
                            >
                                <CheckCircle2 className="w-5 h-5 text-green-400" /> å®Œæˆè¡Œç¨‹ä¸¦é‡ç½®
                            </button>
                        </div>
                    </div>
                );
            }

            // ... (Negative Correction Modal)
            if (showNegativeCorrection) {
                return (
                    <div className="absolute inset-0 z-[60] bg-black/70 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                        <div className="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
                            <div className="flex flex-col items-center text-center mb-6">
                                <div className="w-14 h-14 bg-yellow-100 rounded-full flex items-center justify-center mb-3">
                                    <AlertTriangle className="w-7 h-7 text-yellow-600" />
                                </div>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">åµæ¸¬åˆ°æ•¸æ“šé€æ”¯ (è² æ•¸)</h3>
                                <p className="text-sm text-slate-600">è¡Œç¨‹ä¸­è»Šä¸Šäººæ•¸æœ€ä½é»ç‚º **{negativeDeficit}** äºº (è² æ•¸)ã€‚</p>
                                <p className="text-sm text-slate-600 mt-2">å»ºè­°å°‡ **{Math.abs(negativeDeficit)}** äººåŠ å…¥åˆ° **åˆå§‹äººæ•¸** ä¸­ ({initialPassengers} â†’ {initialPassengers + Math.abs(negativeDeficit)})ã€‚</p>
                            </div>
                            <div className="space-y-3">
                                <button onClick={handleCorrection} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-md flex items-center justify-center gap-2"><Check className="w-5 h-5"/> ç¢ºèªä¿®æ­£ä¸¦ç”¢ç”Ÿå ±å‘Š</button>
                                <button onClick={() => { setShowNegativeCorrection(false); setShowReport(true); }} className="w-full py-3 bg-gray-100 rounded-xl font-bold text-gray-600 hover:bg-gray-200 flex items-center justify-center gap-2"><X className="w-5 h-5"/> ä¸ä¿®æ­£</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- NOTE INPUT MODAL ---
            const renderNoteInputModal = () => {
                if (!showNoteInput) return null;
                return (
                    <div className="absolute inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                        <div className="bg-white rounded-xl p-6 w-full max-w-xs shadow-2xl">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    <StickyNote className="w-5 h-5 text-yellow-500" /> ç«™é»å‚™è¨»
                                </h3>
                                <button onClick={() => setShowNoteInput(false)} className="text-gray-400 hover:text-gray-600"><X className="w-5 h-5"/></button>
                            </div>
                            <div className="mb-4">
                                <p className="text-xs text-gray-500 mb-2">è«‹è¼¸å…¥ç•¶å‰ç«™é»çš„å‚™è¨» (ä¾‹å¦‚: å®¢æ»¿, é£›ç«™)</p>
                                <textarea 
                                    className="w-full border-2 border-slate-200 rounded-xl p-3 text-lg text-slate-800 outline-none focus:border-yellow-400 h-24 resize-none bg-yellow-50"
                                    placeholder="åœ¨æ­¤è¼¸å…¥å‚™è¨»..."
                                    value={currentNote}
                                    onChange={(e) => setCurrentNote(e.target.value)}
                                    autoFocus
                                ></textarea>
                            </div>
                            <button onClick={() => setShowNoteInput(false)} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-md">å„²å­˜ä¸¦é—œé–‰</button>
                        </div>
                    </div>
                );
            }

            // Main Render
            return (
                <div className="flex flex-col h-screen bg-slate-100 font-sans text-gray-900 overflow-hidden relative">
                    {/* Render Modals */}
                    {renderNoteInputModal()}
                    
                    {/* Reset Confirm */}
                    {showResetConfirm && (
                        <div className="absolute inset-0 z-[60] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white rounded-xl p-6 w-full max-w-xs shadow-2xl">
                                <div className="flex flex-col items-center text-center mb-4">
                                    <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-3"><AlertTriangle className="w-6 h-6 text-red-600" /></div>
                                    <h3 className="text-lg font-bold text-slate-800">ç¢ºèªé‡æ–°é–‹å§‹?</h3>
                                </div>
                                <div className="text-sm text-gray-500 mb-4 text-center">é€™å°‡æœƒæ¸…é™¤ç•¶å‰é€²åº¦ (Session) ä¸¦è¿”å›åˆå§‹ç‹€æ…‹ã€‚</div>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setShowResetConfirm(false)} className="py-3 bg-gray-100 rounded-xl font-bold text-gray-600">å–æ¶ˆ</button>
                                    <button onClick={performHardReset} className="py-3 bg-red-600 text-white rounded-xl font-bold">ç¢ºèªé‡ç½®</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {showTripSettings && (
                        <div className="absolute inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white rounded-xl p-5 w-full max-w-sm shadow-2xl">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold flex items-center gap-2 text-slate-800"><Settings className="w-5 h-5" /> è¡Œç¨‹è³‡æ–™è¨­å®š</h3>
                                    <button onClick={() => setShowTripSettings(false)} className="text-sm text-blue-600 font-bold">é—œé–‰</button>
                                </div>
                                <div className="space-y-4 mb-6">
                                    <div><label className="text-xs font-bold text-gray-500 uppercase mb-1 block">è»Šç‰Œ</label><input type="text" className="w-full bg-slate-50 border border-slate-300 rounded-lg py-2 pl-3" value={tripInfo.plate} onChange={(e) => setTripInfo({...tripInfo, plate: e.target.value.toUpperCase()})} /></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-xs font-bold text-gray-500 uppercase mb-1 block">è»Šé•·ç·¨è™Ÿ</label><input type="text" className="w-full bg-slate-50 border border-slate-300 rounded-lg py-2 pl-3" value={tripInfo.captainId} onChange={(e) => setTripInfo({...tripInfo, captainId: e.target.value})} /></div>
                                        <div><label className="text-xs font-bold text-gray-500 uppercase mb-1 block">è»Šé•·å§“æ°</label><input type="text" className="w-full bg-slate-50 border border-slate-300 rounded-lg py-2 pl-3" value={tripInfo.captainName} onChange={(e) => setTripInfo({...tripInfo, captainName: e.target.value})} /></div>
                                    </div>
                                </div>
                                <button onClick={() => setShowTripSettings(false)} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">ç¢ºèªä¸¦å„²å­˜</button>
                            </div>
                        </div>
                    )}

                    {/* Manual Input Modal */}
                    {editingValue && (
                        <div className="absolute inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white rounded-xl p-6 w-full max-w-xs shadow-2xl">
                                {editingValue === 'initial' ? (
                                    <div className="mb-4">
                                        <div className="flex bg-gray-100 p-1 rounded-lg mb-4">
                                            <button 
                                                onClick={() => { setManualInputMode('direct_base'); setManualInputValue(initialPassengers.toString()); }}
                                                className={`flex-1 py-2 text-xs font-bold rounded-md transition-all ${manualInputMode === 'direct_base' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}
                                            >
                                                ä¿®æ”¹åˆå§‹å€¼
                                            </button>
                                            <button 
                                                onClick={() => { setManualInputMode('calibrate_current'); setManualInputValue(totalPassengers.toString()); }}
                                                className={`flex-1 py-2 text-xs font-bold rounded-md transition-all ${manualInputMode === 'calibrate_current' ? 'bg-white shadow text-purple-600' : 'text-gray-500'}`}
                                            >
                                                æ ¡æº–ç•¶å‰äººæ•¸
                                            </button>
                                        </div>
                                        <h3 className="text-lg font-bold text-center text-slate-700">
                                            {manualInputMode === 'direct_base' ? 'è¨­å®šåˆå§‹äººæ•¸ (Base)' : 'è¼¸å…¥ç•¶å‰å¯¦éš›äººæ•¸'}
                                        </h3>
                                    </div>
                                ) : (
                                    <h3 className="text-lg font-bold mb-4 text-center text-slate-700">
                                        {editingValue === 'on' ? 'ä¿®æ­£ä¸Šè»Šäººæ•¸' : 'ä¿®æ­£è½è»Šäººæ•¸'}
                                    </h3>
                                )}
                                
                                <input type="number" pattern="\d*" inputMode="numeric" value={manualInputValue} onChange={(e) => setManualInputValue(e.target.value)} className={`w-full text-center text-5xl font-bold border-b-4 focus:outline-none mb-8 py-2 bg-transparent text-slate-800 ${manualInputMode === 'calibrate_current' && editingValue === 'initial' ? 'border-purple-500 text-purple-700' : 'border-blue-500'}`} autoFocus />
                                
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setEditingValue(null)} className="py-3 bg-gray-100 rounded-xl font-bold text-gray-600">å–æ¶ˆ</button>
                                    <button onClick={saveManualInput} className={`py-3 text-white rounded-xl font-bold ${manualInputMode === 'calibrate_current' && editingValue === 'initial' ? 'bg-purple-600' : 'bg-blue-600'}`}>ç¢ºèª</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Stop Selector */}
                    {showStopSelector && (
                        <div className="absolute inset-0 z-50 bg-white flex flex-col animate-in slide-in-from-bottom-10">
                            <div className="p-4 border-b bg-slate-50 flex justify-between items-center shadow-sm z-10">
                                <h3 className="font-bold text-lg flex items-center gap-2"><MapPin className="w-5 h-5 text-blue-600"/> é¸æ“‡ç«™é»</h3>
                                <button onClick={() => setShowStopSelector(false)} className="text-blue-600 font-bold px-2 py-1 rounded">é—œé–‰</button>
                            </div>
                            <div className="flex-1 overflow-y-auto bg-gray-50">
                                {routeStops.length > 0 ? (
                                    routeStops.map((stop, idx) => (
                                        <button key={idx} onClick={() => jumpToStop(idx)} className={`w-full text-left p-4 border-b flex items-center gap-3 bg-white hover:bg-blue-50 ${idx === currentStopIndex ? 'bg-blue-50 border-l-4 border-blue-600' : ''}`}>
                                            <span className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${idx === currentStopIndex ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-600'}`}>{idx + 1}</span>
                                            <span className={`font-bold text-lg ${idx === currentStopIndex ? 'text-blue-700' : 'text-gray-800'}`}>{stop.name}</span>
                                        </button>
                                    ))
                                ) : (
                                    <div className="p-10 text-center text-gray-400 flex flex-col items-center gap-2"><Search className="w-10 h-10 opacity-20" /><span>è«‹å…ˆæœå°‹ä¸¦é¸æ“‡è·¯ç·š</span></div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <header className="bg-slate-800 text-white p-3 shadow-md flex-none z-20">
                        <div className="flex justify-between items-start mb-3 gap-2">
                            <div className="flex-1 flex gap-2">
                                <button onClick={toggleCompany} className={`px-2 rounded font-bold text-xs flex items-center justify-center min-w-[50px] border shadow-sm active:scale-95 ${getCompanyColor(company)}`}>{company === 'KMB' ? 'ä¹å·´' : company === 'CTB' ? 'åŸå·´' : 'å¶¼å·´'}</button>
                                <div className="relative flex-1">
                                    <input type="text" placeholder="è·¯ç·š (å¦‚ 1A)" value={routeNumber} onChange={(e) => setRouteNumber(e.target.value)} className="bg-slate-700 text-white pl-3 pr-2 py-2 rounded w-full text-sm border border-slate-600 focus:outline-none focus:border-blue-400 uppercase font-bold" />
                                </div>
                                <button onClick={searchRoute} disabled={isLoading || !routeNumber} className="bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white px-3 rounded flex items-center justify-center shadow-md active:scale-95">{isLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <Search className="w-5 h-5" />}</button>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowStats(true)} className="p-2 bg-slate-700 hover:bg-slate-600 text-slate-200 hover:text-purple-300 rounded-lg border border-slate-600"><BarChart3 className="w-5 h-5" /></button>
                                <button onClick={() => setShowTripSettings(true)} className="p-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg border border-slate-600"><Settings className="w-5 h-5" /></button>
                                <button onClick={openResetConfirm} className="p-2 text-slate-400 hover:text-white bg-slate-700/50 rounded-full"><RotateCcw className="w-5 h-5" /></button>
                                <button onClick={handleShowReport} className="bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1 shadow-md active:scale-95"><FileText className="w-5 h-5" /></button>
                            </div>
                        </div>
                        
                        {/* Variant Selector */}
                        {showVariantSelector && (
                            <div className="absolute top-16 left-2 right-2 bg-white rounded-xl shadow-2xl border border-slate-200 p-0 z-50 max-h-[60vh] overflow-y-auto">
                                <div className="px-4 py-3 bg-slate-50 border-b text-xs font-bold text-slate-500 flex justify-between items-center sticky top-0"><span>è«‹é¸æ“‡è·¯ç·šæ–¹å‘:</span><button onClick={() => setShowVariantSelector(false)} className="text-blue-600">é—œé–‰</button></div>
                                {variants.map((v, idx) => (
                                    <button key={idx} onClick={() => selectVariant(v)} className="w-full text-left p-4 border-b last:border-0 hover:bg-blue-50 active:bg-blue-100 transition-colors">
                                        <div className="flex items-center gap-3">
                                            <span className={`text-xs px-2 py-1 rounded font-bold shadow-sm ${getCompanyColor(v.company).replace(/border-\w+/, '').replace(/text-\w+/, '')}`.trim()}>{v.route}</span>
                                            <div className="flex-1"><div className="text-sm font-bold text-slate-800">{v.description}</div><div className="text-xs text-slate-500 mt-0.5">{v.subDescription}</div></div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        )}

                        <div className="bg-slate-700 rounded-xl p-3 flex justify-between items-center border border-slate-600 relative overflow-hidden shadow-inner">
                            <div className="flex-1 min-w-0 pr-2 cursor-pointer active:opacity-80" onClick={() => setShowStopSelector(true)}>
                                <div className="text-slate-400 text-[10px] mb-0.5 uppercase font-bold flex items-center gap-1">Current Stop <List className="w-3 h-3" /></div>
                                <div className="flex items-center gap-2">
                                    <div className={`min-w-[1.8rem] h-7 rounded flex items-center justify-center font-bold text-sm shadow-sm px-1 ${getCompanyColor(company).replace(/border-\w+/, '').replace(/text-\w+/, '')}`.trim()}>{currentStopIndex + 1}</div>
                                    <span className="text-white font-bold text-lg truncate leading-tight">{getCurrentStopDisplay()}</span>
                                </div>
                            </div>
                            
                            {/* Note Button */}
                            <div className="px-2 border-r border-slate-600 mr-2">
                                <button 
                                    onClick={() => setShowNoteInput(true)} 
                                    className={`p-2 rounded-lg transition-all active:scale-95 border ${currentNote ? 'bg-yellow-500 text-slate-900 border-yellow-400' : 'bg-slate-600 text-slate-300 border-slate-500 hover:text-white'}`}
                                >
                                    <StickyNote className="w-5 h-5" />
                                </button>
                            </div>

                            <div className="text-right cursor-pointer active:opacity-80" onClick={() => openManualInput('initial')}>
                                <div className="text-[10px] text-slate-400 mb-0.5 flex items-center justify-end gap-1 uppercase font-bold">On Board <Edit3 className="w-3 h-3" /></div>
                                <div className={`text-3xl font-mono font-bold leading-none ${totalPassengers < 0 ? 'text-red-400' : 'text-white'}`}>{totalPassengers}</div>
                            </div>
                        </div>
                    </header>

                    <div className="bg-white border-b px-4 py-2 flex items-center justify-between shadow-sm z-10">
                        <div className="flex items-center gap-2 text-slate-700"><Clock className="w-5 h-5 text-blue-600" /><span className="text-sm font-bold">åˆ°ç«™æ™‚é–“:</span><input type="time" value={arrivalTime} onChange={(e) => setArrivalTime(e.target.value)} className="bg-slate-100 rounded px-2 py-1 text-xl font-mono font-bold text-slate-900 border-b-2 border-transparent focus:border-blue-500 outline-none w-28 text-center" /></div>
                        <button onClick={setArrivalNow} className="bg-blue-100 text-blue-700 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-blue-200 active:scale-95 shadow-sm">ç¾åœ¨</button>
                    </div>

                    <main className="flex-1 flex flex-col p-3 gap-3 overflow-hidden relative bg-slate-100">
                        <div className="flex-1 grid grid-cols-2 gap-3 min-h-0">
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden relative group">
                                <div className="bg-green-50 py-2 text-center border-b border-green-100 px-2"><span className="text-green-700 text-sm font-extrabold uppercase tracking-wide">ä¸Šè»Š Boarding</span></div>
                                <div className="flex-1 flex flex-col items-center justify-center relative">
                                    <button onClick={incrementOn} className="w-full h-full absolute inset-0 active:bg-green-100 transition-colors"></button>
                                    <button onClick={() => openManualInput('on')} className="relative z-10 mb-2"><span className="text-5xl font-bold text-slate-800 font-mono tracking-tighter">{stopOn}</span></button>
                                    <div className="relative z-10 pointer-events-none mb-2"><div className="w-14 h-14 rounded-full bg-green-100 flex items-center justify-center border-2 border-green-200 shadow-sm"><Plus className="w-7 h-7 text-green-600" /></div></div>
                                </div>
                                <button onClick={decrementOn} disabled={stopOn === 0} className="absolute bottom-3 left-3 w-10 h-10 rounded-full bg-slate-100 text-slate-400 border border-slate-200 hover:bg-red-50 hover:text-red-500 flex items-center justify-center z-10 active:scale-90 transition-all disabled:opacity-30"><Minus className="w-5 h-5" /></button>
                            </div>

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden relative group">
                                <div className="bg-red-50 py-2 text-center border-b border-red-100"><span className="text-red-700 text-sm font-extrabold uppercase tracking-wide">è½è»Š Alighting</span></div>
                                <div className="flex-1 flex flex-col items-center justify-center relative">
                                    <button onClick={incrementOff} className="w-full h-full absolute inset-0 active:bg-red-100 transition-colors"></button>
                                    <button onClick={() => openManualInput('off')} className="relative z-10 mb-2"><span className="text-5xl font-bold text-slate-800 font-mono tracking-tighter">{stopOff}</span></button>
                                    <div className="relative z-10 pointer-events-none mb-2"><div className="w-14 h-14 rounded-full bg-red-100 flex items-center justify-center border-2 border-red-200 shadow-sm"><Minus className="w-7 h-7 text-red-600" /></div></div>
                                </div>
                                <button onClick={decrementOff} disabled={stopOff === 0} className="absolute bottom-3 right-3 w-10 h-10 rounded-full bg-slate-100 text-slate-400 border border-slate-200 hover:bg-green-50 hover:text-green-500 flex items-center justify-center z-10 active:scale-90 transition-all disabled:opacity-30"><Minus className="w-5 h-5" /></button>
                            </div>
                        </div>

                        <div className="flex-none pt-1 pb-1">
                            {isLastStop ? (
                                <div className="flex gap-2 h-16">
                                     <button onClick={handleContinueTrip} className="flex-1 bg-amber-500 hover:bg-amber-600 text-white rounded-xl shadow-lg flex flex-col items-center justify-center px-4 active:scale-[0.98] transition-all group border border-amber-600">
                                        <div className="text-[10px] font-bold uppercase tracking-wider mb-0.5 text-amber-100">è½‰é /Loop</div>
                                        <div className="text-lg font-bold flex items-center gap-2"><GitMerge className="w-5 h-5" /> ç¹¼çºŒè¡Œç¨‹åŠåˆä½µ</div>
                                    </button>
                                    <button onClick={handleNextStop} className="flex-1 bg-slate-800 hover:bg-slate-700 text-white rounded-xl shadow-lg flex flex-col items-center justify-center px-4 active:scale-[0.98] transition-all group border border-slate-700">
                                        <div className="text-[10px] font-bold uppercase tracking-wider mb-0.5 text-slate-400">End Trip</div>
                                        <div className="text-lg font-bold flex items-center gap-2">å®Œæˆä¸¦çµæŸ <ChevronRight className="w-5 h-5" /></div>
                                    </button>
                                </div>
                            ) : (
                                <button onClick={handleNextStop} disabled={routeStops.length > 0 && currentStopIndex > routeStops.length} className="w-full bg-slate-800 disabled:bg-slate-600 text-white h-16 rounded-xl shadow-lg flex items-center justify-between px-6 active:scale-[0.98] transition-all hover:bg-slate-700 group border border-slate-700">
                                    <div className="flex flex-col items-start overflow-hidden text-left"><span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Next Action</span><span className="text-lg font-bold text-yellow-400 flex items-center gap-2 truncate">{getNextStopDisplay()}</span></div>
                                    <div className="bg-slate-700 p-2 rounded-full group-hover:bg-slate-600 transition-colors shadow-inner"><ChevronRight className="w-6 h-6 text-white" /></div>
                                </button>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>