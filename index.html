<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bus Counter 巴士客量器</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* iOS Safari prevent bounce */
        body {
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="bg-slate-100 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Plus, Minus, RotateCcw, FileText, ChevronRight, Search, 
            Loader2, AlertCircle, Clock, Edit3, List, Users, Settings, 
            Copy, Check, BusFront, User, Hash, Info, MapPin, AlertTriangle, X, Pencil, Calculator, Timer,
            BarChart3, Trash2, TrendingUp, Calendar, CheckCircle2, StickyNote, Eye, EyeOff
        } from 'lucide-react';

        function App() {
            // --- 核心狀態 (Core State) ---
            const [company, setCompany] = useState('KMB'); // 'KMB', 'CTB', or 'NLB'
            const [routeNumber, setRouteNumber] = useState('');
            const [currentStopIndex, setCurrentStopIndex] = useState(0); 
            
            // 行程資料 (Trip Info)
            const [tripInfo, setTripInfo] = useState({
                plate: '', captainId: '', captainName: ''
            });
            
            // 活躍的路線變體 (Active Variant for Stats)
            const [activeVariant, setActiveVariant] = useState(null);
            // 防止重複記錄同一次行程
            const [tripRecorded, setTripRecorded] = useState(false);
            
            // 人數統計 (Counters)
            const [initialPassengers, setInitialPassengers] = useState(0);
            const [totalPassengers, setTotalPassengers] = useState(0);
            const [stopOn, setStopOn] = useState(0);
            const [stopOff, setStopOff] = useState(0);
            const [arrivalTime, setArrivalTime] = useState('');
            
            // 備註狀態 (Notes) - New Feature
            const [currentNote, setCurrentNote] = useState('');
            const [showNoteInput, setShowNoteInput] = useState(false);
            const [includeNotesInReport, setIncludeNotesInReport] = useState(true);

            // 歷史記錄 (History)
            const [history, setHistory] = useState([]);
            
            // 介面開關 (UI Toggles)
            const [showReport, setShowReport] = useState(false);
            const [showTripSettings, setShowTripSettings] = useState(false);
            const [showStopSelector, setShowStopSelector] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [showNegativeCorrection, setShowNegativeCorrection] = useState(false); 
            const [negativeDeficit, setNegativeDeficit] = useState(0); 
            const [copied, setCopied] = useState(false);
            const [showStats, setShowStats] = useState(false); 
            
            // 報告設定
            const [durationFormat, setDurationFormat] = useState('min'); 

            // 彈出視窗狀態 (Modal State)
            const [editingValue, setEditingValue] = useState(null); 
            const [manualInputMode, setManualInputMode] = useState('direct_base'); 
            const [manualInputValue, setManualInputValue] = useState('');

            // 歷史編輯狀態
            const [editingHistoryIndex, setEditingHistoryIndex] = useState(null);
            const [historyEditValues, setHistoryEditValues] = useState({ on: 0, off: 0, note: '' });

            // --- API 數據狀態 (API Data) ---
            const [isLoading, setIsLoading] = useState(false);
            const [variants, setVariants] = useState([]); 
            const [showVariantSelector, setShowVariantSelector] = useState(false);
            const [routeStops, setRouteStops] = useState([]); 
            const [apiError, setApiError] = useState(null);

            // --- 統計數據狀態 (Stats State) ---
            const [statsData, setStatsData] = useState({ trips: {}, total: 0, lastSaveTime: Date.now() });

            // 用來避免首次渲染時觸發 useEffect 儲存空數據
            const isLoaded = useRef(false);

            // --- Helper Functions ---
            
            const formatTime24 = (date = new Date()) => {
                return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
            };

            const cleanStopName = (name) => {
                if (!name) return '';
                // 移除括號內容
                let cleaned = name.replace(/[\(（]([^\u4e00-\u9fa5]+?)[\)）]/g, '').trim();
                // 移除逗號後內容
                cleaned = cleaned.split(/,|，/)[0];
                return cleaned.trim();
            };

            const calculateDurationMinutes = (startStr, endStr) => {
                if (!startStr || !endStr || startStr === '-' || endStr === '-') return 0;
                const [h1, m1] = startStr.split(':').map(Number);
                const [h2, m2] = endStr.split(':').map(Number);
                
                let minutes = (h2 * 60 + m2) - (h1 * 60 + m1);
                if (minutes < 0) minutes += 24 * 60; // 跨午夜
                return minutes;
            };

            // --- 初始化與自動儲存 (Initialization & Auto-Save) ---

            useEffect(() => {
                // Load Stats
                const savedStats = localStorage.getItem('busCounterStats');
                if (savedStats) {
                    try {
                        let parsed = JSON.parse(savedStats);
                        parsed = checkAndResetStats(parsed);
                        setStatsData(parsed);
                    } catch (e) { console.error("Failed to load stats", e); }
                }

                // Load Current Session
                const savedSession = localStorage.getItem('busCounterCurrentSession');
                if (savedSession) {
                    try {
                        const session = JSON.parse(savedSession);
                        setCompany(session.company || 'KMB');
                        setRouteNumber(session.routeNumber || '');
                        setCurrentStopIndex(session.currentStopIndex || 0);
                        setTripInfo(session.tripInfo || { plate: '', captainId: '', captainName: '' });
                        setActiveVariant(session.activeVariant || null);
                        setTripRecorded(session.tripRecorded || false);
                        setInitialPassengers(session.initialPassengers || 0);
                        setTotalPassengers(session.totalPassengers || 0);
                        setStopOn(session.stopOn || 0);
                        setStopOff(session.stopOff || 0);
                        setArrivalTime(session.arrivalTime || '');
                        setHistory(session.history || []);
                        setRouteStops(session.routeStops || []);
                        setCurrentNote(session.currentNote || ''); // Load note
                        setIncludeNotesInReport(session.includeNotesInReport ?? true);
                    } catch (e) {
                        console.error("Failed to load session", e);
                    }
                }
                isLoaded.current = true;
            }, []);

            useEffect(() => {
                if (!isLoaded.current) return;
                const sessionData = {
                    company, routeNumber, currentStopIndex, tripInfo, activeVariant, tripRecorded,
                    initialPassengers, totalPassengers, stopOn, stopOff, arrivalTime, history, routeStops,
                    currentNote, includeNotesInReport
                };
                localStorage.setItem('busCounterCurrentSession', JSON.stringify(sessionData));
            }, [company, routeNumber, currentStopIndex, tripInfo, activeVariant, tripRecorded, initialPassengers, totalPassengers, stopOn, stopOff, arrivalTime, history, routeStops, currentNote, includeNotesInReport]);


            // --- 統計與清空邏輯 ---

            const checkAndResetStats = (data) => {
                if (!data.lastSaveTime) return data;
                const lastSaveDate = new Date(data.lastSaveTime);
                const now = new Date();
                let resetThreshold = new Date(now.getFullYear(), 0, 1, 2, 0, 0); 
                if (now < resetThreshold) {
                    resetThreshold = new Date(now.getFullYear() - 1, 0, 1, 2, 0, 0);
                }
                if (lastSaveDate < resetThreshold) {
                    const newData = { trips: {}, total: 0, lastSaveTime: Date.now() };
                    localStorage.setItem('busCounterStats', JSON.stringify(newData));
                    return newData;
                }
                return data;
            };

            const saveTripToStats = () => {
                if (tripRecorded || !activeVariant) return; 

                const newData = { ...statsData };
                const key = `${activeVariant.company}-${activeVariant.route}-${activeVariant.description}`;

                if (!newData.trips[key]) {
                    newData.trips[key] = {
                        company: activeVariant.company,
                        route: activeVariant.route,
                        desc: activeVariant.description,
                        count: 0
                    };
                }

                newData.trips[key].count += 1;
                newData.total += 1;
                newData.lastSaveTime = Date.now();

                setStatsData(newData);
                localStorage.setItem('busCounterStats', JSON.stringify(newData));
                setTripRecorded(true); 
            };

            const manualClearStats = () => {
                if (window.confirm('確定要清空所有年度統計資料嗎？此動作無法復原。')) {
                    const empty = { trips: {}, total: 0, lastSaveTime: Date.now() };
                    setStatsData(empty);
                    localStorage.setItem('busCounterStats', JSON.stringify(empty));
                }
            };
            
            // --- 核心演算法 ---

            const recalculateAll = (baseCount, currentHistory = history) => {
                let runningTotal = baseCount;
                const newHistory = currentHistory.map(record => {
                    runningTotal = runningTotal + record.on - record.off;
                    return { ...record, occupancy: runningTotal };
                });
                setHistory(newHistory);
                setInitialPassengers(baseCount);
                const currentLiveTotal = runningTotal + stopOn - stopOff;
                setTotalPassengers(currentLiveTotal);
            };

            const checkForNegativeDeficit = () => {
                const lowestHistoryOccupancy = history.reduce((min, r) => Math.min(min, r.occupancy), Infinity); 
                const overallLowest = Math.min(lowestHistoryOccupancy, totalPassengers);
                return Math.max(0, -overallLowest);
            };
            
            const handleCorrection = () => {
                recalculateAll(initialPassengers + negativeDeficit);
                setNegativeDeficit(0);
                setShowNegativeCorrection(false);
                setShowReport(true);
            };

            const handleShowReport = () => {
                const deficit = checkForNegativeDeficit();
                if (deficit > 0) {
                    setNegativeDeficit(deficit);
                    setShowNegativeCorrection(true);
                } else {
                    setShowReport(true);
                }
            };

            // --- API 功能 ---
            
            const getCompanyColor = (comp) => {
                if (comp === 'KMB') return 'bg-red-600 border-red-700 text-white';
                if (comp === 'CTB') return 'bg-yellow-400 border-yellow-500 text-black';
                if (comp === 'NLB') return 'bg-teal-600 border-teal-700 text-white'; // 嶼巴顏色
                return 'bg-gray-400 border-gray-500 text-white';
            };

            const toggleCompany = () => {
                setCompany(prev => {
                    if (prev === 'KMB') return 'CTB';
                    if (prev === 'CTB') return 'NLB';
                    return 'KMB';
                });
            };

            const searchRoute = async () => {
                if (!routeNumber) return;
                setIsLoading(true);
                setApiError(null);
                setVariants([]);
                setShowVariantSelector(false);
                setActiveVariant(null); 

                try {
                    if (company === 'KMB') {
                        const API_BASE = 'https://data.etabus.gov.hk/v1/transport/kmb';
                        const response = await fetch(`${API_BASE}/route/`);
                        const data = await response.json();
                        
                        if (data.data) {
                            const filteredRoutes = data.data.filter(
                                r => r.route.toUpperCase() === routeNumber.toUpperCase()
                            );

                            if (filteredRoutes.length > 0) {
                                const routeVariants = filteredRoutes.map(r => ({
                                    company: 'KMB',
                                    route: r.route,
                                    bound: r.bound, 
                                    serviceType: r.service_type, 
                                    orig: r.orig_tc,
                                    dest: r.dest_tc,
                                    description: `往 ${r.dest_tc}`,
                                    subDescription: `由 ${r.orig_tc} 開出`,
                                    tag: r.service_type === '1' ? '日常班次' : `特別班次 (${r.service_type})`
                                }));
                                routeVariants.sort((a, b) => a.serviceType - b.serviceType);
                                setVariants(routeVariants);
                                setShowVariantSelector(true);
                            } else {
                                setApiError(`找不到九巴路線 ${routeNumber} 的資料`);
                            }
                        } else {
                            setApiError("九巴 API 連線錯誤");
                        }
                    } else if (company === 'CTB') {
                        const response = await fetch(`https://rt.data.gov.hk/v2/transport/citybus/route/CTB/${routeNumber.toUpperCase()}`);
                        const data = await response.json();
                        if (data.data) {
                            const r = Array.isArray(data.data) ? data.data : [data.data];
                            let ctbVariants = [];
                            r.forEach(routeObj => {
                                ctbVariants.push({
                                    company: 'CTB', route: routeObj.route, dir: 'outbound', orig: routeObj.orig_tc, dest: routeObj.dest_tc,
                                    description: `往 ${routeObj.dest_tc} (去程)`, subDescription: `由 ${routeObj.orig_tc} 開出`, tag: '去程'
                                });
                                ctbVariants.push({
                                    company: 'CTB', route: routeObj.route, dir: 'inbound', orig: routeObj.dest_tc, dest: routeObj.orig_tc,
                                    description: `往 ${routeObj.orig_tc} (回程)`, subDescription: `由 ${routeObj.dest_tc} 開出`, tag: '回程'
                                });
                            });
                            setVariants(ctbVariants);
                            setShowVariantSelector(true);
                        } else {
                            setApiError(`找不到城巴路線 ${routeNumber} 的資料`);
                        }
                    } else if (company === 'NLB') {
                        // --- NLB 嶼巴搜尋邏輯 ---
                        const response = await fetch(`https://rt.data.gov.hk/v2/transport/nlb/route.php?action=list`);
                        const data = await response.json();
                        
                        if (data && data.routes) {
                            const filteredRoutes = data.routes.filter(
                                r => r.routeNo.toUpperCase() === routeNumber.toUpperCase()
                            );

                            if (filteredRoutes.length > 0) {
                                // NLB 的 routeId 通常對應整條線，描述在 routeName_c
                                const nlbVariants = filteredRoutes.map(r => ({
                                    company: 'NLB',
                                    route: r.routeNo,
                                    routeId: r.routeId, // NLB 獨有的 routeId
                                    description: r.routeName_c, // 例如 "梅窩 > 大澳"
                                    subDescription: r.routeName_e, // 例如 "Mui Wo > Tai O"
                                    tag: '嶼巴'
                                }));
                                setVariants(nlbVariants);
                                setShowVariantSelector(true);
                            } else {
                                setApiError(`找不到嶼巴路線 ${routeNumber} 的資料`);
                            }
                        } else {
                            setApiError("嶼巴 API 連線錯誤");
                        }
                    }
                } catch (err) {
                    console.error(err);
                    setApiError("API 連線錯誤 (請檢查網絡)");
                } finally {
                    setIsLoading(false);
                }
            };

            const selectVariant = async (variant) => {
                setIsLoading(true);
                setShowVariantSelector(false);
                setApiError(null);
                setRouteStops([]);
                setActiveVariant(variant); 
                try {
                    if (variant.company === 'KMB') {
                        const direction = variant.bound === 'O' ? 'outbound' : 'inbound';
                        const stopListUrl = `https://data.etabus.gov.hk/v1/transport/kmb/route-stop/${variant.route}/${direction}/${variant.serviceType}`;
                        const stopListRes = await fetch(stopListUrl);
                        const stopListData = await stopListRes.json();
                        if (!stopListData.data || stopListData.data.length === 0) throw new Error("無站點資料");

                        const stopIds = stopListData.data.map(item => ({ id: item.stop, seq: item.seq }));
                        const fullStopsData = await Promise.all(stopIds.map(async (s) => {
                            try {
                                const detailUrl = `https://data.etabus.gov.hk/v1/transport/kmb/stop/${s.id}`;
                                const detailRes = await fetch(detailUrl);
                                const detailData = await detailRes.json();
                                return { seq: s.seq, id: s.id, name: detailData.data.name_tc };
                            } catch { return { seq: s.seq, id: s.id, name: "未知站點" }; }
                        }));
                        fullStopsData.sort((a, b) => parseInt(a.seq) - parseInt(a.seq));
                        setRouteStops(fullStopsData);

                    } else if (variant.company === 'CTB') {
                        const stopListUrl = `https://rt.data.gov.hk/v2/transport/citybus/route-stop/CTB/${variant.route}/${variant.dir}`;
                        const stopListRes = await fetch(stopListUrl);
                        const stopListData = await stopListRes.json();
                        if (!stopListData.data || stopListData.data.length === 0) throw new Error("無站點資料");

                        const stopIds = stopListData.data.map(item => ({ id: item.stop, seq: item.seq }));
                        const fullStopsData = await Promise.all(stopIds.map(async (s) => {
                            try {
                                const detailUrl = `https://rt.data.gov.hk/v2/transport/citybus/stop/${s.id}`;
                                const detailRes = await fetch(detailUrl);
                                const detailData = await detailRes.json();
                                return { seq: s.seq, id: s.id, name: detailData.data.name_tc };
                            } catch { return { seq: s.seq, id: s.id, name: "未知站點" }; }
                        }));
                        fullStopsData.sort((a, b) => parseInt(a.seq) - parseInt(a.seq));
                        setRouteStops(fullStopsData);

                    } else if (variant.company === 'NLB') {
                        // --- NLB 嶼巴站點邏輯 ---
                        const stopListUrl = `https://rt.data.gov.hk/v2/transport/nlb/stop.php?action=list&routeId=${variant.routeId}`;
                        const stopListRes = await fetch(stopListUrl);
                        const stopListData = await stopListRes.json();
                        
                        if (!stopListData.stops || stopListData.stops.length === 0) throw new Error("無站點資料");

                        // NLB API 返回的站點通常已經是列表順序，但有時會包含雙向站點
                        // 由於 NLB API 結構較簡單，我們直接將返回的 stops 列表映射出來
                        const fullStopsData = stopListData.stops.map((s, index) => ({
                            seq: index + 1,
                            id: s.stopId,
                            name: s.stopName_c
                        }));
                        
                        setRouteStops(fullStopsData);
                    }
                    
                    resetCounter();
                    setShowTripSettings(true); 

                } catch (err) { 
                    console.error(err);
                    setApiError(err.message || "加載站點失敗"); 
                } finally { 
                    setIsLoading(false); 
                }
            };

            // --- 邏輯處理 (Logic) ---

            const resetCounter = () => {
                setCurrentStopIndex(0); setInitialPassengers(0); setTotalPassengers(0);
                setStopOn(0); setStopOff(0); setArrivalTime('');
                setHistory([]); setNegativeDeficit(0); setShowNegativeCorrection(false);
                setTripRecorded(false); 
                setCurrentNote(''); // Reset note
            };

            const openResetConfirm = () => setShowResetConfirm(true);

            const performHardReset = () => {
                resetCounter(); 
                setRouteStops([]); 
                setRouteNumber(''); 
                setVariants([]);
                setTripInfo({ plate: '', captainId: '', captainName: '' });
                setActiveVariant(null);
                setApiError(null); 
                setShowReport(false); 
                setShowResetConfirm(false);
                localStorage.removeItem('busCounterCurrentSession');
            };

            const handleFinishAndReset = () => {
                // 1. 如果尚未記錄到年度統計，則記錄
                saveTripToStats();
                // 2. 徹底重置
                performHardReset();
            };

            const setArrivalNow = () => setArrivalTime(formatTime24());

            const jumpToStop = (index) => {
                setCurrentStopIndex(index); setStopOn(0); setStopOff(0); setArrivalTime('');
                setShowStopSelector(false);
                setCurrentNote('');
            };

            const openManualInput = (type) => {
                setEditingValue(type);
                if (type === 'initial') {
                    setManualInputMode('direct_base'); 
                    setManualInputValue(initialPassengers.toString());
                } else if (type === 'on') {
                    setManualInputValue(stopOn.toString());
                } else if (type === 'off') {
                    setManualInputValue(stopOff.toString());
                }
            };

            const saveManualInput = () => {
                const val = parseInt(manualInputValue) || 0;
                
                if (editingValue === 'initial') {
                    if (manualInputMode === 'direct_base') {
                        recalculateAll(val);
                    } else {
                        const currentNetChange = totalPassengers - initialPassengers;
                        const newBase = val - currentNetChange;
                        recalculateAll(newBase);
                    }
                } else if (editingValue === 'on') {
                    const diff = val - stopOn;
                    setStopOn(val);
                    setTotalPassengers(prev => prev + diff);
                } else if (editingValue === 'off') {
                    const diff = val - stopOff;
                    setStopOff(val);
                    setTotalPassengers(prev => prev - diff); 
                }
                setEditingValue(null);
            };

            const openHistoryEdit = (index) => {
                const record = history[index];
                setHistoryEditValues({ on: record.on, off: record.off, note: record.note || '' });
                setEditingHistoryIndex(index);
            };

            const saveHistoryEdit = () => {
                if (editingHistoryIndex === null) return;
                const updatedHistory = [...history];
                updatedHistory[editingHistoryIndex] = {
                    ...updatedHistory[editingHistoryIndex],
                    on: parseInt(historyEditValues.on) || 0,
                    off: parseInt(historyEditValues.off) || 0,
                    note: historyEditValues.note // Save note
                };
                recalculateAll(initialPassengers, updatedHistory);
                setEditingHistoryIndex(null);
            };

            const handleNextStop = () => {
                if (routeStops.length > 0 && currentStopIndex === routeStops.length - 1) {
                    saveTripToStats();
                }

                if (routeStops.length > 0 && currentStopIndex >= routeStops.length) return;
                const currentStopName = routeStops.length > 0 ? routeStops[currentStopIndex]?.name : `第 ${currentStopIndex + 1} 站`;
                const stopData = {
                    stopNumber: currentStopIndex + 1, stopName: currentStopName,
                    arrivalTime: arrivalTime || '-', on: stopOn, off: stopOff,
                    occupancy: totalPassengers, timestamp: formatTime24(),
                    note: currentNote // Add note to history
                };
                setHistory([...history, stopData]);
                setCurrentStopIndex(prev => prev + 1);
                setStopOn(0); setStopOff(0); setArrivalTime('');
                setCurrentNote(''); // Clear note for next stop
            };

            const incrementOn = () => { setStopOn(s => s + 1); setTotalPassengers(t => t + 1); };
            const decrementOn = () => { if (stopOn > 0) { setStopOn(s => s - 1); setTotalPassengers(t => t - 1); }};
            const incrementOff = () => { setStopOff(s => s + 1); setTotalPassengers(t => t - 1); };
            const decrementOff = () => { if (stopOff > 0) { setStopOff(s => s - 1); setTotalPassengers(t => t - 1); }};

            // --- Report Logic ---

            const getTripDuration = () => {
                if (history.length === 0) return 0;
                const start = history[0].arrivalTime;
                const lastRecord = history[history.length - 1];
                let end = lastRecord.arrivalTime;
                if (arrivalTime && currentStopIndex < routeStops.length) {
                    end = arrivalTime; 
                }
                return calculateDurationMinutes(start, end);
            };

            const formatDuration = (mins) => {
                if (durationFormat === 'min') return `${mins} 分鐘`;
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                return h > 0 ? `${h}小時${m}分鐘` : `${m}分鐘`;
            };

            const copyReport = () => {
                if (currentStopIndex >= routeStops.length - 1) {
                    saveTripToStats();
                }

                const duration = getTripDuration();
                
                let text = `巴士客量統計報告\n`;
                text += `================================\n`;
                text += `日期: ${new Date().toLocaleDateString()}\n`;
                text += `路線: ${company} ${routeNumber || '-'}\n`;
                text += `車牌: ${tripInfo.plate || '-'}\n`;
                text += `車長: ${tripInfo.captainId || '-'} ${tripInfo.captainName || ''}\n`;
                text += `總行車時間: ${formatDuration(duration)}\n`;
                text += `初始: ${initialPassengers} 人\n\n`;
                
                // 動態調整標題列
                if (includeNotesInReport) {
                    text += `時間   | 站名          | 上  | 落  | 車上 | 備註\n`;
                    text += `----------------------------------------------------\n`;
                } else {
                    text += `時間   | 站名          | 上  | 落  | 車上\n`;
                    text += `---------------------------------------------\n`;
                }
                
                history.forEach(record => {
                    const timeStr = record.arrivalTime === '-' ? '--:--' : record.arrivalTime;
                    const stopName = cleanStopName(record.stopName);
                    const occupancyDisplay = record.occupancy < 0 ? `(${record.occupancy})` : record.occupancy;
                    
                    let line = `${timeStr.padEnd(6)} | ${stopName.padEnd(12)} | +${record.on.toString().padEnd(2)} | -${record.off.toString().padEnd(2)} | ${occupancyDisplay}`;
                    
                    if (includeNotesInReport) {
                        line += ` | ${record.note || ''}`;
                    }
                    text += line + `\n`;
                });
                
                if (routeStops.length === 0 || currentStopIndex < routeStops.length) {
                    if (stopOn > 0 || stopOff > 0 || arrivalTime || currentNote) {
                        const rawName = routeStops.length > 0 ? routeStops[currentStopIndex]?.name : `第 ${currentStopIndex + 1} 站`;
                        const currName = cleanStopName(rawName);
                        const currTime = arrivalTime || '--:--';
                        const occupancyDisplay = totalPassengers < 0 ? `(${totalPassengers})` : totalPassengers;
                        
                        let line = `${currTime.padEnd(6)} | ${currName.padEnd(12)} | +${stopOn.toString().padEnd(2)} | -${stopOff.toString().padEnd(2)} | ${occupancyDisplay}`;
                        if (includeNotesInReport) {
                            line += ` | ${currentNote || ''}`;
                        }
                        text += line + `\n`;
                    }
                }
                
                const finalDisplay = totalPassengers < 0 ? `(${totalPassengers})` : totalPassengers;
                text += `\n最終車上人數: ${finalDisplay}`;
                text += `\n由 BusCounter 生成`;

                navigator.clipboard.writeText(text).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); })
                    .catch(() => { /* Fallback */ });
            };

            const getCurrentStopDisplay = () => {
                if (routeStops.length > 0) {
                    if (currentStopIndex < routeStops.length) return routeStops[currentStopIndex].name;
                    return "行程結束 (End)";
                }
                return `第 ${currentStopIndex + 1} 站`;
            };

            const getNextStopDisplay = () => {
                if (routeStops.length > 0) {
                    if (currentStopIndex < routeStops.length - 1) return "下一站: " + routeStops[currentStopIndex + 1].name;
                    if (currentStopIndex === routeStops.length - 1) return "總站 (記錄並結束)";
                    return "行程已結束";
                }
                return "前往下一站";
            };

            // --- UI Render ---
            
            const renderHistoryEditModal = () => {
                if (editingHistoryIndex === null) return null;
                const record = history[editingHistoryIndex];
                return (
                    <div className="absolute inset-0 z-[70] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                        <div className="bg-white rounded-xl p-5 w-full max-w-xs shadow-2xl">
                            <h3 className="text-lg font-bold mb-2 text-slate-700 flex items-center gap-2">
                                <Pencil className="w-5 h-5"/> 修正歷史記錄
                            </h3>
                            <p className="text-xs text-slate-500 mb-4 border-b pb-2">站點: {cleanStopName(record.stopName)}</p>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="text-xs font-bold text-green-600 uppercase block mb-1">上車 (On)</label>
                                    <input type="number" value={historyEditValues.on} onChange={(e) => setHistoryEditValues({...historyEditValues, on: e.target.value})} className="w-full border-2 border-green-100 rounded-lg p-2 text-xl font-bold text-center focus:border-green-500 outline-none" />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-red-500 uppercase block mb-1">落車 (Off)</label>
                                    <input type="number" value={historyEditValues.off} onChange={(e) => setHistoryEditValues({...historyEditValues, off: e.target.value})} className="w-full border-2 border-red-100 rounded-lg p-2 text-xl font-bold text-center focus:border-red-500 outline-none" />
                                </div>
                            </div>
                            <div className="mb-4">
                                <label className="text-xs font-bold text-slate-500 uppercase block mb-1">備註 (Note)</label>
                                <input type="text" value={historyEditValues.note} onChange={(e) => setHistoryEditValues({...historyEditValues, note: e.target.value})} className="w-full border-2 border-slate-200 rounded-lg p-2 text-sm text-slate-800 outline-none focus:border-blue-400" placeholder="例如：客滿, 飛站..." />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={() => setEditingHistoryIndex(null)} className="py-2 bg-gray-100 rounded-lg font-bold text-gray-600">取消</button>
                                <button onClick={saveHistoryEdit} className="py-2 bg-blue-600 text-white rounded-lg font-bold shadow-sm">確認修正</button>
                            </div>
                        </div>
                    </div>
                );
            };

            // --- STATS PAGE ---
            if (showStats) {
                const tripKeys = Object.keys(statsData.trips).sort((a, b) => {
                    return statsData.trips[b].count - statsData.trips[a].count;
                });

                return (
                    <div className="flex flex-col h-screen bg-gray-50 font-sans text-gray-900 relative">
                        <header className="bg-white border-b p-4 flex items-center justify-between sticky top-0 z-10 shadow-sm">
                            <h2 className="text-xl font-bold flex items-center gap-2"><BarChart3 className="w-6 h-6 text-purple-600" /> 年度行程統計</h2>
                            <button onClick={() => setShowStats(false)} className="text-purple-600 font-medium">返回</button>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4">
                            <div className="bg-gradient-to-br from-purple-600 to-blue-600 rounded-xl p-6 text-white shadow-md mb-4 relative overflow-hidden">
                                <div className="relative z-10">
                                    <div className="text-sm font-medium opacity-80 mb-1 flex items-center gap-1"><Calendar className="w-4 h-4"/> 年度總行程</div>
                                    <div className="text-5xl font-bold">{statsData.total} <span className="text-lg font-normal opacity-80">次</span></div>
                                    <div className="text-[10px] mt-2 opacity-60">
                                        下次重置: {new Date().getFullYear() + 1}年1月1日 02:00
                                    </div>
                                </div>
                                <TrendingUp className="absolute right-[-20px] bottom-[-20px] w-32 h-32 text-white opacity-10" />
                            </div>

                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                                    <h3 className="font-bold text-gray-700">路線排行榜</h3>
                                    <button onClick={manualClearStats} className="text-red-400 p-1 hover:text-red-600"><Trash2 className="w-4 h-4"/></button>
                                </div>
                                {tripKeys.length === 0 ? (
                                    <div className="p-8 text-center text-gray-400 text-sm">暫無統計數據<br/>完成一次完整行程後將自動記錄</div>
                                ) : (
                                    <ul className="divide-y divide-gray-100">
                                        {tripKeys.map(key => {
                                            const t = statsData.trips[key];
                                            return (
                                                <li key={key} className="p-4 flex items-center justify-between hover:bg-gray-50">
                                                    <div className="flex items-center gap-3">
                                                        <span className={`text-xs w-10 h-6 flex items-center justify-center rounded font-bold ${getCompanyColor(t.company).replace('border', '')}`}>{t.company === 'KMB' ? t.route : t.company === 'NLB' ? 'NLB' : 'CTB'}</span>
                                                        <div>
                                                            <div className="font-bold text-gray-800 flex items-center gap-2">
                                                                {t.route} <span className="text-xs font-normal text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded-full">{t.desc}</span>
                                                            </div>
                                                            <div className="text-xs text-gray-400 mt-0.5">{t.company === 'NLB' ? '嶼巴' : t.company}</div>
                                                        </div>
                                                    </div>
                                                    <div className="font-bold text-xl text-purple-600">{t.count}</div>
                                                </li>
                                            );
                                        })}
                                    </ul>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // --- REPORT PAGE ---
            if (showReport) {
                const duration = getTripDuration();
                return (
                    <div className="flex flex-col h-screen bg-gray-50 font-sans text-gray-900 relative">
                        {renderHistoryEditModal()}
                        <header className="bg-white border-b p-4 flex items-center justify-between sticky top-0 z-10 shadow-sm">
                            <h2 className="text-xl font-bold flex items-center gap-2"><FileText className="w-6 h-6 text-blue-600" /> 統計報告</h2>
                            <div className="flex items-center gap-3">
                                {/* Note Toggle */}
                                <button onClick={() => setIncludeNotesInReport(!includeNotesInReport)} className={`flex items-center gap-1 text-xs font-bold px-2 py-1.5 rounded border transition-colors ${includeNotesInReport ? 'bg-yellow-50 text-yellow-700 border-yellow-200' : 'bg-gray-50 text-gray-400 border-gray-200'}`}>
                                    {includeNotesInReport ? <Eye className="w-3 h-3"/> : <EyeOff className="w-3 h-3"/>}
                                    {includeNotesInReport ? '包含備註' : '隱藏備註'}
                                </button>
                                <button onClick={() => setShowReport(false)} className="text-blue-600 font-medium">返回</button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4">
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-4">
                                <div className="p-4 bg-slate-50 border-b grid grid-cols-2 gap-y-3 text-sm">
                                    <div><span className="text-slate-400 block text-[10px] uppercase font-bold">Route 路線</span><span className="font-bold text-lg">{company} {routeNumber}</span></div>
                                    <div className="text-right"><span className="text-slate-400 block text-[10px] uppercase font-bold">Date 日期</span><span className="font-bold">{new Date().toLocaleDateString()}</span></div>
                                    <div><span className="text-slate-400 block text-[10px] uppercase font-bold">Bus No. 車牌</span><span className="font-bold">{tripInfo.plate || '-'}</span></div>
                                    <div className="text-right"><span className="text-slate-400 block text-[10px] uppercase font-bold">Captain 車長</span><span className="font-bold">{tripInfo.captainId || '-'} {tripInfo.captainName}</span></div>
                                    
                                    <div className="col-span-2 border-t border-slate-200 pt-2 mt-1">
                                        <div className="flex justify-between items-center mb-1">
                                            <span className="text-slate-400 text-[10px] uppercase font-bold flex items-center gap-1"><Timer className="w-3 h-3"/> 行車時間 (Duration)</span>
                                            <div className="flex bg-slate-200 rounded p-0.5">
                                                <button onClick={() => setDurationFormat('min')} className={`text-[10px] px-2 py-0.5 rounded font-bold transition-all ${durationFormat === 'min' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'}`}>分鐘</button>
                                                <button onClick={() => setDurationFormat('hm')} className={`text-[10px] px-2 py-0.5 rounded font-bold transition-all ${durationFormat === 'hm' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'}`}>時:分</button>
                                            </div>
                                        </div>
                                        <div className="font-bold text-xl text-slate-800">{formatDuration(duration)}</div>
                                    </div>

                                    <div className="col-span-2 border-t pt-2 flex justify-between items-center">
                                        <span className="text-slate-500 text-xs">初始人數 (Base):</span>
                                        <span className="font-bold text-lg">{initialPassengers}</span>
                                    </div>
                                </div>
                                
                                <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-white border-b">
                                        <tr>
                                            <th className="p-2 text-left text-blue-600 text-xs w-12 font-bold whitespace-nowrap">時間</th>
                                            <th className="p-2 text-left text-gray-500 text-xs font-bold whitespace-nowrap">站名</th>
                                            <th className="p-2 text-center text-green-600 text-xs w-8 font-bold whitespace-nowrap">上</th>
                                            <th className="p-2 text-center text-red-600 text-xs w-8 font-bold whitespace-nowrap">落</th>
                                            <th className="p-2 text-right text-gray-800 text-xs w-10 font-bold whitespace-nowrap">車上</th>
                                            {includeNotesInReport && <th className="p-2 text-left text-yellow-600 text-xs font-bold whitespace-nowrap">備註</th>}
                                            <th className="p-2 w-8"></th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100 bg-white">
                                        {history.map((record, idx) => (
                                            <tr key={idx} className="hover:bg-gray-50 group">
                                                <td className="p-2 text-left font-mono text-blue-600 font-medium text-xs whitespace-nowrap">{record.arrivalTime !== '-' ? record.arrivalTime : '--:--'}</td>
                                                <td className="p-2"><div className="font-medium text-gray-800 text-xs min-w-[80px]">{cleanStopName(record.stopName)}</div></td>
                                                <td className="p-2 text-center font-bold text-green-600 text-xs">+{record.on}</td>
                                                <td className="p-2 text-center font-bold text-red-500 text-xs">-{record.off}</td>
                                                <td className="p-2 text-right font-bold text-gray-900 text-xs"><span className={record.occupancy < 0 ? 'text-red-500' : ''}>{record.occupancy < 0 ? `(${record.occupancy})` : record.occupancy}</span></td>
                                                {includeNotesInReport && <td className="p-2 text-xs text-gray-500 italic max-w-[100px] truncate">{record.note}</td>}
                                                <td className="p-2 text-right"><button onClick={() => openHistoryEdit(idx)} className="text-gray-300 hover:text-blue-600 p-1"><Edit3 className="w-4 h-4" /></button></td>
                                            </tr>
                                        ))}
                                        {history.length === 0 && <tr><td colSpan={includeNotesInReport ? 7 : 6} className="p-8 text-center text-gray-400 text-xs">暫無記錄</td></tr>}
                                    </tbody>
                                </table>
                                </div>
                            </div>
                        </div>

                        {/* 底部按鈕區域 */}
                        <div className="p-4 bg-white border-t pb-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] space-y-3">
                            <button 
                                onClick={copyReport} 
                                className={`w-full py-4 rounded-xl text-lg font-bold flex items-center justify-center gap-2 transition-all shadow-md active:scale-[0.98] ${copied ? 'bg-green-600 text-white' : 'bg-blue-600 text-white'}`}
                            >
                                {copied ? <><Check className="w-5 h-5"/> 已複製到剪貼簿</> : <><Copy className="w-5 h-5"/> 複製完整報告</>}
                            </button>
                            
                            <button 
                                onClick={handleFinishAndReset} 
                                className="w-full py-4 rounded-xl text-lg font-bold flex items-center justify-center gap-2 bg-slate-800 text-white shadow-md active:scale-[0.98] border border-slate-700"
                            >
                                <CheckCircle2 className="w-5 h-5 text-green-400" /> 完成行程並重置
                            </button>
                        </div>
                    </div>
                );
            }

            // ... (Negative Correction Modal)
            if (showNegativeCorrection) {
                return (
                    <div className="absolute inset-0 z-[60] bg-black/70 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                        <div className="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
                            <div className="flex flex-col items-center text-center mb-6">
                                <div className="w-14 h-14 bg-yellow-100 rounded-full flex items-center justify-center mb-3">
                                    <AlertTriangle className="w-7 h-7 text-yellow-600" />
                                </div>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">偵測到數據透支 (負數)</h3>
                                <p className="text-sm text-slate-600">行程中車上人數最低點為 **{negativeDeficit}** 人 (負數)。</p>
                                <p className="text-sm text-slate-600 mt-2">建議將 **{Math.abs(negativeDeficit)}** 人加入到 **初始人數** 中 ({initialPassengers} → {initialPassengers + Math.abs(negativeDeficit)})。</p>
                            </div>
                            <div className="space-y-3">
                                <button onClick={handleCorrection} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-md flex items-center justify-center gap-2"><Check className="w-5 h-5"/> 確認修正並產生報告</button>
                                <button onClick={() => { setShowNegativeCorrection(false); setShowReport(true); }} className="w-full py-3 bg-gray-100 rounded-xl font-bold text-gray-600 hover:bg-gray-200 flex items-center justify-center gap-2"><X className="w-5 h-5"/> 不修正</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- NOTE INPUT MODAL ---
            const renderNoteInputModal = () => {
                if (!showNoteInput) return null;
                return (
                    <div className="absolute inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                        <div className="bg-white rounded-xl p-6 w-full max-w-xs shadow-2xl">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    <StickyNote className="w-5 h-5 text-yellow-500" /> 站點備註
                                </h3>
                                <button onClick={() => setShowNoteInput(false)} className="text-gray-400 hover:text-gray-600"><X className="w-5 h-5"/></button>
                            </div>
                            <div className="mb-4">
                                <p className="text-xs text-gray-500 mb-2">請輸入當前站點的備註 (例如: 客滿, 飛站)</p>
                                <textarea 
                                    className="w-full border-2 border-slate-200 rounded-xl p-3 text-lg text-slate-800 outline-none focus:border-yellow-400 h-24 resize-none bg-yellow-50"
                                    placeholder="在此輸入備註..."
                                    value={currentNote}
                                    onChange={(e) => setCurrentNote(e.target.value)}
                                    autoFocus
                                ></textarea>
                            </div>
                            <button onClick={() => setShowNoteInput(false)} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-md">儲存並關閉</button>
                        </div>
                    </div>
                );
            }

            // Main Render
            return (
                <div className="flex flex-col h-screen bg-slate-100 font-sans text-gray-900 overflow-hidden relative">
                    {/* Render Modals */}
                    {renderNoteInputModal()}
                    
                    {/* Reset Confirm */}
                    {showResetConfirm && (
                        <div className="absolute inset-0 z-[60] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white rounded-xl p-6 w-full max-w-xs shadow-2xl">
                                <div className="flex flex-col items-center text-center mb-4">
                                    <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-3"><AlertTriangle className="w-6 h-6 text-red-600" /></div>
                                    <h3 className="text-lg font-bold text-slate-800">確認重新開始?</h3>
                                </div>
                                <div className="text-sm text-gray-500 mb-4 text-center">這將會清除當前進度 (Session) 並返回初始狀態。</div>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setShowResetConfirm(false)} className="py-3 bg-gray-100 rounded-xl font-bold text-gray-600">取消</button>
                                    <button onClick={performHardReset} className="py-3 bg-red-600 text-white rounded-xl font-bold">確認重置</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {showTripSettings && (
                        <div className="absolute inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white rounded-xl p-5 w-full max-w-sm shadow-2xl">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold flex items-center gap-2 text-slate-800"><Settings className="w-5 h-5" /> 行程資料設定</h3>
                                    <button onClick={() => setShowTripSettings(false)} className="text-sm text-blue-600 font-bold">關閉</button>
                                </div>
                                <div className="space-y-4 mb-6">
                                    <div><label className="text-xs font-bold text-gray-500 uppercase mb-1 block">車牌</label><input type="text" className="w-full bg-slate-50 border border-slate-300 rounded-lg py-2 pl-3" value={tripInfo.plate} onChange={(e) => setTripInfo({...tripInfo, plate: e.target.value.toUpperCase()})} /></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-xs font-bold text-gray-500 uppercase mb-1 block">車長編號</label><input type="text" className="w-full bg-slate-50 border border-slate-300 rounded-lg py-2 pl-3" value={tripInfo.captainId} onChange={(e) => setTripInfo({...tripInfo, captainId: e.target.value})} /></div>
                                        <div><label className="text-xs font-bold text-gray-500 uppercase mb-1 block">車長姓氏</label><input type="text" className="w-full bg-slate-50 border border-slate-300 rounded-lg py-2 pl-3" value={tripInfo.captainName} onChange={(e) => setTripInfo({...tripInfo, captainName: e.target.value})} /></div>
                                    </div>
                                </div>
                                <button onClick={() => setShowTripSettings(false)} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">確認並儲存</button>
                            </div>
                        </div>
                    )}

                    {/* Manual Input Modal */}
                    {editingValue && (
                        <div className="absolute inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white rounded-xl p-6 w-full max-w-xs shadow-2xl">
                                {editingValue === 'initial' ? (
                                    <div className="mb-4">
                                        <div className="flex bg-gray-100 p-1 rounded-lg mb-4">
                                            <button 
                                                onClick={() => { setManualInputMode('direct_base'); setManualInputValue(initialPassengers.toString()); }}
                                                className={`flex-1 py-2 text-xs font-bold rounded-md transition-all ${manualInputMode === 'direct_base' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}
                                            >
                                                修改初始值
                                            </button>
                                            <button 
                                                onClick={() => { setManualInputMode('calibrate_current'); setManualInputValue(totalPassengers.toString()); }}
                                                className={`flex-1 py-2 text-xs font-bold rounded-md transition-all ${manualInputMode === 'calibrate_current' ? 'bg-white shadow text-purple-600' : 'text-gray-500'}`}
                                            >
                                                校準當前人數
                                            </button>
                                        </div>
                                        <h3 className="text-lg font-bold text-center text-slate-700">
                                            {manualInputMode === 'direct_base' ? '設定初始人數 (Base)' : '輸入當前實際人數'}
                                        </h3>
                                    </div>
                                ) : (
                                    <h3 className="text-lg font-bold mb-4 text-center text-slate-700">
                                        {editingValue === 'on' ? '修正上車人數' : '修正落車人數'}
                                    </h3>
                                )}
                                
                                <input type="number" pattern="\d*" inputMode="numeric" value={manualInputValue} onChange={(e) => setManualInputValue(e.target.value)} className={`w-full text-center text-5xl font-bold border-b-4 focus:outline-none mb-8 py-2 bg-transparent text-slate-800 ${manualInputMode === 'calibrate_current' && editingValue === 'initial' ? 'border-purple-500 text-purple-700' : 'border-blue-500'}`} autoFocus />
                                
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setEditingValue(null)} className="py-3 bg-gray-100 rounded-xl font-bold text-gray-600">取消</button>
                                    <button onClick={saveManualInput} className={`py-3 text-white rounded-xl font-bold ${manualInputMode === 'calibrate_current' && editingValue === 'initial' ? 'bg-purple-600' : 'bg-blue-600'}`}>確認</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Stop Selector */}
                    {showStopSelector && (
                        <div className="absolute inset-0 z-50 bg-white flex flex-col animate-in slide-in-from-bottom-10">
                            <div className="p-4 border-b bg-slate-50 flex justify-between items-center shadow-sm z-10">
                                <h3 className="font-bold text-lg flex items-center gap-2"><MapPin className="w-5 h-5 text-blue-600"/> 選擇站點</h3>
                                <button onClick={() => setShowStopSelector(false)} className="text-blue-600 font-bold px-2 py-1 rounded">關閉</button>
                            </div>
                            <div className="flex-1 overflow-y-auto bg-gray-50">
                                {routeStops.length > 0 ? (
                                    routeStops.map((stop, idx) => (
                                        <button key={idx} onClick={() => jumpToStop(idx)} className={`w-full text-left p-4 border-b flex items-center gap-3 bg-white hover:bg-blue-50 ${idx === currentStopIndex ? 'bg-blue-50 border-l-4 border-blue-600' : ''}`}>
                                            <span className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${idx === currentStopIndex ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-600'}`}>{idx + 1}</span>
                                            <span className={`font-bold text-lg ${idx === currentStopIndex ? 'text-blue-700' : 'text-gray-800'}`}>{stop.name}</span>
                                        </button>
                                    ))
                                ) : (
                                    <div className="p-10 text-center text-gray-400 flex flex-col items-center gap-2"><Search className="w-10 h-10 opacity-20" /><span>請先搜尋並選擇路線</span></div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <header className="bg-slate-800 text-white p-3 shadow-md flex-none z-20">
                        <div className="flex justify-between items-start mb-3 gap-2">
                            <div className="flex-1 flex gap-2">
                                <button onClick={toggleCompany} className={`px-2 rounded font-bold text-xs flex items-center justify-center min-w-[50px] border shadow-sm active:scale-95 ${getCompanyColor(company)}`}>{company === 'KMB' ? '九巴' : company === 'CTB' ? '城巴' : '嶼巴'}</button>
                                <div className="relative flex-1">
                                    <input type="text" placeholder="路線 (如 1A)" value={routeNumber} onChange={(e) => setRouteNumber(e.target.value)} className="bg-slate-700 text-white pl-3 pr-2 py-2 rounded w-full text-sm border border-slate-600 focus:outline-none focus:border-blue-400 uppercase font-bold" />
                                </div>
                                <button onClick={searchRoute} disabled={isLoading || !routeNumber} className="bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white px-3 rounded flex items-center justify-center shadow-md active:scale-95">{isLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <Search className="w-5 h-5" />}</button>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowStats(true)} className="p-2 bg-slate-700 hover:bg-slate-600 text-slate-200 hover:text-purple-300 rounded-lg border border-slate-600"><BarChart3 className="w-5 h-5" /></button>
                                <button onClick={() => setShowTripSettings(true)} className="p-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg border border-slate-600"><Settings className="w-5 h-5" /></button>
                                <button onClick={openResetConfirm} className="p-2 text-slate-400 hover:text-white bg-slate-700/50 rounded-full"><RotateCcw className="w-5 h-5" /></button>
                                <button onClick={handleShowReport} className="bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1 shadow-md active:scale-95"><FileText className="w-5 h-5" /></button>
                            </div>
                        </div>
                        
                        {/* Variant Selector */}
                        {showVariantSelector && (
                            <div className="absolute top-16 left-2 right-2 bg-white rounded-xl shadow-2xl border border-slate-200 p-0 z-50 max-h-[60vh] overflow-y-auto">
                                <div className="px-4 py-3 bg-slate-50 border-b text-xs font-bold text-slate-500 flex justify-between items-center sticky top-0"><span>請選擇路線方向:</span><button onClick={() => setShowVariantSelector(false)} className="text-blue-600">關閉</button></div>
                                {variants.map((v, idx) => (
                                    <button key={idx} onClick={() => selectVariant(v)} className="w-full text-left p-4 border-b last:border-0 hover:bg-blue-50 active:bg-blue-100 transition-colors">
                                        <div className="flex items-center gap-3">
                                            <span className={`text-xs px-2 py-1 rounded font-bold shadow-sm ${getCompanyColor(v.company).replace(/border-\w+/, '').replace(/text-\w+/, '')}`.trim()}>{v.route}</span>
                                            <div className="flex-1"><div className="text-sm font-bold text-slate-800">{v.description}</div><div className="text-xs text-slate-500 mt-0.5">{v.subDescription}</div></div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        )}

                        <div className="bg-slate-700 rounded-xl p-3 flex justify-between items-center border border-slate-600 relative overflow-hidden shadow-inner">
                            <div className="flex-1 min-w-0 pr-2 cursor-pointer active:opacity-80" onClick={() => setShowStopSelector(true)}>
                                <div className="text-slate-400 text-[10px] mb-0.5 uppercase font-bold flex items-center gap-1">Current Stop <List className="w-3 h-3" /></div>
                                <div className="flex items-center gap-2">
                                    <div className={`min-w-[1.8rem] h-7 rounded flex items-center justify-center font-bold text-sm shadow-sm px-1 ${getCompanyColor(company).replace(/border-\w+/, '').replace(/text-\w+/, '')}`.trim()}>{currentStopIndex + 1}</div>
                                    <span className="text-white font-bold text-lg truncate leading-tight">{getCurrentStopDisplay()}</span>
                                </div>
                            </div>
                            
                            {/* NEW: Note Button in the Blue/Slate Area */}
                            <div className="px-2 border-r border-slate-600 mr-2">
                                <button 
                                    onClick={() => setShowNoteInput(true)} 
                                    className={`p-2 rounded-lg transition-all active:scale-95 border ${currentNote ? 'bg-yellow-500 text-slate-900 border-yellow-400' : 'bg-slate-600 text-slate-300 border-slate-500 hover:text-white'}`}
                                >
                                    <StickyNote className="w-5 h-5" />
                                </button>
                            </div>

                            <div className="text-right cursor-pointer active:opacity-80" onClick={() => openManualInput('initial')}>
                                <div className="text-[10px] text-slate-400 mb-0.5 flex items-center justify-end gap-1 uppercase font-bold">On Board <Edit3 className="w-3 h-3" /></div>
                                <div className={`text-3xl font-mono font-bold leading-none ${totalPassengers < 0 ? 'text-red-400' : 'text-white'}`}>{totalPassengers}</div>
                            </div>
                        </div>
                    </header>

                    <div className="bg-white border-b px-4 py-2 flex items-center justify-between shadow-sm z-10">
                        <div className="flex items-center gap-2 text-slate-700"><Clock className="w-5 h-5 text-blue-600" /><span className="text-sm font-bold">到站時間:</span><input type="time" value={arrivalTime} onChange={(e) => setArrivalTime(e.target.value)} className="bg-slate-100 rounded px-2 py-1 text-xl font-mono font-bold text-slate-900 border-b-2 border-transparent focus:border-blue-500 outline-none w-28 text-center" /></div>
                        <button onClick={setArrivalNow} className="bg-blue-100 text-blue-700 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-blue-200 active:scale-95 shadow-sm">現在</button>
                    </div>

                    <main className="flex-1 flex flex-col p-3 gap-3 overflow-hidden relative bg-slate-100">
                        <div className="flex-1 grid grid-cols-2 gap-3 min-h-0">
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden relative group">
                                <div className="bg-green-50 py-2 text-center border-b border-green-100 px-2"><span className="text-green-700 text-sm font-extrabold uppercase tracking-wide">上車 Boarding</span></div>
                                <div className="flex-1 flex flex-col items-center justify-center relative">
                                    <button onClick={incrementOn} className="w-full h-full absolute inset-0 active:bg-green-100 transition-colors"></button>
                                    <button onClick={() => openManualInput('on')} className="relative z-10 mb-2"><span className="text-5xl font-bold text-slate-800 font-mono tracking-tighter">{stopOn}</span></button>
                                    <div className="relative z-10 pointer-events-none mb-2"><div className="w-14 h-14 rounded-full bg-green-100 flex items-center justify-center border-2 border-green-200 shadow-sm"><Plus className="w-7 h-7 text-green-600" /></div></div>
                                </div>
                                <button onClick={decrementOn} disabled={stopOn === 0} className="absolute bottom-3 left-3 w-10 h-10 rounded-full bg-slate-100 text-slate-400 border border-slate-200 hover:bg-red-50 hover:text-red-500 flex items-center justify-center z-10 active:scale-90 transition-all disabled:opacity-30"><Minus className="w-5 h-5" /></button>
                            </div>

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden relative group">
                                <div className="bg-red-50 py-2 text-center border-b border-red-100"><span className="text-red-700 text-sm font-extrabold uppercase tracking-wide">落車 Alighting</span></div>
                                <div className="flex-1 flex flex-col items-center justify-center relative">
                                    <button onClick={incrementOff} className="w-full h-full absolute inset-0 active:bg-red-100 transition-colors"></button>
                                    <button onClick={() => openManualInput('off')} className="relative z-10 mb-2"><span className="text-5xl font-bold text-slate-800 font-mono tracking-tighter">{stopOff}</span></button>
                                    <div className="relative z-10 pointer-events-none mb-2"><div className="w-14 h-14 rounded-full bg-red-100 flex items-center justify-center border-2 border-red-200 shadow-sm"><Minus className="w-7 h-7 text-red-600" /></div></div>
                                </div>
                                <button onClick={decrementOff} disabled={stopOff === 0} className="absolute bottom-3 right-3 w-10 h-10 rounded-full bg-slate-100 text-slate-400 border border-slate-200 hover:bg-green-50 hover:text-green-500 flex items-center justify-center z-10 active:scale-90 transition-all disabled:opacity-30"><Minus className="w-5 h-5" /></button>
                            </div>
                        </div>

                        <div className="flex-none pt-1 pb-1">
                            <button onClick={handleNextStop} disabled={routeStops.length > 0 && currentStopIndex > routeStops.length} className="w-full bg-slate-800 disabled:bg-slate-600 text-white h-16 rounded-xl shadow-lg flex items-center justify-between px-6 active:scale-[0.98] transition-all hover:bg-slate-700 group">
                                <div className="flex flex-col items-start overflow-hidden text-left"><span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Next Action</span><span className="text-lg font-bold text-yellow-400 flex items-center gap-2 truncate">{getNextStopDisplay()}</span></div>
                                <div className="bg-slate-700 p-2 rounded-full group-hover:bg-slate-600 transition-colors shadow-inner"><ChevronRight className="w-6 h-6 text-white" /></div>
                            </button>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>