<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> Â∑¥Â£´ÂÆ¢ÈáèÁµ±Ë®à </title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS (XLSX) for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- React & ReactDOM -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* iOS Safari prevent bounce */
        body {
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="bg-slate-100 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Plus, Minus, RotateCcw, FileText, ChevronRight, ChevronLeft, Search, 
            Loader2, AlertCircle, Clock, Edit3, List, Users, Settings, 
            Copy, Check, BusFront, User, Hash, Info, MapPin, AlertTriangle, X, Pencil, Calculator, Timer,
            BarChart3, Trash2, TrendingUp, Calendar, CheckCircle2, StickyNote, Eye, EyeOff, GitMerge, FileSpreadsheet, Lightbulb, UserPlus, ArrowDownToLine, StopCircle, MessageSquare
        } from 'lucide-react';

        function App() {
            // --- Ê†∏ÂøÉÁãÄÊÖã (Core State) ---
            const [company, setCompany] = useState('KMB');
            const [routeNumber, setRouteNumber] = useState('');
            const [currentStopIndex, setCurrentStopIndex] = useState(0); 
            
            // Ë°åÁ®ãË≥áÊñô (Trip Info)
            const [tripInfo, setTripInfo] = useState({
                plate: '', captainId: '', captainName: ''
            });
            
            // Ê¥ªË∫çÁöÑË∑ØÁ∑öËÆäÈ´î
            const [activeVariant, setActiveVariant] = useState(null);
            const [tripRecorded, setTripRecorded] = useState(false);
            
            // ‰∫∫Êï∏Áµ±Ë®à (Counters)
            const [initialPassengers, setInitialPassengers] = useState(0);
            const [totalPassengers, setTotalPassengers] = useState(0);
            const [stopOn, setStopOn] = useState(0);
            const [stopOff, setStopOff] = useState(0);
            const [arrivalTime, setArrivalTime] = useState('');
            
            // ÂÇôË®ªËàáÈÅ∏È†Ö
            const [currentNote, setCurrentNote] = useState('');
            const [showNoteInput, setShowNoteInput] = useState(false);
            const [includeNotesInReport, setIncludeNotesInReport] = useState(true);
            const [includeAnalysis, setIncludeAnalysis] = useState(true);
            const [showTotalPatronage, setShowTotalPatronage] = useState(true); 
            const [statsTab, setStatsTab] = useState('monthly');

            // Ê≠∑Âè≤Ë®òÈåÑ
            const [history, setHistory] = useState([]);
            
            // ‰ªãÈù¢ÈñãÈóú
            const [showReport, setShowReport] = useState(false);
            const [showTripSettings, setShowTripSettings] = useState(false);
            const [showStopSelector, setShowStopSelector] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [showNegativeCorrection, setShowNegativeCorrection] = useState(false); 
            const [negativeDeficit, setNegativeDeficit] = useState(0); 
            const [copied, setCopied] = useState(false);
            const [showStats, setShowStats] = useState(false); 
            
            // Â†±ÂëäË®≠ÂÆö
            const [durationFormat, setDurationFormat] = useState('min'); 

            // ÂΩàÂá∫Ë¶ñÁ™óÁãÄÊÖã
            const [editingValue, setEditingValue] = useState(null); 
            const [manualInputMode, setManualInputMode] = useState('direct_base'); 
            const [manualInputValue, setManualInputValue] = useState('');

            // Ê≠∑Âè≤Á∑®ËºØÁãÄÊÖã
            const [editingHistoryIndex, setEditingHistoryIndex] = useState(null);
            const [historyEditValues, setHistoryEditValues] = useState({ on: 0, off: 0, note: '', time: '' });

            // --- API Êï∏Êìö ---
            const [isLoading, setIsLoading] = useState(false);
            const [variants, setVariants] = useState([]); 
            const [showVariantSelector, setShowVariantSelector] = useState(false);
            const [routeStops, setRouteStops] = useState([]); 
            const [apiError, setApiError] = useState(null);

            // --- Áµ±Ë®àÊï∏Êìö (Stats State) ---
            const [statsData, setStatsData] = useState({ 
                yearly: { trips: {}, total: 0 }, 
                monthly: { trips: {}, total: 0 },
                lastSaveTime: Date.now() 
            });

            const isLoaded = useRef(false);

            // --- Helper Functions ---
            
            const formatTime24 = (date = new Date()) => {
                return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
            };

            const cleanStopName = (name) => {
                if (!name) return '';
                let cleaned = name.replace(/[\(Ôºà]([^\u4e00-\u9fa5]+?)[\)Ôºâ]/g, '').trim();
                cleaned = cleaned.split(/,|Ôºå/)[0];
                return cleaned.trim();
            };

            const calculateDurationMinutes = (startStr, endStr) => {
                if (!startStr || !endStr || startStr === '-' || endStr === '-') return 0;
                const [h1, m1] = startStr.split(':').map(Number);
                const [h2, m2] = endStr.split(':').map(Number);
                
                let minutes = (h2 * 60 + m2) - (h1 * 60 + m1);
                if (minutes < 0) minutes += 24 * 60; // Ë∑®ÂçàÂ§ú
                return minutes;
            };

            // --- ÂàùÂßãÂåñËàáËá™ÂãïÂÑ≤Â≠ò ---

            useEffect(() => {
                const savedStats = localStorage.getItem('busCounterStats');
                if (savedStats) {
                    try {
                        let parsed = JSON.parse(savedStats);
                        parsed = checkAndResetStats(parsed);
                        setStatsData(parsed);
                    } catch (e) { console.error("Failed to load stats", e); }
                }

                const savedSession = localStorage.getItem('busCounterCurrentSession');
                if (savedSession) {
                    try {
                        const session = JSON.parse(savedSession);
                        setCompany(session.company || 'KMB');
                        setRouteNumber(session.routeNumber || '');
                        setCurrentStopIndex(session.currentStopIndex || 0);
                        setTripInfo(session.tripInfo || { plate: '', captainId: '', captainName: '' });
                        setActiveVariant(session.activeVariant || null);
                        setTripRecorded(session.tripRecorded || false);
                        setInitialPassengers(session.initialPassengers || 0);
                        setTotalPassengers(session.totalPassengers || 0);
                        setStopOn(session.stopOn || 0);
                        setStopOff(session.stopOff || 0);
                        setArrivalTime(session.arrivalTime || '');
                        setHistory(session.history || []);
                        setRouteStops(session.routeStops || []);
                        setCurrentNote(session.currentNote || '');
                        setIncludeNotesInReport(session.includeNotesInReport ?? true);
                        setIncludeAnalysis(session.includeAnalysis ?? true);
                        setShowTotalPatronage(session.showTotalPatronage ?? true);
                        setStatsTab(session.statsTab || 'monthly');
                    } catch (e) {
                        console.error("Failed to load session", e);
                    }
                }
                isLoaded.current = true;
            }, []);

            useEffect(() => {
                if (!isLoaded.current) return;
                const sessionData = {
                    company, routeNumber, currentStopIndex, tripInfo, activeVariant, tripRecorded,
                    initialPassengers, totalPassengers, stopOn, stopOff, arrivalTime, history, routeStops,
                    currentNote, includeNotesInReport, includeAnalysis, showTotalPatronage, statsTab
                };
                localStorage.setItem('busCounterCurrentSession', JSON.stringify(sessionData));
            }, [company, routeNumber, currentStopIndex, tripInfo, activeVariant, tripRecorded, initialPassengers, totalPassengers, stopOn, stopOff, arrivalTime, history, routeStops, currentNote, includeNotesInReport, includeAnalysis, showTotalPatronage, statsTab]);


            // --- Áµ±Ë®àËàáÊ∏ÖÁ©∫ÈÇèËºØ ---

            const checkAndResetStats = (data) => {
                if (!data.lastSaveTime) return data;
                
                if (!data.yearly) {
                    data = { 
                        yearly: { trips: data.trips || {}, total: data.total || 0 }, 
                        monthly: { trips: {}, total: 0 },
                        lastSaveTime: data.lastSaveTime
                    };
                }

                const lastSaveDate = new Date(data.lastSaveTime);
                const now = new Date();
                
                let yearlyResetThreshold = new Date(now.getFullYear(), 0, 1, 2, 0, 0); 
                if (now < yearlyResetThreshold) {
                    yearlyResetThreshold = new Date(now.getFullYear() - 1, 0, 1, 2, 0, 0);
                }

                let monthlyResetThreshold = new Date(now.getFullYear(), now.getMonth(), 1, 2, 0, 0);
                if (now < monthlyResetThreshold) {
                    monthlyResetThreshold = new Date(now.getFullYear(), now.getMonth() - 1, 1, 2, 0, 0);
                }

                let newData = { ...data };
                let modified = false;

                if (lastSaveDate < yearlyResetThreshold) {
                    newData.yearly = { trips: {}, total: 0 };
                    newData.monthly = { trips: {}, total: 0 }; 
                    modified = true;
                } else if (lastSaveDate < monthlyResetThreshold) {
                    newData.monthly = { trips: {}, total: 0 };
                    modified = true;
                }

                if (modified) {
                    newData.lastSaveTime = Date.now();
                    localStorage.setItem('busCounterStats', JSON.stringify(newData));
                }
                return newData;
            };

            const saveTripToStats = () => {
                if (tripRecorded || !activeVariant) return; 

                const newData = { ...statsData };
                const key = `${activeVariant.company}-${activeVariant.route}-${activeVariant.description}`;

                if (!newData.yearly.trips[key]) newData.yearly.trips[key] = { company: activeVariant.company, route: activeVariant.route, desc: activeVariant.description, count: 0 };
                newData.yearly.trips[key].count += 1;
                newData.yearly.total += 1;

                if (!newData.monthly.trips[key]) newData.monthly.trips[key] = { company: activeVariant.company, route: activeVariant.route, desc: activeVariant.description, count: 0 };
                newData.monthly.trips[key].count += 1;
                newData.monthly.total += 1;

                newData.lastSaveTime = Date.now();

                setStatsData(newData);
                localStorage.setItem('busCounterStats', JSON.stringify(newData));
                setTripRecorded(true); 
            };

            const manualClearStats = () => {
                if (window.confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÁµ±Ë®àË≥áÊñôÂóéÔºüÊ≠§Âãï‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                    const empty = { yearly: { trips: {}, total: 0 }, monthly: { trips: {}, total: 0 }, lastSaveTime: Date.now() };
                    setStatsData(empty);
                    localStorage.setItem('busCounterStats', JSON.stringify(empty));
                }
            };
            
            // --- Ê†∏ÂøÉÊºîÁÆóÊ≥ï ---

            const recalculateAll = (baseCount, currentHistory = history) => {
                let runningTotal = baseCount;
                const newHistory = currentHistory.map(record => {
                    if (record.isSeparator) return record;
                    runningTotal = runningTotal + record.on - record.off;
                    return { ...record, occupancy: runningTotal };
                });
                setHistory(newHistory);
                setInitialPassengers(baseCount);
                const currentLiveTotal = runningTotal + stopOn - stopOff;
                setTotalPassengers(currentLiveTotal);
            };

            const checkForNegativeDeficit = () => {
                const lowestHistoryOccupancy = history.reduce((min, r) => {
                    if (r.isSeparator) return min;
                    return Math.min(min, r.occupancy);
                }, Infinity); 
                const overallLowest = Math.min(lowestHistoryOccupancy, totalPassengers);
                return Math.max(0, -overallLowest);
            };
            
            const handleCorrection = () => {
                recalculateAll(initialPassengers + negativeDeficit);
                setNegativeDeficit(0);
                setShowNegativeCorrection(false);
                setShowReport(true);
            };

            const handleShowReport = () => {
                const deficit = checkForNegativeDeficit();
                if (deficit > 0) {
                    setNegativeDeficit(deficit);
                    setShowNegativeCorrection(true);
                } else {
                    setShowReport(true);
                }
            };

            // --- Analysis Calculation ---
            const getAnalysisData = () => {
                let combinedData = history.filter(r => !r.isSeparator);
                
                if (routeStops.length > 0 && currentStopIndex < routeStops.length) {
                     if (stopOn > 0 || stopOff > 0 || arrivalTime || currentNote) {
                         const currentRec = {
                             stopName: routeStops[currentStopIndex].name,
                             on: stopOn,
                             off: stopOff, 
                             occupancy: totalPassengers,
                             note: currentNote,
                             isLive: true
                         };
                         combinedData = [...combinedData, currentRec];
                     }
                }

                if (combinedData.length === 0) return null;

                let maxOnVal = 0;
                let maxOccVal = 0;
                let maxOffVal = 0; 

                combinedData.forEach(r => {
                    if (r.on > maxOnVal) maxOnVal = r.on;
                    if (r.occupancy > maxOccVal) maxOccVal = r.occupancy;
                    if (r.off > maxOffVal) maxOffVal = r.off;
                });

                const maxOnStops = combinedData.filter(r => r.on === maxOnVal && maxOnVal > 0);
                const maxOffStops = combinedData.filter(r => r.off === maxOffVal && maxOffVal > 0);
                
                const rawSegments = [];
                combinedData.forEach((r, idx) => {
                    if (r.occupancy === maxOccVal && maxOccVal > 0) {
                        let toStopName = null;
                        if (idx + 1 < combinedData.length) {
                            toStopName = cleanStopName(combinedData[idx + 1].stopName);
                        } else if (r.isLive) {
                            if (currentStopIndex + 1 < routeStops.length) {
                                toStopName = routeStops[currentStopIndex + 1].name;
                            } else {
                                toStopName = "Â†±ÂëäÂÆåÁµê";
                            }
                        } else {
                            toStopName = "Â†±ÂëäÂÆåÁµê";
                        }
                        
                        rawSegments.push({
                            from: cleanStopName(r.stopName),
                            to: toStopName,
                            val: r.occupancy
                        });
                    }
                });

                const mergedSegments = [];
                if (rawSegments.length > 0) {
                    let currentSeg = { ...rawSegments[0] };
                    for (let i = 1; i < rawSegments.length; i++) {
                        if (currentSeg.to === rawSegments[i].from && currentSeg.to !== "Â†±ÂëäÂÆåÁµê") {
                            currentSeg.to = rawSegments[i].to; 
                        } else {
                            mergedSegments.push(currentSeg); 
                            currentSeg = { ...rawSegments[i] };
                        }
                    }
                    mergedSegments.push(currentSeg);
                }

                const formattedSegments = mergedSegments.map(seg => {
                    if (seg.to === "Â†±ÂëäÂÆåÁµê" || seg.to === null) {
                        return `${seg.from} (Â†±ÂëäÂÆåÁµêÁ´ô)`;
                    } else {
                        return `${seg.from} - ${seg.to} ÊÆµ`;
                    }
                });

                return { maxOnVal, maxOccVal, maxOffVal, maxOnStops, maxOffStops, formattedSegments };
            };

            // --- API ÂäüËÉΩ ---
            
            const getCompanyColor = (comp) => {
                if (comp === 'KMB') return 'bg-red-600 border-red-700 text-white';
                if (comp === 'CTB') return 'bg-yellow-400 border-yellow-500 text-black';
                if (comp === 'NLB') return 'bg-teal-600 border-teal-700 text-white'; 
                return 'bg-gray-400 border-gray-500 text-white';
            };

            const toggleCompany = () => {
                setCompany(prev => {
                    if (prev === 'KMB') return 'CTB';
                    if (prev === 'CTB') return 'NLB';
                    return 'KMB';
                });
            };

            const searchRoute = async () => {
                if (!routeNumber) return;
                setIsLoading(true);
                setApiError(null);
                setVariants([]);
                setShowVariantSelector(false);
                setActiveVariant(null); 

                try {
                    if (company === 'KMB') {
                        const response = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/route/`);
                        const data = await response.json();
                        if (data.data) {
                            const filteredRoutes = data.data.filter(r => r.route.toUpperCase() === routeNumber.toUpperCase());
                            if (filteredRoutes.length > 0) {
                                const routeVariants = filteredRoutes.map(r => ({
                                    company: 'KMB', route: r.route, bound: r.bound, serviceType: r.service_type, orig: r.orig_tc, dest: r.dest_tc,
                                    description: `ÂæÄ ${r.dest_tc}`, subDescription: `Áî± ${r.orig_tc} ÈñãÂá∫`, tag: r.service_type === '1' ? 'Êó•Â∏∏Áè≠Ê¨°' : `ÁâπÂà•Áè≠Ê¨° (${r.service_type})`
                                }));
                                routeVariants.sort((a, b) => a.serviceType - b.serviceType);
                                setVariants(routeVariants);
                                setShowVariantSelector(true);
                            } else { setApiError(`Êâæ‰∏çÂà∞‰πùÂ∑¥Ë∑ØÁ∑ö ${routeNumber} ÁöÑË≥áÊñô`); }
                        } else { setApiError("‰πùÂ∑¥ API ÈÄ£Á∑öÈåØË™§"); }
                    } else if (company === 'CTB') {
                        const response = await fetch(`https://rt.data.gov.hk/v2/transport/citybus/route/CTB/${routeNumber.toUpperCase()}`);
                        const data = await response.json();
                        if (data.data) {
                            const r = Array.isArray(data.data) ? data.data : [data.data];
                            let ctbVariants = [];
                            r.forEach(routeObj => {
                                ctbVariants.push({ company: 'CTB', route: routeObj.route, dir: 'outbound', orig: routeObj.orig_tc, dest: routeObj.dest_tc, description: `ÂæÄ ${routeObj.dest_tc} (ÂéªÁ®ã)`, subDescription: `Áî± ${routeObj.orig_tc} ÈñãÂá∫`, tag: 'ÂéªÁ®ã' });
                                ctbVariants.push({ company: 'CTB', route: routeObj.route, dir: 'inbound', orig: routeObj.dest_tc, dest: routeObj.orig_tc, description: `ÂæÄ ${routeObj.orig_tc} (ÂõûÁ®ã)`, subDescription: `Áî± ${routeObj.dest_tc} ÈñãÂá∫`, tag: 'ÂõûÁ®ã' });
                            });
                            setVariants(ctbVariants);
                            setShowVariantSelector(true);
                        } else { setApiError(`Êâæ‰∏çÂà∞ÂüéÂ∑¥Ë∑ØÁ∑ö ${routeNumber} ÁöÑË≥áÊñô`); }
                    } else if (company === 'NLB') {
                        const response = await fetch(`https://rt.data.gov.hk/v2/transport/nlb/route.php?action=list`);
                        const data = await response.json();
                        if (data && data.routes) {
                            const filteredRoutes = data.routes.filter(r => r.routeNo.toUpperCase() === routeNumber.toUpperCase());
                            if (filteredRoutes.length > 0) {
                                const nlbVariants = filteredRoutes.map(r => ({ company: 'NLB', route: r.routeNo, routeId: r.routeId, description: r.routeName_c, subDescription: r.routeName_e, tag: 'Â∂ºÂ∑¥' }));
                                setVariants(nlbVariants);
                                setShowVariantSelector(true);
                            } else { setApiError(`Êâæ‰∏çÂà∞Â∂ºÂ∑¥Ë∑ØÁ∑ö ${routeNumber} ÁöÑË≥áÊñô`); }
                        } else { setApiError("Â∂ºÂ∑¥ API ÈÄ£Á∑öÈåØË™§"); }
                    }
                } catch (err) { console.error(err); setApiError("API ÈÄ£Á∑öÈåØË™§"); } finally { setIsLoading(false); }
            };

            const selectVariant = async (variant) => {
                setIsLoading(true);
                setShowVariantSelector(false);
                setApiError(null);
                setRouteStops([]);
                setActiveVariant(variant); 
                try {
                    let fullStopsData = [];
                    if (variant.company === 'KMB') {
                        const direction = variant.bound === 'O' ? 'outbound' : 'inbound';
                        const stopListRes = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/route-stop/${variant.route}/${direction}/${variant.serviceType}`);
                        const stopListData = await stopListRes.json();
                        if (!stopListData.data || stopListData.data.length === 0) throw new Error("ÁÑ°Á´ôÈªûË≥áÊñô");
                        const stopIds = stopListData.data.map(item => ({ id: item.stop, seq: item.seq }));
                        fullStopsData = await Promise.all(stopIds.map(async (s) => {
                            try {
                                const detailRes = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/stop/${s.id}`);
                                const detailData = await detailRes.json();
                                return { seq: s.seq, id: s.id, name: detailData.data.name_tc };
                            } catch { return { seq: s.seq, id: s.id, name: "Êú™Áü•Á´ôÈªû" }; }
                        }));
                        fullStopsData.sort((a, b) => parseInt(a.seq) - parseInt(a.seq));
                    } else if (variant.company === 'CTB') {
                        const stopListRes = await fetch(`https://rt.data.gov.hk/v2/transport/citybus/route-stop/CTB/${variant.route}/${variant.dir}`);
                        const stopListData = await stopListRes.json();
                        if (!stopListData.data || stopListData.data.length === 0) throw new Error("ÁÑ°Á´ôÈªûË≥áÊñô");
                        const stopIds = stopListData.data.map(item => ({ id: item.stop, seq: item.seq }));
                        fullStopsData = await Promise.all(stopIds.map(async (s) => {
                            try {
                                const detailRes = await fetch(`https://rt.data.gov.hk/v2/transport/citybus/stop/${s.id}`);
                                const detailData = await detailRes.json();
                                return { seq: s.seq, id: s.id, name: detailData.data.name_tc };
                            } catch { return { seq: s.seq, id: s.id, name: "Êú™Áü•Á´ôÈªû" }; }
                        }));
                        fullStopsData.sort((a, b) => parseInt(a.seq) - parseInt(a.seq));
                    } else if (variant.company === 'NLB') {
                        const stopListRes = await fetch(`https://rt.data.gov.hk/v2/transport/nlb/stop.php?action=list&routeId=${variant.routeId}`);
                        const stopListData = await stopListRes.json();
                        if (!stopListData.stops || stopListData.stops.length === 0) throw new Error("ÁÑ°Á´ôÈªûË≥áÊñô");
                        fullStopsData = stopListData.stops.map((s, index) => ({ seq: index + 1, id: s.stopId, name: s.stopName_c }));
                    }
                    
                    setRouteStops(fullStopsData);
                    if (routeStops.length === 0 && history.length === 0) resetCounter();
                    else {
                        setCurrentStopIndex(0); setStopOn(0); setStopOff(0); setArrivalTime(''); setCurrentNote('');
                    }
                    setShowTripSettings(true); 
                } catch (err) { setApiError(err.message || "Âä†ËºâÁ´ôÈªûÂ§±Êïó"); } finally { setIsLoading(false); }
            };

            // --- ÈÇèËºØËôïÁêÜ (Logic) ---

            const resetCounter = () => {
                setCurrentStopIndex(0); setInitialPassengers(0); setTotalPassengers(0);
                setStopOn(0); setStopOff(0); setArrivalTime('');
                setHistory([]); setNegativeDeficit(0); setShowNegativeCorrection(false);
                setTripRecorded(false); setCurrentNote(''); 
            };

            const openResetConfirm = () => setShowResetConfirm(true);

            const performHardReset = () => {
                resetCounter(); 
                setRouteStops([]); setRouteNumber(''); setVariants([]);
                setTripInfo({ plate: '', captainId: '', captainName: '' });
                setActiveVariant(null); setApiError(null); 
                setShowReport(false); setShowResetConfirm(false);
                localStorage.removeItem('busCounterCurrentSession');
            };

            // MODIFIED: Copy before reset
            const handleFinishAndReset = () => {
                copyReport();
                saveTripToStats();
                performHardReset();
            };

            const setArrivalNow = () => setArrivalTime(formatTime24());

            const jumpToStop = (index) => {
                setCurrentStopIndex(index); setStopOn(0); setStopOff(0); setArrivalTime('');
                setShowStopSelector(false); setCurrentNote('');
            };

            const openManualInput = (type) => {
                setEditingValue(type);
                if (type === 'initial') { setManualInputMode('direct_base'); setManualInputValue(initialPassengers.toString()); }
                else if (type === 'on') { setManualInputValue(stopOn.toString()); }
                else if (type === 'off') { setManualInputValue(stopOff.toString()); }
            };

            const saveManualInput = () => {
                const val = parseInt(manualInputValue) || 0;
                if (editingValue === 'initial') {
                    if (manualInputMode === 'direct_base') recalculateAll(val);
                    else {
                        const currentNetChange = totalPassengers - initialPassengers;
                        recalculateAll(val - currentNetChange);
                    }
                } else if (editingValue === 'on') {
                    const diff = val - stopOn; setStopOn(val); setTotalPassengers(prev => prev + diff);
                } else if (editingValue === 'off') {
                    const diff = val - stopOff; setStopOff(val); setTotalPassengers(prev => prev - diff); 
                }
                setEditingValue(null);
            };

            const openHistoryEdit = (index) => {
                const record = history[index];
                if (record.isSeparator) return; 
                setHistoryEditValues({ on: record.on, off: record.off, note: record.note || '', time: record.arrivalTime === '-' ? '' : record.arrivalTime });
                setEditingHistoryIndex(index);
            };

            const saveHistoryEdit = () => {
                if (editingHistoryIndex === null) return;
                const updatedHistory = [...history];
                updatedHistory[editingHistoryIndex] = {
                    ...updatedHistory[editingHistoryIndex],
                    on: parseInt(historyEditValues.on) || 0,
                    off: parseInt(historyEditValues.off) || 0,
                    note: historyEditValues.note,
                    arrivalTime: historyEditValues.time || '-'
                };
                recalculateAll(initialPassengers, updatedHistory);
                setEditingHistoryIndex(null);
            };

            const handleNextStop = () => {
                if (routeStops.length > 0 && currentStopIndex === routeStops.length - 1) saveTripToStats();
                if (routeStops.length > 0 && currentStopIndex >= routeStops.length) return;
                const currentStopName = routeStops.length > 0 ? routeStops[currentStopIndex]?.name : `Á¨¨ ${currentStopIndex + 1} Á´ô`;
                const stopData = {
                    stopNumber: currentStopIndex + 1, stopName: currentStopName,
                    arrivalTime: arrivalTime || '-', on: stopOn, off: stopOff,
                    occupancy: totalPassengers, timestamp: formatTime24(), note: currentNote 
                };
                setHistory([...history, stopData]);
                setCurrentStopIndex(prev => prev + 1);
                setStopOn(0); setStopOff(0); setArrivalTime(''); setCurrentNote(''); 
            };

            // NEW: Handle Complete and Auto-Jump to Report (Unified for all stops)
            const handleCompleteAndShowReport = () => {
                // Ensure stats are saved even if ending early
                saveTripToStats();
                
                const currentStopName = routeStops.length > 0 ? routeStops[currentStopIndex]?.name : `Á¨¨ ${currentStopIndex + 1} Á´ô`;
                const stopData = {
                    stopNumber: currentStopIndex + 1, stopName: currentStopName,
                    arrivalTime: arrivalTime || '-', on: stopOn, off: stopOff,
                    occupancy: totalPassengers, timestamp: formatTime24(), note: currentNote
                };
                
                setHistory([...history, stopData]);
                setCurrentStopIndex(prev => prev + 1);
                setStopOn(0); setStopOff(0); setArrivalTime(''); setCurrentNote('');
                
                // Jump to Report
                setShowReport(true);
            };

            const handlePrevStop = () => {
                if (currentStopIndex === 0) return;
                const newHistory = [...history];
                const lastRecord = newHistory.pop();
                if (lastRecord && lastRecord.isSeparator) {
                    if (newHistory.length > 0) newHistory.pop();
                }
                setCurrentStopIndex(prev => prev - 1);
                if (lastRecord && !lastRecord.isSeparator) {
                    setStopOn(lastRecord.on);
                    setStopOff(lastRecord.off);
                    setArrivalTime(lastRecord.arrivalTime === '-' ? '' : lastRecord.arrivalTime);
                    setCurrentNote(lastRecord.note || '');
                }
                setHistory(newHistory);
                recalculateAll(initialPassengers, newHistory);
            };

            const handleContinueTrip = () => {
                const currentStopName = routeStops.length > 0 ? routeStops[currentStopIndex]?.name : `Á¨¨ ${currentStopIndex + 1} Á´ô`;
                const stopData = {
                    stopNumber: currentStopIndex + 1, stopName: currentStopName,
                    arrivalTime: arrivalTime || '-', on: stopOn, off: stopOff,
                    occupancy: totalPassengers, timestamp: formatTime24(),
                    note: currentNote || 'ÁπºÁ∫å/Âêà‰ΩµË°åÁ®ã'
                };
                const separatorData = { isSeparator: true, stopName: '--- ÁπºÁ∫åË°åÁ®ã ---', arrivalTime: '-', on: 0, off: 0, occupancy: totalPassengers, note: '' };
                setHistory([...history, stopData, separatorData]);
                setCurrentStopIndex(0); setStopOn(0); setStopOff(0); setArrivalTime(''); setCurrentNote('');
                setRouteStops([]); setActiveVariant(null); setShowVariantSelector(true);
            };

            const incrementOn = () => { setStopOn(s => s + 1); setTotalPassengers(t => t + 1); };
            const decrementOn = () => { if (stopOn > 0) { setStopOn(s => s - 1); setTotalPassengers(t => t - 1); }};
            const incrementOff = () => { setStopOff(s => s + 1); setTotalPassengers(t => t - 1); };
            const decrementOff = () => { 
                if (stopOff > 0) { 
                    setStopOff(s => s - 1); 
                    setTotalPassengers(t => t + 1); 
                }
            };

            // --- Report Logic ---

            const getTripDuration = () => {
                if (history.length === 0) return 0;
                const start = history[0].arrivalTime;
                let end = arrivalTime;
                for (let i = history.length - 1; i >= 0; i--) {
                    if (!history[i].isSeparator && history[i].arrivalTime !== '-') {
                        if (!end) end = history[i].arrivalTime;
                        break;
                    }
                }
                if (arrivalTime && currentStopIndex < routeStops.length) end = arrivalTime; 
                return calculateDurationMinutes(start, end);
            };

            const formatDuration = (mins) => {
                if (durationFormat === 'min') return `${mins} ÂàÜÈêò`;
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                return h > 0 ? `${h}Â∞èÊôÇ${m}ÂàÜÈêò` : `${m}ÂàÜÈêò`;
            };

            const getTotalPatronage = () => {
                let total = initialPassengers;
                history.forEach(r => { if(!r.isSeparator) total += r.on; });
                if (routeStops.length === 0 || currentStopIndex < routeStops.length) total += stopOn;
                return total;
            };

            // --- EXCEL EXPORT ---
            const exportToExcel = () => {
                const duration = getTripDuration();
                const durationStr = formatDuration(duration);
                const dateStr = new Date().toLocaleDateString();
                const filename = `BusReport_${routeNumber || 'Route'}_${dateStr.replace(/\//g, '-')}.xlsx`;
                const analysisData = getAnalysisData();
                const totalPatronage = getTotalPatronage();

                const wsData = [
                    ["Â∑¥Â£´ÂÆ¢ÈáèÁµ±Ë®àÂ†±Âëä"],
                    ["Êó•Êúü", dateStr],
                    ["Ë∑ØÁ∑ö", `${company} ${routeNumber || '-'}`],
                    ["ËªäÁâå/ËªäÈöäÁ∑®Ëôü", tripInfo.plate || '-'],
                    ["ËªäÈï∑", `${tripInfo.captainId || '-'} ${tripInfo.captainName || ''}`],
                    ["Á∏ΩË°åËªäÊôÇÈñì", durationStr],
                    ["ÂàùÂßã‰∫∫Êï∏", initialPassengers],
                    [], 
                ];

                if (includeAnalysis && analysisData && (analysisData.maxOnVal > 0 || analysisData.maxOccVal > 0)) {
                    wsData.push(["*** ÈáçÈªûÂÆ¢ÈáèÂàÜÊûê ***"]);
                    if (analysisData.maxOnStops.length > 0) {
                        const stops = analysisData.maxOnStops.map(s => cleanStopName(s.stopName)).join(", ");
                        wsData.push(["ÊúÄÂ§ö‰∫∫‰∏äËªä", `${stops} (${analysisData.maxOnVal}‰∫∫)`]);
                    }
                    if (analysisData.maxOffStops.length > 0) {
                        const stops = analysisData.maxOffStops.map(s => cleanStopName(s.stopName)).join(", ");
                        wsData.push(["ÊúÄÂ§ö‰∫∫ËêΩËªä", `${stops} (${analysisData.maxOffVal}‰∫∫)`]);
                    }
                    if (analysisData.formattedSegments.length > 0) {
                        wsData.push(["ÊúÄÈ´òËºâÂÆ¢Ë∑ØÊÆµ", `${analysisData.formattedSegments.join(", ")} (${analysisData.maxOccVal}‰∫∫)`]);
                    }
                    wsData.push([]); 
                }

                wsData.push(["ÊôÇÈñì", "Á´ôÂêç", "‰∏ä", "ËêΩ", "Ëªä‰∏ä", "ÂÇôË®ª"]);

                history.forEach(record => {
                    if (record.isSeparator) wsData.push(["--- ÁπºÁ∫åË°åÁ®ã ---", "", "", "", "", ""]);
                    else wsData.push([record.arrivalTime === '-' ? '--:--' : record.arrivalTime, cleanStopName(record.stopName), record.on, record.off, record.occupancy, record.note || '']);
                });

                if (routeStops.length === 0 || currentStopIndex < routeStops.length) {
                    if (stopOn > 0 || stopOff > 0 || arrivalTime || currentNote) {
                        const rawName = routeStops.length > 0 ? routeStops[currentStopIndex]?.name : `Á¨¨ ${currentStopIndex + 1} Á´ô`;
                         wsData.push([arrivalTime || '--:--', cleanStopName(rawName), stopOn, stopOff, totalPassengers, currentNote || '']);
                    }
                }

                wsData.push([]);
                if (showTotalPatronage) wsData.push(["Á∏ΩÂÆ¢Èáè", totalPatronage]);

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                ws['!cols'] = [{ wch: 10 }, { wch: 25 }, { wch: 5 }, { wch: 5 }, { wch: 8 }, { wch: 20 }];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Report");
                XLSX.writeFile(wb, filename);
            };

            const copyReport = () => {
                if (currentStopIndex >= routeStops.length - 1) saveTripToStats();
                const duration = getTripDuration();
                const analysisData = getAnalysisData();
                const totalPatronage = getTotalPatronage();
                
                let text = `Â∑¥Â£´ÂÆ¢ÈáèÁµ±Ë®àÂ†±Âëä\n================================\n`;
                text += `Êó•Êúü: ${new Date().toLocaleDateString()}\nË∑ØÁ∑ö: ${company} ${routeNumber || '-'}\n`;
                text += `ËªäÁâå/ËªäÈöäÁ∑®Ëôü: ${tripInfo.plate || '-'}\nËªäÈï∑: ${tripInfo.captainId || '-'} ${tripInfo.captainName || ''}\n`;
                text += `Á∏ΩË°åËªäÊôÇÈñì: ${formatDuration(duration)}\nÂàùÂßã: ${initialPassengers} ‰∫∫\n\n`;

                if (includeAnalysis && analysisData && (analysisData.maxOnVal > 0 || analysisData.maxOccVal > 0)) {
                    text += `*** ÈáçÈªûÂÆ¢ÈáèÂàÜÊûê ***\n`;
                    if (analysisData.maxOnStops.length > 0) {
                        const stops = analysisData.maxOnStops.map(s => cleanStopName(s.stopName)).join(", ");
                        text += `üî• ÊúÄÂ§ö‰∫∫‰∏äËªä: ${stops} (+${analysisData.maxOnVal})\n`;
                    }
                    if (analysisData.maxOffStops.length > 0) {
                        const stops = analysisData.maxOffStops.map(s => cleanStopName(s.stopName)).join(", ");
                        text += `üìâ ÊúÄÂ§ö‰∫∫ËêΩËªä: ${stops} (-${analysisData.maxOffVal})\n`;
                    }
                    if (analysisData.formattedSegments.length > 0) {
                        text += `üöå ÊúÄÈ´òËºâÂÆ¢Ë∑ØÊÆµ: ${analysisData.formattedSegments.join(", ")} (${analysisData.maxOccVal})\n`;
                    }
                    text += `\n`;
                }
                
                text += `ÊôÇÈñì   | Á´ôÂêç          | ‰∏ä  | ËêΩ  | Ëªä‰∏ä${includeNotesInReport ? ' | ÂÇôË®ª' : ''}\n`;
                text += includeNotesInReport ? `----------------------------------------------------\n` : `---------------------------------------------\n`;
                
                history.forEach(record => {
                    if (record.isSeparator) { text += `--- ÁπºÁ∫åË°åÁ®ã / ËΩâÈ†Å ---\n`; return; }
                    const timeStr = record.arrivalTime === '-' ? '--:--' : record.arrivalTime;
                    const stopName = cleanStopName(record.stopName);
                    const occupancyDisplay = record.occupancy < 0 ? `(${record.occupancy})` : record.occupancy;
                    let line = `${timeStr.padEnd(6)} | ${stopName.padEnd(12)} | +${record.on.toString().padEnd(2)} | -${record.off.toString().padEnd(2)} | ${occupancyDisplay}`;
                    if (includeNotesInReport) line += ` | ${record.note || ''}`;
                    text += line + `\n`;
                });
                
                if (routeStops.length === 0 || currentStopIndex < routeStops.length) {
                    if (stopOn > 0 || stopOff > 0 || arrivalTime || currentNote) {
                        const rawName = routeStops.length > 0 ? routeStops[currentStopIndex]?.name : `Á¨¨ ${currentStopIndex + 1} Á´ô`;
                        const currName = cleanStopName(rawName);
                        const currTime = arrivalTime || '--:--';
                        const occupancyDisplay = totalPassengers < 0 ? `(${totalPassengers})` : totalPassengers;
                        let line = `${currTime.padEnd(6)} | ${currName.padEnd(12)} | +${stopOn.toString().padEnd(2)} | -${stopOff.toString().padEnd(2)} | ${occupancyDisplay}`;
                        if (includeNotesInReport) line += ` | ${currentNote || ''}`;
                        text += line + `\n`;
                    }
                }
                
                if (showTotalPatronage) {
                    text += `\nÁ∏ΩÂÆ¢Èáè: ${totalPatronage}\n`;
                }
                text += `Áî± BusCounter ÁîüÊàê`;
                navigator.clipboard.writeText(text).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); }).catch(() => { });
            };

            const getCurrentStopDisplay = () => {
                if (routeStops.length > 0) {
                    if (currentStopIndex < routeStops.length) return routeStops[currentStopIndex].name;
                    return "Ë°åÁ®ãÁµêÊùü (End)";
                }
                return `Á¨¨ ${currentStopIndex + 1} Á´ô`;
            };

            // Simplified Next Stop Text
            const getNextStopDisplay = () => {
                if (routeStops.length > 0) {
                    if (currentStopIndex < routeStops.length - 1) return `‰∏ã‰∏ÄÁ´ô: ${routeStops[currentStopIndex + 1].name}`;
                    if (currentStopIndex === routeStops.length - 1) return "Á∏ΩÁ´ô (Ë®òÈåÑ‰∏¶ÁµêÊùü)";
                    return "Ë°åÁ®ãÂ∑≤ÁµêÊùü";
                }
                return "ÂâçÂæÄ‰∏ã‰∏ÄÁ´ô";
            };

            // Get Previous Stop Name
            const getPrevStopDisplay = () => {
                if (currentStopIndex > 0 && routeStops.length > 0) {
                    return `‰∏ä‰∏ÄÁ´ô: ${routeStops[currentStopIndex - 1].name}`;
                }
                return "‰∏ä‰∏ÄÁ´ô: Ëµ∑Èªû";
            };

            const isLastStop = routeStops.length > 0 && currentStopIndex === routeStops.length - 1;

            // --- UI Render ---
            
            const renderHistoryEditModal = () => {
                if (editingHistoryIndex === null) return null;
                const record = history[editingHistoryIndex];
                if (record.isSeparator) return null;

                return (
                    <div className="absolute inset-0 z-[70] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                        <div className="bg-white rounded-xl p-5 w-full max-w-xs shadow-2xl">
                            <h3 className="text-lg font-bold mb-2 text-slate-700 flex items-center gap-2">
                                <Pencil className="w-5 h-5"/> ‰øÆÊ≠£Ë®òÈåÑ
                            </h3>
                            <p className="text-xs text-slate-500 mb-4 border-b pb-2">Á´ôÈªû: {cleanStopName(record.stopName)}</p>
                            
                            <div className="mb-4">
                                <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Âà∞Á´ôÊôÇÈñì</label>
                                <input type="time" value={historyEditValues.time} onChange={(e) => setHistoryEditValues({...historyEditValues, time: e.target.value})} className="w-full border-2 border-slate-200 rounded-lg p-2 text-xl font-bold text-center outline-none focus:border-blue-400" />
                            </div>

                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="text-xs font-bold text-green-600 uppercase block mb-1">‰∏äËªä</label>
                                    <input type="number" value={historyEditValues.on} onChange={(e) => setHistoryEditValues({...historyEditValues, on: e.target.value})} className="w-full border-2 border-green-100 rounded-lg p-2 text-xl font-bold text-center focus:border-green-500 outline-none" />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-red-500 uppercase block mb-1">ËêΩËªä</label>
                                    <input type="number" value={historyEditValues.off} onChange={(e) => setHistoryEditValues({...historyEditValues, off: e.target.value})} className="w-full border-2 border-red-100 rounded-lg p-2 text-xl font-bold text-center focus:border-red-500 outline-none" />
                                </div>
                            </div>
                            <div className="mb-4">
                                <label className="text-xs font-bold text-slate-500 uppercase block mb-1">ÂÇôË®ª</label>
                                <input type="text" value={historyEditValues.note} onChange={(e) => setHistoryEditValues({...historyEditValues, note: e.target.value})} className="w-full border-2 border-slate-200 rounded-lg p-2 text-sm text-slate-800 outline-none focus:border-blue-400" placeholder="‰æãÂ¶ÇÔºöÂÆ¢Êªø, È£õÁ´ô..." />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={() => setEditingHistoryIndex(null)} className="py-2 bg-gray-100 rounded-lg font-bold text-gray-600">ÂèñÊ∂à</button>
                                <button onClick={saveHistoryEdit} className="py-2 bg-blue-600 text-white rounded-lg font-bold shadow-sm">Á¢∫Ë™ç‰øÆÊ≠£</button>
                            </div>
                        </div>
                    </div>
                );
            };

            // --- STATS PAGE ---
            if (showStats) {
                const yearlyKeys = Object.keys(statsData.yearly?.trips || {}).sort((a, b) => statsData.yearly.trips[b].count - statsData.yearly.trips[a].count);
                const monthlyKeys = Object.keys(statsData.monthly?.trips || {}).sort((a, b) => statsData.monthly.trips[b].count - statsData.monthly.trips[a].count);

                return (
                    <div className="flex flex-col h-screen bg-gray-50 font-sans text-gray-900 relative">
                        <header className="bg-white border-b p-4 flex items-center justify-between sticky top-0 z-10 shadow-sm">
                            <h2 className="text-xl font-bold flex items-center gap-2"><BarChart3 className="w-6 h-6 text-purple-600" /> Ë°åÁ®ãÁµ±Ë®à</h2>
                            <button onClick={() => setShowStats(false)} className="text-purple-600 font-medium">ËøîÂõû</button>
                        </header>

                        {/* Tab Switcher */}
                        <div className="px-4 pt-4">
                            <div className="flex bg-gray-200 rounded-lg p-1">
                                <button 
                                    onClick={() => setStatsTab('monthly')}
                                    className={`flex-1 py-1.5 text-sm font-bold rounded-md transition-all ${statsTab === 'monthly' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500'}`}
                                >
                                    ÊúàÂ∫¶Áµ±Ë®à
                                </button>
                                <button 
                                    onClick={() => setStatsTab('yearly')}
                                    className={`flex-1 py-1.5 text-sm font-bold rounded-md transition-all ${statsTab === 'yearly' ? 'bg-white text-purple-600 shadow-sm' : 'text-gray-500'}`}
                                >
                                    Âπ¥Â∫¶Áµ±Ë®à
                                </button>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {/* Summary Card */}
                            {statsTab === 'monthly' ? (
                                <div className="bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl p-6 text-white shadow-md relative overflow-hidden transition-all">
                                    <div className="relative z-10">
                                        <div className="text-sm font-medium opacity-80 mb-1 flex items-center gap-1"><Calendar className="w-4 h-4"/> Êú¨ÊúàË°åÁ®ã ({new Date().getMonth() + 1}Êúà)</div>
                                        <div className="text-4xl font-bold">{statsData.monthly?.total || 0} <span className="text-lg font-normal opacity-80">Ê¨°</span></div>
                                        <div className="text-[10px] mt-2 opacity-60">ÊØèÊúà1Êó• 02:00 ÈáçÁΩÆ</div>
                                    </div>
                                    <BarChart3 className="absolute right-[-10px] bottom-[-10px] w-24 h-24 text-white opacity-20" />
                                </div>
                            ) : (
                                <div className="bg-gradient-to-br from-purple-600 to-indigo-600 rounded-xl p-6 text-white shadow-md relative overflow-hidden transition-all">
                                    <div className="relative z-10">
                                        <div className="text-sm font-medium opacity-80 mb-1 flex items-center gap-1"><TrendingUp className="w-4 h-4"/> Êú¨Âπ¥Â∫¶Ë°åÁ®ã</div>
                                        <div className="text-4xl font-bold">{statsData.yearly?.total || 0} <span className="text-lg font-normal opacity-80">Ê¨°</span></div>
                                        <div className="text-[10px] mt-2 opacity-60">ÊØèÂπ¥1Êúà1Êó• 02:00 ÈáçÁΩÆ</div>
                                    </div>
                                    <TrendingUp className="absolute right-[-10px] bottom-[-10px] w-24 h-24 text-white opacity-20" />
                                </div>
                            )}

                            {/* Ranking List */}
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                                    <h3 className="font-bold text-gray-700">Ë∑ØÁ∑öÊéíË°åÊ¶ú ({statsTab === 'monthly' ? 'ÊúàÂ∫¶' : 'Âπ¥Â∫¶'})</h3>
                                    <button onClick={manualClearStats} className="text-red-400 p-1 hover:text-red-600"><Trash2 className="w-4 h-4"/></button>
                                </div>
                                {((statsTab === 'monthly' ? monthlyKeys : yearlyKeys).length === 0) ? (
                                    <div className="p-8 text-center text-gray-400 text-sm">Êö´ÁÑ°Áµ±Ë®àÊï∏Êìö</div>
                                ) : (
                                    <ul className="divide-y divide-gray-100">
                                        {(statsTab === 'monthly' ? monthlyKeys : yearlyKeys).map(key => {
                                            const t = (statsTab === 'monthly' ? statsData.monthly.trips : statsData.yearly.trips)[key];
                                            return (
                                                <li key={key} className="p-4 flex items-center justify-between hover:bg-gray-50">
                                                    <div className="flex items-center gap-3">
                                                        <span className={`text-xs w-10 h-6 flex items-center justify-center rounded font-bold ${getCompanyColor(t.company).replace('border', '')}`}>{t.company === 'KMB' ? t.route : (t.company === 'CTB' ? 'CTB' : 'NLB')}</span>
                                                        <div>
                                                            <div className="font-bold text-gray-800 flex items-center gap-2">
                                                                {t.route} <span className="text-xs font-normal text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded-full">{t.desc}</span>
                                                            </div>
                                                            <div className="text-xs text-gray-400 mt-0.5">{t.company === 'NLB' ? 'Â∂ºÂ∑¥' : t.company}</div>
                                                        </div>
                                                    </div>
                                                    <div className="font-bold text-xl text-purple-600">{t.count}</div>
                                                </li>
                                            );
                                        })}
                                    </ul>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // --- REPORT PAGE ---
            if (showReport) {
                const duration = getTripDuration();
                const analysisData = getAnalysisData();
                const totalPatronage = getTotalPatronage();

                return (
                    <div className="flex flex-col h-screen bg-gray-50 font-sans text-gray-900 relative">
                        {renderHistoryEditModal()}
                        <header className="bg-white border-b p-4 flex items-center justify-between sticky top-0 z-10 shadow-sm">
                            <h2 className="text-xl font-bold flex items-center gap-2"><FileText className="w-6 h-6 text-blue-600" /> Áµ±Ë®àÂ†±Âëä</h2>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowTotalPatronage(!showTotalPatronage)} className={`flex items-center gap-1 text-xs font-bold px-2 py-1.5 rounded border transition-colors ${showTotalPatronage ? 'bg-green-50 text-green-700 border-green-200' : 'bg-gray-50 text-gray-400 border-gray-200'}`}>
                                    <UserPlus className="w-3 h-3"/> {showTotalPatronage ? 'Á∏ΩÂÆ¢Èáè' : 'Èö±Ëóè'}
                                </button>
                                <button onClick={() => setIncludeAnalysis(!includeAnalysis)} className={`flex items-center gap-1 text-xs font-bold px-2 py-1.5 rounded border transition-colors ${includeAnalysis ? 'bg-purple-50 text-purple-700 border-purple-200' : 'bg-gray-50 text-gray-400 border-gray-200'}`}>
                                    <Lightbulb className="w-3 h-3"/> {includeAnalysis ? 'ÂàÜÊûê' : 'Èö±Ëóè'}
                                </button>
                                <button onClick={() => setIncludeNotesInReport(!includeNotesInReport)} className={`flex items-center gap-1 text-xs font-bold px-2 py-1.5 rounded border transition-colors ${includeNotesInReport ? 'bg-yellow-50 text-yellow-700 border-yellow-200' : 'bg-gray-50 text-gray-400 border-gray-200'}`}>
                                    {includeNotesInReport ? 'ÂÇôË®ª' : 'Èö±Ëóè'}
                                </button>
                                <button onClick={() => setShowReport(false)} className="text-blue-600 font-medium ml-1">ËøîÂõû</button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4">
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-4">
                                <div className="p-4 bg-slate-50 border-b grid grid-cols-2 gap-y-3 text-sm">
                                    <div><span className="text-slate-400 block text-[10px] uppercase font-bold">Route Ë∑ØÁ∑ö</span><span className="font-bold text-lg">{company} {routeNumber}</span></div>
                                    <div className="text-right"><span className="text-slate-400 block text-[10px] uppercase font-bold">Date Êó•Êúü</span><span className="font-bold">{new Date().toLocaleDateString()}</span></div>
                                    
                                    {/* Editable Inputs */}
                                    <div>
                                        <label className="text-slate-400 block text-[10px] uppercase font-bold">Bus No. ËªäÁâå/ËªäÈöäÁ∑®Ëôü</label>
                                        <input 
                                            type="text" 
                                            value={tripInfo.plate} 
                                            onChange={(e) => setTripInfo({...tripInfo, plate: e.target.value.toUpperCase()})}
                                            className="font-bold text-lg text-slate-800 bg-transparent border-b border-transparent focus:border-blue-400 outline-none w-full placeholder-slate-300"
                                            placeholder="Ëº∏ÂÖ•ËªäÁâå"
                                        />
                                    </div>
                                    <div className="text-right">
                                        <label className="text-slate-400 block text-[10px] uppercase font-bold">Captain ËªäÈï∑</label>
                                        <div className="flex justify-end gap-1">
                                            <input 
                                                type="text" 
                                                value={tripInfo.captainId} 
                                                onChange={(e) => setTripInfo({...tripInfo, captainId: e.target.value})}
                                                className="font-bold text-lg text-slate-800 bg-transparent border-b border-transparent focus:border-blue-400 outline-none w-16 text-right placeholder-slate-300"
                                                placeholder="Á∑®Ëôü"
                                            />
                                            <input 
                                                type="text" 
                                                value={tripInfo.captainName} 
                                                onChange={(e) => setTripInfo({...tripInfo, captainName: e.target.value})}
                                                className="font-bold text-lg text-slate-800 bg-transparent border-b border-transparent focus:border-blue-400 outline-none w-16 text-right placeholder-slate-300"
                                                placeholder="ÂßìÂêç"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div className="col-span-2 border-t border-slate-200 pt-2 mt-1">
                                        <div className="flex justify-between items-center mb-1">
                                            <span className="text-slate-400 text-[10px] uppercase font-bold flex items-center gap-1"><Timer className="w-3 h-3"/> Ë°åËªäÊôÇÈñì (Duration)</span>
                                            <div className="flex bg-slate-200 rounded p-0.5">
                                                <button onClick={() => setDurationFormat('min')} className={`text-[10px] px-2 py-0.5 rounded font-bold transition-all ${durationFormat === 'min' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'}`}>ÂàÜÈêò</button>
                                                <button onClick={() => setDurationFormat('hm')} className={`text-[10px] px-2 py-0.5 rounded font-bold transition-all ${durationFormat === 'hm' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'}`}>ÊôÇ:ÂàÜ</button>
                                            </div>
                                        </div>
                                        <div className="font-bold text-xl text-slate-800">{formatDuration(duration)}</div>
                                    </div>

                                    <div className="col-span-2 border-t pt-2 flex justify-between items-center">
                                        <span className="text-slate-500 text-xs">ÂàùÂßã‰∫∫Êï∏ (Base):</span>
                                        <span className="font-bold text-lg">{initialPassengers}</span>
                                    </div>
                                </div>

                                {/* ANALYSIS BOX */}
                                {includeAnalysis && analysisData && (analysisData.maxOnVal > 0 || analysisData.maxOccVal > 0) && (
                                    <div className="bg-purple-50 border-b border-purple-100 p-3">
                                        <h3 className="text-purple-800 text-xs font-bold uppercase mb-2 flex items-center gap-1"><TrendingUp className="w-3 h-3"/> ÈáçÈªûÂÆ¢ÈáèÂàÜÊûê</h3>
                                        <div className="space-y-2">
                                            {analysisData.maxOnStops.length > 0 && (
                                                <div className="flex justify-between items-start text-sm">
                                                    <span className="text-gray-500 text-xs font-bold">ÊúÄÂ§ö‰∫∫‰∏äËªä (Max Boarding)</span>
                                                    <div className="text-right">
                                                        <div className="font-bold text-purple-700">{analysisData.maxOnStops.map(s => cleanStopName(s.stopName)).join(", ")}</div>
                                                        <div className="text-xs text-purple-500">+{analysisData.maxOnVal} ‰∫∫</div>
                                                    </div>
                                                </div>
                                            )}
                                            {analysisData.maxOffStops.length > 0 && (
                                                <div className="flex justify-between items-start text-sm">
                                                    <span className="text-gray-500 text-xs font-bold">ÊúÄÂ§ö‰∫∫ËêΩËªä (Max Alighting)</span>
                                                    <div className="text-right">
                                                        <div className="font-bold text-purple-700">{analysisData.maxOffStops.map(s => cleanStopName(s.stopName)).join(", ")}</div>
                                                        <div className="text-xs text-purple-500">-{analysisData.maxOffVal} ‰∫∫</div>
                                                    </div>
                                                </div>
                                            )}
                                            {analysisData.formattedSegments.length > 0 && (
                                                <div className="flex justify-between items-start text-sm">
                                                    <span className="text-gray-500 text-xs font-bold">ÊúÄÈ´òËºâÂÆ¢Ë∑ØÊÆµ (Max Segment)</span>
                                                    <div className="text-right">
                                                        {analysisData.formattedSegments.map((seg, idx) => (
                                                            <div key={idx} className="font-bold text-purple-700">
                                                                {seg}
                                                            </div>
                                                        ))}
                                                        <div className="text-xs text-purple-500">ÂÖ± {analysisData.maxOccVal} ‰∫∫</div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                                
                                <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-white border-b">
                                        <tr>
                                            <th className="p-2 text-left text-blue-600 text-xs w-12 font-bold whitespace-nowrap">ÊôÇÈñì</th>
                                            <th className="p-2 text-left text-gray-500 text-xs font-bold whitespace-nowrap">Á´ôÂêç</th>
                                            <th className="p-2 text-center text-green-600 text-xs w-8 font-bold whitespace-nowrap">‰∏ä</th>
                                            <th className="p-2 text-center text-red-600 text-xs w-8 font-bold whitespace-nowrap">ËêΩ</th>
                                            <th className="p-2 text-right text-gray-800 text-xs w-10 font-bold whitespace-nowrap">Ëªä‰∏ä</th>
                                            {includeNotesInReport && <th className="p-2 text-left text-yellow-600 text-xs font-bold whitespace-nowrap">ÂÇôË®ª</th>}
                                            <th className="p-2 w-8"></th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100 bg-white">
                                        {history.map((record, idx) => {
                                            if (record.isSeparator) {
                                                return (
                                                    <tr key={idx} className="bg-gray-100">
                                                        <td colSpan={includeNotesInReport ? 7 : 6} className="p-2 text-center text-xs font-bold text-slate-500 uppercase tracking-widest">--- ÁπºÁ∫åË°åÁ®ã / ËΩâÈ†Å ---</td>
                                                    </tr>
                                                );
                                            }
                                            const isMaxOn = includeAnalysis && analysisData && analysisData.maxOnStops.some(s => s.stopName === record.stopName) && analysisData.maxOnVal === record.on && record.on > 0;
                                            const isMaxOcc = includeAnalysis && analysisData && analysisData.formattedSegments.some(seg => seg.startsWith(cleanStopName(record.stopName))) && analysisData.maxOccVal === record.occupancy && record.occupancy > 0;
                                            
                                            let rowClass = "hover:bg-gray-50 group";
                                            if (isMaxOn || isMaxOcc) rowClass += " bg-purple-50/30";

                                            return (
                                            <tr key={idx} className={rowClass}>
                                                <td className="p-2 text-left font-mono text-blue-600 font-medium text-xs whitespace-nowrap">{record.arrivalTime !== '-' ? record.arrivalTime : '--:--'}</td>
                                                <td className="p-2">
                                                    <div className="font-medium text-gray-800 text-xs min-w-[80px]">{cleanStopName(record.stopName)}</div>
                                                    {(isMaxOn || isMaxOcc) && (
                                                        <div className="flex gap-1 mt-0.5">
                                                            {isMaxOn && <span className="text-[9px] bg-green-100 text-green-700 px-1 rounded">Max‰∏ä</span>}
                                                            {isMaxOcc && <span className="text-[9px] bg-purple-100 text-purple-700 px-1 rounded">MaxËºâ</span>}
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="p-2 text-center font-bold text-green-600 text-xs">+{record.on}</td>
                                                <td className="p-2 text-center font-bold text-red-500 text-xs">-{record.off}</td>
                                                <td className="p-2 text-right font-bold text-gray-900 text-xs"><span className={record.occupancy < 0 ? 'text-red-500' : ''}>{record.occupancy < 0 ? `(${record.occupancy})` : record.occupancy}</span></td>
                                                {includeNotesInReport && <td className="p-2 text-xs text-gray-500 italic max-w-[100px] truncate">{record.note}</td>}
                                                <td className="p-2 text-right"><button onClick={() => openHistoryEdit(idx)} className="text-gray-300 hover:text-blue-600 p-1"><Edit3 className="w-4 h-4" /></button></td>
                                            </tr>
                                        )})}
                                        {history.length === 0 && <tr><td colSpan={includeNotesInReport ? 7 : 6} className="p-8 text-center text-gray-400 text-xs">Êö´ÁÑ°Ë®òÈåÑ</td></tr>}
                                    </tbody>
                                </table>
                                </div>
                                {showTotalPatronage && (
                                    <div className="p-4 bg-slate-50 border-t flex justify-between items-center">
                                        <span className="text-sm font-bold text-slate-500">Á∏ΩÂÆ¢Èáè (Total Patronage)</span>
                                        <span className="text-2xl font-bold text-slate-800">{totalPatronage}</span>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Â∫ïÈÉ®ÊåâÈàïÂçÄÂüü */}
                        <div className="p-4 bg-white border-t pb-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] space-y-3">
                            <div className="grid grid-cols-2 gap-3">
                                <button 
                                    onClick={copyReport} 
                                    className={`w-full py-4 rounded-xl text-lg font-bold flex items-center justify-center gap-2 transition-all shadow-md active:scale-[0.98] ${copied ? 'bg-green-600 text-white' : 'bg-blue-600 text-white'}`}
                                >
                                    {copied ? <><Check className="w-5 h-5"/> Â∑≤Ë§áË£Ω</> : <><Copy className="w-5 h-5"/> Ë§áË£ΩÂ†±Âëä</>}
                                </button>
                                <button 
                                    onClick={exportToExcel} 
                                    className="w-full py-4 rounded-xl text-lg font-bold flex items-center justify-center gap-2 transition-all shadow-md active:scale-[0.98] bg-emerald-600 text-white hover:bg-emerald-700"
                                >
                                    <FileSpreadsheet className="w-5 h-5"/> ÂåØÂá∫ Excel
                                </button>
                            </div>
                            
                            <button 
                                onClick={handleFinishAndReset} 
                                className="w-full py-4 rounded-xl text-lg font-bold flex items-center justify-center gap-2 bg-slate-800 text-white shadow-md active:scale-[0.98] border border-slate-700"
                            >
                                <CheckCircle2 className="w-5 h-5 text-green-400" /> Ë§áË£Ω‰∏¶ÈáçÁΩÆ
                            </button>
                        </div>
                    </div>
                );
            }

            // ... (Negative Correction Modal)
            if (showNegativeCorrection) {
                return (
                    <div className="absolute inset-0 z-[60] bg-black/70 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                        <div className="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
                            <div className="flex flex-col items-center text-center mb-6">
                                <div className="w-14 h-14 bg-yellow-100 rounded-full flex items-center justify-center mb-3">
                                    <AlertTriangle className="w-7 h-7 text-yellow-600" />
                                </div>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">ÂÅµÊ∏¨Âà∞Êï∏ÊìöÈÄèÊîØ (Ë≤†Êï∏)</h3>
                                <p className="text-sm text-slate-600">Ë°åÁ®ã‰∏≠Ëªä‰∏ä‰∫∫Êï∏ÊúÄ‰ΩéÈªûÁÇ∫ **{negativeDeficit}** ‰∫∫ (Ë≤†Êï∏)„ÄÇ</p>
                                <p className="text-sm text-slate-600 mt-2">Âª∫Ë≠∞Â∞á **{Math.abs(negativeDeficit)}** ‰∫∫Âä†ÂÖ•Âà∞ **ÂàùÂßã‰∫∫Êï∏** ‰∏≠ ({initialPassengers} ‚Üí {initialPassengers + Math.abs(negativeDeficit)})„ÄÇ</p>
                            </div>
                            <div className="space-y-3">
                                <button onClick={handleCorrection} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-md flex items-center justify-center gap-2"><Check className="w-5 h-5"/> Á¢∫Ë™ç‰øÆÊ≠£‰∏¶Áî¢ÁîüÂ†±Âëä</button>
                                <button onClick={() => { setShowNegativeCorrection(false); setShowReport(true); }} className="w-full py-3 bg-gray-100 rounded-xl font-bold text-gray-600 hover:bg-gray-200 flex items-center justify-center gap-2"><X className="w-5 h-5"/> ‰∏ç‰øÆÊ≠£</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- NOTE INPUT MODAL ---
            const renderNoteInputModal = () => {
                if (!showNoteInput) return null;
                return (
                    <div className="absolute inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                        <div className="bg-white rounded-xl p-6 w-full max-w-xs shadow-2xl">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    <MessageSquare className="w-5 h-5 text-yellow-500" /> Á´ôÈªûÂÇôË®ª
                                </h3>
                                <button onClick={() => setShowNoteInput(false)} className="text-gray-400 hover:text-gray-600"><X className="w-5 h-5"/></button>
                            </div>
                            <div className="mb-4">
                                <p className="text-xs text-gray-500 mb-2">Ë´ãËº∏ÂÖ•Áï∂ÂâçÁ´ôÈªûÁöÑÂÇôË®ª (‰æãÂ¶Ç: ÂÆ¢Êªø, È£õÁ´ô)</p>
                                <textarea 
                                    className="w-full border-2 border-slate-200 rounded-xl p-3 text-lg text-slate-800 outline-none focus:border-yellow-400 h-24 resize-none bg-yellow-50"
                                    placeholder="Âú®Ê≠§Ëº∏ÂÖ•ÂÇôË®ª..."
                                    value={currentNote}
                                    onChange={(e) => setCurrentNote(e.target.value)}
                                    autoFocus
                                ></textarea>
                            </div>
                            <button onClick={() => setShowNoteInput(false)} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-md">ÂÑ≤Â≠ò‰∏¶ÈóúÈñâ</button>
                        </div>
                    </div>
                );
            }

            // Main Render
            return (
                <div className="flex flex-col h-screen bg-slate-100 font-sans text-gray-900 overflow-hidden relative">
                    {/* Render Modals */}
                    {renderNoteInputModal()}
                    
                    {/* Reset Confirm */}
                    {showResetConfirm && (
                        <div className="absolute inset-0 z-[60] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white rounded-xl p-6 w-full max-w-xs shadow-2xl">
                                <div className="flex flex-col items-center text-center mb-4">
                                    <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-3"><AlertTriangle className="w-6 h-6 text-red-600" /></div>
                                    <h3 className="text-lg font-bold text-slate-800">Á¢∫Ë™çÈáçÊñ∞ÈñãÂßã?</h3>
                                </div>
                                <div className="text-sm text-gray-500 mb-4 text-center">ÈÄôÂ∞áÊúÉÊ∏ÖÈô§Áï∂ÂâçÈÄ≤Â∫¶ (Session) ‰∏¶ËøîÂõûÂàùÂßãÁãÄÊÖã„ÄÇ</div>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setShowResetConfirm(false)} className="py-3 bg-gray-100 rounded-xl font-bold text-gray-600">ÂèñÊ∂à</button>
                                    <button onClick={performHardReset} className="py-3 bg-red-600 text-white rounded-xl font-bold">Á¢∫Ë™çÈáçÁΩÆ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {showTripSettings && (
                        <div className="absolute inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white rounded-xl p-5 w-full max-w-sm shadow-2xl">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold flex items-center gap-2 text-slate-800"><BusFront className="w-5 h-5" /> Ë°åÁ®ãË≥áÊñôË®≠ÂÆö</h3>
                                    <button onClick={() => setShowTripSettings(false)} className="text-sm text-blue-600 font-bold">ÈóúÈñâ</button>
                                </div>
                                <div className="space-y-4 mb-6">
                                    <div><label className="text-xs font-bold text-gray-500 uppercase mb-1 block">ËªäÁâå/ËªäÈöäÁ∑®Ëôü</label><input type="text" className="w-full bg-slate-50 border border-slate-300 rounded-lg py-2 pl-3" value={tripInfo.plate} onChange={(e) => setTripInfo({...tripInfo, plate: e.target.value.toUpperCase()})} /></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-xs font-bold text-gray-500 uppercase mb-1 block">ËªäÈï∑Á∑®Ëôü</label><input type="text" className="w-full bg-slate-50 border border-slate-300 rounded-lg py-2 pl-3" value={tripInfo.captainId} onChange={(e) => setTripInfo({...tripInfo, captainId: e.target.value})} /></div>
                                        <div><label className="text-xs font-bold text-gray-500 uppercase mb-1 block">ËªäÈï∑ÂßìÊ∞è</label><input type="text" className="w-full bg-slate-50 border border-slate-300 rounded-lg py-2 pl-3" value={tripInfo.captainName} onChange={(e) => setTripInfo({...tripInfo, captainName: e.target.value})} /></div>
                                    </div>
                                </div>
                                <button onClick={() => setShowTripSettings(false)} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">Á¢∫Ë™ç‰∏¶ÂÑ≤Â≠ò</button>
                            </div>
                        </div>
                    )}

                    {/* Manual Input Modal */}
                    {editingValue && (
                        <div className="absolute inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white rounded-xl p-6 w-full max-w-xs shadow-2xl">
                                {editingValue === 'initial' ? (
                                    <div className="mb-4">
                                        <div className="flex bg-gray-100 p-1 rounded-lg mb-4">
                                            <button 
                                                onClick={() => { setManualInputMode('direct_base'); setManualInputValue(initialPassengers.toString()); }}
                                                className={`flex-1 py-2 text-xs font-bold rounded-md transition-all ${manualInputMode === 'direct_base' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}
                                            >
                                                ‰øÆÊîπÂàùÂßãÂÄº
                                            </button>
                                            <button 
                                                onClick={() => { setManualInputMode('calibrate_current'); setManualInputValue(totalPassengers.toString()); }}
                                                className={`flex-1 py-2 text-xs font-bold rounded-md transition-all ${manualInputMode === 'calibrate_current' ? 'bg-white shadow text-purple-600' : 'text-gray-500'}`}
                                            >
                                                Ê†°Ê∫ñÁï∂Ââç‰∫∫Êï∏
                                            </button>
                                        </div>
                                        <h3 className="text-lg font-bold text-center text-slate-700">
                                            {manualInputMode === 'direct_base' ? 'Ë®≠ÂÆöÂàùÂßã‰∫∫Êï∏ (Base)' : 'Ëº∏ÂÖ•Áï∂ÂâçÂØ¶Èöõ‰∫∫Êï∏'}
                                        </h3>
                                    </div>
                                ) : (
                                    <h3 className="text-lg font-bold mb-4 text-center text-slate-700">
                                        {editingValue === 'on' ? '‰øÆÊ≠£‰∏äËªä‰∫∫Êï∏' : '‰øÆÊ≠£ËêΩËªä‰∫∫Êï∏'}
                                    </h3>
                                )}
                                
                                <input type="number" pattern="\d*" inputMode="numeric" value={manualInputValue} onChange={(e) => setManualInputValue(e.target.value)} className={`w-full text-center text-5xl font-bold border-b-4 focus:outline-none mb-8 py-2 bg-transparent text-slate-800 ${manualInputMode === 'calibrate_current' && editingValue === 'initial' ? 'border-purple-500 text-purple-700' : 'border-blue-500'}`} autoFocus />
                                
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setEditingValue(null)} className="py-3 bg-gray-100 rounded-xl font-bold text-gray-600">ÂèñÊ∂à</button>
                                    <button onClick={saveManualInput} className={`py-3 text-white rounded-xl font-bold ${manualInputMode === 'calibrate_current' && editingValue === 'initial' ? 'bg-purple-600' : 'bg-blue-600'}`}>Á¢∫Ë™ç</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Stop Selector */}
                    {showStopSelector && (
                        <div className="absolute inset-0 z-50 bg-white flex flex-col animate-in slide-in-from-bottom-10">
                            <div className="p-4 border-b bg-slate-50 flex justify-between items-center shadow-sm z-10">
                                <h3 className="font-bold text-lg flex items-center gap-2"><MapPin className="w-5 h-5 text-blue-600"/> ÈÅ∏ÊìáÁ´ôÈªû</h3>
                                <button onClick={() => setShowStopSelector(false)} className="text-blue-600 font-bold px-2 py-1 rounded">ÈóúÈñâ</button>
                            </div>
                            <div className="flex-1 overflow-y-auto bg-gray-50">
                                {routeStops.length > 0 ? (
                                    routeStops.map((stop, idx) => (
                                        <button key={idx} onClick={() => jumpToStop(idx)} className={`w-full text-left p-4 border-b flex items-center gap-3 bg-white hover:bg-blue-50 ${idx === currentStopIndex ? 'bg-blue-50 border-l-4 border-blue-600' : ''}`}>
                                            <span className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${idx === currentStopIndex ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-600'}`}>{idx + 1}</span>
                                            <span className={`font-bold text-lg ${idx === currentStopIndex ? 'text-blue-700' : 'text-gray-800'}`}>{stop.name}</span>
                                        </button>
                                    ))
                                ) : (
                                    <div className="p-10 text-center text-gray-400 flex flex-col items-center gap-2"><Search className="w-10 h-10 opacity-20" /><span>Ë´ãÂÖàÊêúÂ∞ã‰∏¶ÈÅ∏ÊìáË∑ØÁ∑ö</span></div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <header className="bg-slate-800 text-white p-3 shadow-md flex-none z-20">
                        <div className="flex justify-between items-start mb-3 gap-2">
                            <div className="flex-1 flex gap-2">
                                <button onClick={toggleCompany} className={`px-2 rounded font-bold text-xs flex items-center justify-center min-w-[50px] border shadow-sm active:scale-95 ${getCompanyColor(company)}`}>{company === 'KMB' ? '‰πùÂ∑¥' : company === 'CTB' ? 'ÂüéÂ∑¥' : 'Â∂ºÂ∑¥'}</button>
                                <div className="relative flex-1">
                                    <input type="text" placeholder="Ë∑ØÁ∑ö (Â¶Ç 1A)" value={routeNumber} onChange={(e) => setRouteNumber(e.target.value)} className="bg-slate-700 text-white pl-3 pr-2 py-2 rounded w-full text-sm border border-slate-600 focus:outline-none focus:border-blue-400 uppercase font-bold" />
                                </div>
                                <button onClick={searchRoute} disabled={isLoading || !routeNumber} className="bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white px-3 rounded flex items-center justify-center shadow-md active:scale-95">{isLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <Search className="w-5 h-5" />}</button>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowStats(true)} className="p-2 bg-slate-700 hover:bg-slate-600 text-slate-200 hover:text-purple-300 rounded-lg border border-slate-600"><BarChart3 className="w-5 h-5" /></button>
                                <button onClick={() => setShowTripSettings(true)} className="p-2 bg-slate-700 hover:bg-slate-600 text-slate-200 hover:text-white rounded-lg border border-slate-600"><BusFront className="w-5 h-5" /></button>
                                <button onClick={openResetConfirm} className="p-2 text-slate-400 hover:text-white bg-slate-700/50 rounded-full"><RotateCcw className="w-5 h-5" /></button>
                                <button onClick={handleShowReport} className="bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1 shadow-md active:scale-95"><FileText className="w-5 h-5" /></button>
                            </div>
                        </div>
                        
                        {/* Variant Selector */}
                        {showVariantSelector && (
                            <div className="absolute top-16 left-2 right-2 bg-white rounded-xl shadow-2xl border border-slate-200 p-0 z-50 max-h-[60vh] overflow-y-auto">
                                <div className="px-4 py-3 bg-slate-50 border-b text-xs font-bold text-slate-500 flex justify-between items-center sticky top-0"><span>Ë´ãÈÅ∏ÊìáË∑ØÁ∑öÊñπÂêë:</span><button onClick={() => setShowVariantSelector(false)} className="text-blue-600">ÈóúÈñâ</button></div>
                                {variants.map((v, idx) => (
                                    <button key={idx} onClick={() => selectVariant(v)} className="w-full text-left p-4 border-b last:border-0 hover:bg-blue-50 active:bg-blue-100 transition-colors">
                                        <div className="flex items-center gap-3">
                                            <span className={`text-xs px-2 py-1 rounded font-bold shadow-sm ${getCompanyColor(v.company).replace(/border-\w+/, '').replace(/text-\w+/, '')}`.trim()}>{v.route}</span>
                                            <div className="flex-1"><div className="text-sm font-bold text-slate-800">{v.description}</div><div className="text-xs text-slate-500 mt-0.5">{v.subDescription}</div></div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        )}

                        <div className="bg-slate-700 rounded-xl p-3 flex justify-between items-center border border-slate-600 relative overflow-hidden shadow-inner">
                            <div className="flex-1 min-w-0 pr-2 cursor-pointer active:opacity-80" onClick={() => setShowStopSelector(true)}>
                                <div className="text-slate-400 text-[10px] mb-0.5 uppercase font-bold flex items-center gap-1">Current Stop <List className="w-3 h-3" /></div>
                                <div className="flex items-center gap-2">
                                    <div className={`min-w-[1.8rem] h-7 rounded flex items-center justify-center font-bold text-sm shadow-sm px-1 ${getCompanyColor(company).replace(/border-\w+/, '').replace(/text-\w+/, '')}`.trim()}>{currentStopIndex + 1}</div>
                                    <span className="text-white font-bold text-lg truncate leading-tight">{getCurrentStopDisplay()}</span>
                                </div>
                            </div>
                            
                            {/* Note Button */}
                            <div className="px-2 border-r border-slate-600 mr-2">
                                <button 
                                    onClick={() => setShowNoteInput(true)} 
                                    className={`p-2 rounded-lg transition-all active:scale-95 border ${currentNote ? 'bg-yellow-500 text-slate-900 border-yellow-400' : 'bg-slate-600 text-slate-300 border-slate-500 hover:text-white'}`}
                                >
                                    <MessageSquare className="w-5 h-5" />
                                </button>
                            </div>

                            <div className="text-right cursor-pointer active:opacity-80" onClick={() => openManualInput('initial')}>
                                <div className="text-[10px] text-slate-400 mb-0.5 flex items-center justify-end gap-1 uppercase font-bold">On Board <Edit3 className="w-3 h-3" /></div>
                                <div className={`text-3xl font-mono font-bold leading-none ${totalPassengers < 0 ? 'text-red-400' : 'text-white'}`}>{totalPassengers}</div>
                            </div>
                        </div>
                    </header>

                    <div className="bg-white border-b px-4 py-2 flex items-center justify-between shadow-sm z-10">
                        <div className="flex items-center gap-2 text-slate-700"><Clock className="w-5 h-5 text-blue-600" /><span className="text-sm font-bold">Âà∞Á´ôÊôÇÈñì:</span><input type="time" value={arrivalTime} onChange={(e) => setArrivalTime(e.target.value)} className="bg-slate-100 rounded px-2 py-1 text-xl font-mono font-bold text-slate-900 border-b-2 border-transparent focus:border-blue-500 outline-none w-28 text-center" /></div>
                        <button onClick={setArrivalNow} className="bg-blue-100 text-blue-700 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-blue-200 active:scale-95 shadow-sm">ÁèæÂú®</button>
                    </div>

                    <main className="flex-1 flex flex-col p-3 gap-3 overflow-hidden relative bg-slate-100">
                        <div className="flex-1 grid grid-cols-2 gap-3 min-h-0">
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden relative group">
                                <div className="bg-green-50 py-2 text-center border-b border-green-100 px-2"><span className="text-green-700 text-sm font-extrabold uppercase tracking-wide">‰∏äËªä Boarding</span></div>
                                <div className="flex-1 flex flex-col items-center justify-center relative">
                                    <button onClick={incrementOn} className="w-full h-full absolute inset-0 active:bg-green-100 transition-colors"></button>
                                    <button onClick={() => openManualInput('on')} className="relative z-10 mb-2"><span className="text-5xl font-bold text-slate-800 font-mono tracking-tighter">{stopOn}</span></button>
                                    <div className="relative z-10 pointer-events-none mb-2"><div className="w-14 h-14 rounded-full bg-green-100 flex items-center justify-center border-2 border-green-200 shadow-sm"><Plus className="w-7 h-7 text-green-600" /></div></div>
                                </div>
                                <button onClick={decrementOn} disabled={stopOn === 0} className="absolute bottom-3 left-3 w-10 h-10 rounded-full bg-slate-100 text-slate-400 border border-slate-200 hover:bg-red-50 hover:text-red-500 flex items-center justify-center z-10 active:scale-90 transition-all disabled:opacity-30"><Minus className="w-5 h-5" /></button>
                            </div>

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden relative group">
                                <div className="bg-red-50 py-2 text-center border-b border-red-100"><span className="text-red-700 text-sm font-extrabold uppercase tracking-wide">ËêΩËªä Alighting</span></div>
                                <div className="flex-1 flex flex-col items-center justify-center relative">
                                    <button onClick={incrementOff} className="w-full h-full absolute inset-0 active:bg-red-100 transition-colors"></button>
                                    <button onClick={() => openManualInput('off')} className="relative z-10 mb-2"><span className="text-5xl font-bold text-slate-800 font-mono tracking-tighter">{stopOff}</span></button>
                                    <div className="relative z-10 pointer-events-none mb-2"><div className="w-14 h-14 rounded-full bg-red-100 flex items-center justify-center border-2 border-red-200 shadow-sm"><Minus className="w-7 h-7 text-red-600" /></div></div>
                                </div>
                                <button onClick={decrementOff} disabled={stopOff === 0} className="absolute bottom-3 right-3 w-10 h-10 rounded-full bg-slate-100 text-slate-400 border border-slate-200 hover:bg-green-50 hover:text-green-500 flex items-center justify-center z-10 active:scale-90 transition-all disabled:opacity-30"><Minus className="w-5 h-5" /></button>
                            </div>
                        </div>

                        {/* Navigation Actions */}
                        <div className="flex-none pt-1 pb-1">
                            {isLastStop ? (
                                <div className="flex flex-col gap-2">
                                    <div className="flex gap-2 h-14">
                                        <button onClick={handlePrevStop} disabled={currentStopIndex === 0} className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-600 rounded-xl shadow flex flex-col items-center justify-center disabled:opacity-50">
                                            <div className="text-[9px] font-bold uppercase tracking-wider mb-0.5 text-slate-400">Previous</div>
                                            <div className="text-base font-bold flex items-center gap-1"><ChevronLeft className="w-4 h-4" /> {getPrevStopDisplay().replace('‰∏ä‰∏ÄÁ´ô: ', '')}</div>
                                        </button>
                                        <button onClick={handleContinueTrip} className="flex-1 bg-amber-500 hover:bg-amber-600 text-white rounded-xl shadow-lg flex flex-col items-center justify-center px-4 active:scale-[0.98] transition-all group border border-amber-600">
                                            <div className="text-[9px] font-bold uppercase tracking-wider mb-0.5 text-amber-100">ËΩâÈ†Å/Loop</div>
                                            <div className="text-base font-bold flex items-center gap-1"><GitMerge className="w-4 h-4" /> ÁπºÁ∫åË°åÁ®ãÂèäÂêà‰Ωµ</div>
                                        </button>
                                    </div>
                                    <button onClick={handleCompleteAndShowReport} className="w-full h-14 bg-slate-800 hover:bg-slate-700 text-white rounded-xl shadow-lg flex flex-col items-center justify-center px-4 active:scale-[0.98] transition-all group border border-slate-700">
                                        <div className="text-[9px] font-bold uppercase tracking-wider mb-0.5 text-slate-400">End Trip</div>
                                        <div className="text-xl font-bold flex items-center gap-2">ÂÆåÊàê‰∏¶ÁµêÊùü <ChevronRight className="w-5 h-5" /></div>
                                    </button>
                                </div>
                            ) : (
                                <div className="flex flex-col gap-2">
                                    <div className="flex gap-2 h-14">
                                        <button onClick={handlePrevStop} disabled={currentStopIndex === 0} className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-600 rounded-xl shadow flex flex-col items-center justify-center disabled:opacity-50">
                                            <div className="text-[9px] font-bold uppercase tracking-wider mb-0.5 text-slate-400">Previous</div>
                                            <div className="text-base font-bold flex items-center gap-1"><ChevronLeft className="w-4 h-4" /> {getPrevStopDisplay().replace('‰∏ä‰∏ÄÁ´ô: ', '')}</div>
                                        </button>
                                        
                                        <button onClick={handleCompleteAndShowReport} className="w-24 bg-slate-100 hover:bg-slate-200 text-slate-500 rounded-xl shadow flex flex-col items-center justify-center active:scale-[0.98] transition-all border border-slate-200">
                                            <div className="text-[9px] font-bold uppercase tracking-wider mb-0.5">End Early</div>
                                            <div className="text-xs font-bold flex items-center gap-1"><StopCircle className="w-4 h-4" /> ÊèêÊó©ÁµêÊùü</div>
                                        </button>
                                    </div>
                                    
                                    <button onClick={handleNextStop} disabled={routeStops.length > 0 && currentStopIndex > routeStops.length} className="w-full h-14 bg-slate-800 disabled:bg-slate-600 text-white rounded-xl shadow-lg flex flex-col items-center justify-center px-4 active:scale-[0.98] transition-all group border border-slate-700">
                                        <div className="text-[9px] font-bold uppercase tracking-wider mb-0.5 text-slate-400">Next Action</div>
                                        <div className="text-xl font-bold text-yellow-400 flex items-center gap-1">
                                            {getNextStopDisplay() === '‰∏ã‰∏ÄÁ´ô' ? 
                                                (routeStops.length > 0 && currentStopIndex < routeStops.length - 1 ? routeStops[currentStopIndex + 1].name : '‰∏ã‰∏ÄÁ´ô') 
                                                : getNextStopDisplay()} 
                                            <ChevronRight className="w-5 h-5" />
                                        </div>
                                    </button>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>